<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Server Installation and Configuration Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Top menu */

@media only screen and (min-width: 768px) {
       div.top-menu-guides {
              position: fixed;
              display: inline-block;
              top: 0;
              left: 0;
              z-index: 9999;
       }

       div.top-menu-guides p {
              margin: 0;
              padding: 0;
       }

       div.top-menu-guides .content {
              margin: 0;
              padding: 7px 20px 0 20px;
              background-color: #ededed;
              height: 48px;
              width: 20em;
       }

       @media only screen and (max-width: 1280px) {
              div.top-menu-guides .content {
                     width: 15em;
              }
       }

       div.top-menu-guides .ulist {
              display: none;
              position: absolute;
              background-color: #f9f9f9;
              min-width: 160px;
              box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
              padding: 0px;
              margin-top: 12px;
       }

       div.top-menu-guides .ulist ul {
              list-style: none;
              padding: 5px;
              margin: 0;
       }

       div.top-menu-guides .ulist li {
              padding: 5px 10px;
       }

       div.top-menu-guides:hover .ulist {
           display: block;
       }

       div.top-menu-version {
           position: fixed;
           top: 0;
           z-index: 9999;
       }

       div.top-menu-version .content {
           padding: 0;
           margin: 0;
           background-color: #eee;
           height: 48px;
           padding: 7px;
       }

       .versionarchive {
           display: inline-block;
       }

       .versionarchive p {
           margin: 0;
           padding: 2px 5px 2px 10px;
       }

       .versionarchive a {
           background-color: #ffdd57;
           padding: 0 5px;
           font-style: normal;
           border-radius: 5px;
           margin-left: 10px;
       }

       .versionlatest {
           display: inline-block;
       }

       .versionlatest p {
           background-color: #eee;
           border-radius: 5px;
           margin: 0;
           padding: 2px 5px 2px 10px;
       }

       .versionlatest em {
           background-color: #23d160;
           padding: 0 5px;
           font-style: normal;
           border-radius: 5px;
           margin-left: 10px;
       }
}

/* TOC */

#tocbot a.toc-link.node-name--H1{ font-style: italic }
@media screen{
#tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
#tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
  padding-left: 0 }
#tocbot a.toc-link{ height:100% }
.is-collapsible{ max-height:3000px; overflow:hidden; }
.is-collapsed{ max-height:0 }
.is-active-link{ font-weight:700 }
}
@media print{
#tocbot a.toc-link.node-name--H4{ display:none }
}

/* Fix scroll to anchor hides title */
h1::before, h2::before, h3::before, h4::before, h5::before, h6::before {
    display: block;
    content: " ";
    height: 70px;
    margin-top: -70px;
}

h1 {
    border-bottom: none !important
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}


/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

.sect1+.sect1 {
    border-top: none;
}

.page-links {
    border-bottom: 1px solid #efefed;
    border-top: none;
    background: none;
    position: relative;
    left: 0em;
    width: 100%;
    top: -5em;
    height: 0;
    margin: 0;
    padding: 0;
}

.sect2 .page-links {
    top: -3.5em;
}

.page-links .content {
    background: #f8f8f7;
    border: 1px solid #e0e0dc;
    float: right;
    font-size: 0.8em;
    margin: 0;
    padding: 5px;
}

.page-links a {
    display: block;
    padding: 5px;
}
</style>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Server Installation and Configuration Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#guide-overview">Guide Overview</a>
<ul class="sectlevel2">
<li><a href="#recommended-additional-external-documentation">Recommended additional external documentation</a></li>
</ul>
</li>
<li><a href="#installing-the-software">Installing the software</a>
<ul class="sectlevel2">
<li><a href="#installation-prerequisites">Installation prerequisites</a></li>
<li><a href="#installing-the-keycloak-server">Installing the Keycloak server</a></li>
<li><a href="#important-directories">Important directories</a></li>
</ul>
</li>
<li><a href="#_operating-mode">Using operating modes</a>
<ul class="sectlevel2">
<li><a href="#_standalone-mode">Using standalone mode</a>
<ul class="sectlevel3">
<li><a href="#booting-in-standalone-mode">Booting in standalone mode</a></li>
<li><a href="#standalone-configuration">Standalone configuration</a></li>
</ul>
</li>
<li><a href="#_standalone-ha-mode">Using standalone clustered mode</a>
<ul class="sectlevel3">
<li><a href="#standalone-clustered-configuration">Standalone clustered configuration</a></li>
<li><a href="#booting-in-standalone-clustered-mode">Booting in standalone clustered mode</a></li>
</ul>
</li>
<li><a href="#_domain-mode">Using domain clustered mode</a>
<ul class="sectlevel3">
<li><a href="#domain-configuration">Domain configuration</a></li>
<li><a href="#host-controller-configuration">Host controller configuration</a></li>
<li><a href="#server-instance-working-directories">Server instance working directories</a></li>
<li><a href="#booting-in-domain-clustered-mode">Booting in domain clustered mode</a></li>
<li><a href="#_clustered-domain-example">Testing with a sample clustered domain</a></li>
</ul>
</li>
<li><a href="#crossdc-mode">Using cross-site replication mode</a>
<ul class="sectlevel3">
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#technicaldetails">Technical details</a></li>
<li><a href="#requestprocessing">Request processing</a></li>
<li><a href="#modes">Modes</a></li>
<li><a href="#database">Database</a></li>
<li><a href="#cache">Infinispan caches</a></li>
<li><a href="#communication">Communication details</a></li>
<li><a href="#assembly-setting-up-crossdc">Setting up cross-site with Infinispan 11.0.8</a></li>
<li><a href="#setup">Setting up cross-site replication with Infinispan 9.4.19</a></li>
<li><a href="#administration">Administration of cross-site deployment</a></li>
<li><a href="#onoffline">Bringing sites offline and online</a></li>
<li><a href="#statetransfer">State transfer</a></li>
<li><a href="#clearcache">Clear caches</a></li>
<li><a href="#tuningcache">Tuning the Infinispan cache configuration</a></li>
<li><a href="#backups">SYNC or ASYNC backups</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#managing-the-subsystem-configuration">Managing the subsystem configuration</a>
<ul class="sectlevel2">
<li><a href="#_config_spi_providers">Configure SPI providers</a></li>
<li><a href="#_start_cli">Starting the WildFly CLI</a></li>
<li><a href="#cli-embedded-mode">CLI embedded mode</a></li>
<li><a href="#using-cli-gui-mode">Using CLI GUI mode</a></li>
<li><a href="#cli-scripting">CLI scripting</a></li>
<li><a href="#_cli_recipes">CLI recipes</a>
<ul class="sectlevel3">
<li><a href="#changing-the-web-context-of-the-server">Changing the web context of the server</a></li>
<li><a href="#setting-the-global-default-theme">Setting the global default theme</a></li>
<li><a href="#adding-a-new-spi-and-a-provider">Adding a new SPI and a provider</a></li>
<li><a href="#disabling-a-provider">Disabling a provider</a></li>
<li><a href="#changing-the-default-provider-for-an-spi">Changing the default provider for an SPI</a></li>
<li><a href="#configuring-the-dblock-spi">Configuring the dblock SPI</a></li>
<li><a href="#adding-or-changing-a-single-property-value-for-a-provider">Adding or changing a single property value for a provider</a></li>
<li><a href="#remove-a-single-property-from-a-provider">Remove a single property from a provider</a></li>
<li><a href="#setting-values-on-a-provider-property-of-type-code-list-code">Setting values on a provider property of type <code>List</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#profiles">Profiles</a></li>
<li><a href="#_database">Setting up the relational database</a>
<ul class="sectlevel2">
<li><a href="#_rdbms-setup-checklist">Database setup checklist</a></li>
<li><a href="#packaging-the-jdbc-driver">Packaging the JDBC driver</a></li>
<li><a href="#declaring-and-loading-the-jdbc-driver">Declaring and loading the JDBC driver</a></li>
<li><a href="#modifying-the-keycloak-datasource">Modifying the Keycloak datasource</a></li>
<li><a href="#database-configuration">Database Configuration</a></li>
<li><a href="#unicode-considerations-for-databases">Unicode considerations for databases</a>
<ul class="sectlevel3">
<li><a href="#oracle-database">Oracle database</a></li>
<li><a href="#microsoft-sql-server-database">Microsoft SQL Server database</a></li>
<li><a href="#mysql-database">MySQL database</a></li>
<li><a href="#postgresql-database">PostgreSQL database</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_hostname">Use of the public hostname</a>
<ul class="sectlevel2">
<li><a href="#default-provider">Default provider</a></li>
<li><a href="#custom-provider">Custom provider</a></li>
</ul>
</li>
<li><a href="#_network">Setting up the network</a>
<ul class="sectlevel2">
<li><a href="#_bind-address">Bind addresses</a></li>
<li><a href="#_ports">Socket port bindings</a></li>
<li><a href="#_setting_up_ssl">Setting up HTTPS/SSL</a>
<ul class="sectlevel3">
<li><a href="#enabling-ssl-https-for-the-keycloak-server">Enabling SSL/HTTPS for the Keycloak server</a></li>
</ul>
</li>
<li><a href="#outgoing-http-requests">Outgoing HTTP requests</a>
<ul class="sectlevel3">
<li><a href="#_proxymappings">Proxy mappings for outgoing HTTP requests</a></li>
<li><a href="#_proxy_env_vars">Using standard environment variables</a></li>
<li><a href="#_truststore">Outgoing HTTPS request truststore</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_clustering">Configuring Keycloak to run in a cluster</a>
<ul class="sectlevel2">
<li><a href="#recommended-network-architecture">Recommended network architecture</a></li>
<li><a href="#clustering-example">Clustering example</a></li>
<li><a href="#_setting-up-a-load-balancer-or-proxy">Setting Up a load balancer or proxy</a>
<ul class="sectlevel3">
<li><a href="#identifying-client-ip-addresses">Identifying client IP addresses</a></li>
<li><a href="#enabling-https-ssl-with-a-reverse-proxy">Enabling HTTPS/SSL with a reverse proxy</a></li>
<li><a href="#verifying-the-configuration">Verifying the configuration</a></li>
<li><a href="#using-the-built-in-load-balancer">Using the built-in load balancer</a></li>
</ul>
</li>
<li><a href="#sticky-sessions">Sticky sessions</a>
<ul class="sectlevel3">
<li><a href="#disable-adding-the-route">Disable adding the route</a></li>
</ul>
</li>
<li><a href="#setting-up-multicast-networking">Setting up multicast networking</a></li>
<li><a href="#secure-cluster-communication">Secure cluster communication</a></li>
<li><a href="#_clustering_db_lock">Serialized cluster startup</a></li>
<li><a href="#booting-the-cluster">Booting the cluster</a></li>
<li><a href="#troubleshooting-2">Troubleshooting</a></li>
</ul>
</li>
<li><a href="#cache-configuration">Server cache configuration</a>
<ul class="sectlevel2">
<li><a href="#_eviction">Eviction and expiration</a></li>
<li><a href="#_replication">Replication and failover</a></li>
<li><a href="#disabling-caching">Disabling caching</a></li>
<li><a href="#clearing-cache-at-runtime">Clearing cache at runtime</a></li>
</ul>
</li>
<li><a href="#_operator">Keycloak Operator</a>
<ul class="sectlevel2">
<li><a href="#_installing-operator">Installing the Keycloak Operator on a cluster</a>
<ul class="sectlevel3">
<li><a href="#_install_by_olm">Installing using the Operator Lifecycle Manager</a></li>
<li><a href="#_install_by_command">Installing from the command line</a></li>
</ul>
</li>
<li><a href="#_operator_production_usage">Using the Keycloak Operator in production environment</a></li>
<li><a href="#_monitoring-operator">The Application Monitoring Operator</a>
<ul class="sectlevel3">
<li><a href="#installing-the-application-monitoring-operator">Installing the Application Monitoring Operator</a></li>
<li><a href="#viewing-operator-metrics">Viewing Operator Metrics</a></li>
</ul>
</li>
<li><a href="#_keycloak_cr">Installing Keycloak using a custom resource</a>
<ul class="sectlevel3">
<li><a href="#the-keycloak-custom-resource">The Keycloak custom resource</a></li>
<li><a href="#creating-a-keycloak-custom-resource-on-openshift">Creating a Keycloak custom resource on OpenShift</a></li>
<li><a href="#creating-a-keycloak-custom-resource-on-kubernetes">Creating a Keycloak custom resource on Kubernetes</a></li>
</ul>
</li>
<li><a href="#_realm-cr">Creating a realm custom resource</a></li>
<li><a href="#_client-cr">Creating a client custom resource</a></li>
<li><a href="#_user-cr">Creating a user custom resource</a></li>
<li><a href="#_external_database">Connecting to an external database</a></li>
<li><a href="#_external_keycloak">Connecting to an external Keycloak</a></li>
<li><a href="#_backup-cr">Scheduling database backups</a>
<ul class="sectlevel3">
<li><a href="#_backups-cr-aws">Backing up to AWS S3 storage</a></li>
<li><a href="#_backups-local-cr">Backing up to Local Storage</a></li>
</ul>
</li>
<li><a href="#_operator-extensions">Installing extensions and themes</a></li>
<li><a href="#_command-options">Command options for managing custom resources</a></li>
<li><a href="#_operator-upgrade-strategy">Upgrade strategy</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock top-menu-guides">
<div class="content">
<div class="paragraph">
<p><strong>Server Installation</strong> <span class="icon"><i class="fa fa-angle-down"></i></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.keycloak.org/guides#getting-started">Getting Started</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/securing_apps/">Securing Apps</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/server_admin/">Server Administration</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/server_development/">Server Developer</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/authorization_services/">Authorization Services</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/upgrading/">Upgrading</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/latest/release_notes/">Release Notes</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock top-menu-version">
<div class="content">
<div class="paragraph versionlatest">
<p>Version <strong>18.0.2</strong> <em>Latest</em></p>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This guide is for the legacy WildFly distribution of Keycloak.</p>
</div>
<div class="paragraph">
<p>For the new Quarkus powered distribution check out the new <a href="https://www.keycloak.org/guides#server">Server Guides</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guide-overview"><a class="anchor" href="#guide-overview"></a>Guide Overview</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/overview.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/overview.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The purpose of this guide is to walk through the steps that need to be completed prior to booting up the
Keycloak server for the first time.  If you just want to test drive Keycloak, it pretty much runs out of the box with its
own embedded and local-only database.  For
 actual deployments that are going to be run in production you&#8217;ll need to decide how you want to manage server configuration
 at runtime (standalone or domain mode), configure a shared database for Keycloak storage, set up encryption and HTTPS,
 and finally set up Keycloak to run in a cluster.  This guide walks through each and every aspect of any pre-boot
 decisions and setup you must do prior to deploying the server.</p>
</div>
<div class="paragraph">
<p>One thing to particularly note is that Keycloak is derived from the WildFly Application Server.
Many aspects of configuring Keycloak revolve around WildFly configuration elements.  Often
this guide will direct you to documentation outside of the manual if you want to dive into more detail.</p>
</div>
<div class="sect2">
<h3 id="recommended-additional-external-documentation"><a class="anchor" href="#recommended-additional-external-documentation"></a>Recommended additional external documentation</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/overview/recommended-reading.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/overview/recommended-reading.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak is built on top of the WildFly application server and its sub-projects like Infinispan (for caching) and Hibernate (for persistence).
This guide only covers basics for infrastructure-level configuration.  It is highly recommended that you peruse the documentation
for WildFly and its sub projects. Here is the link to the documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-software"><a class="anchor" href="#installing-the-software"></a>Installing the software</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/installation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/installation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Installing Keycloak is as simple as downloading it and unzipping it. This chapter reviews system requirements
as well as the directory structure of the distribution.</p>
</div>
<div class="sect2">
<h3 id="installation-prerequisites"><a class="anchor" href="#installation-prerequisites"></a>Installation prerequisites</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/installation/system-requirements.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/installation/system-requirements.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>These prerequisites exist for installing the Keycloak server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can run on any operating system that runs Java</p>
</li>
<li>
<p>Java 8 JRE or Java 11 JRE</p>
</li>
<li>
<p>zip or gzip and tar</p>
</li>
<li>
<p>At least 512M of RAM</p>
</li>
<li>
<p>At least 1G of diskspace</p>
</li>
<li>
<p>A shared external database like PostgreSQL, MySQL, Oracle, etc.  Keycloak requires an external shared
database if you want to run in a cluster.   Please see the <a href="#_database">database configuration</a> section of this guide for more information.</p>
</li>
<li>
<p>Network multicast support on your machine if you want to run in a cluster.  Keycloak can
be clustered without multicast, but this requires a bunch of configuration changes.  Please see
the <a href="#_clustering">clustering</a> section of this guide for more information.</p>
</li>
<li>
<p>On Linux, it is recommended to use <code>/dev/urandom</code> as a source of random data to prevent Keycloak hanging due to lack of available
entropy, unless <code>/dev/random</code> usage is mandated by your security policy. To achieve that on Oracle JDK 8 and OpenJDK 8, set the <code>java.security.egd</code>
system property on startup to <code>file:/dev/urandom</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="installing-the-keycloak-server"><a class="anchor" href="#installing-the-keycloak-server"></a>Installing the Keycloak server</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/installation/distribution-files-community.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/installation/distribution-files-community.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keycloak Server has two downloadable distributions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>keycloak-18.0.2.[zip|tar.gz]</code></p>
<div class="paragraph">
<p>This file is the server only distribution.  It contains nothing other than the scripts and binaries
to run the Keycloak Server.</p>
</div>
</li>
<li>
<p><code>keycloak-overlay-18.0.2.[zip|tar.gz]</code></p>
<div class="paragraph">
<p>This file is a WildFly add-on that you can use to install the Keycloak Server on top of an existing
WildFly distribution.  We do not support users who want to run their applications and Keycloak on the same server instance.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To install the Keycloak server, run your operating system&#8217;s <code>unzip</code> or <code>gunzip</code> and <code>tar</code> utilities on the <code>keycloak-18.0.2.[zip|tar.gz]</code> file.</p>
</li>
<li>
<p>To install the Keycloak Service Pack, it must be installed on a different server instance.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change to the root directory of your WildFly distribution.</p>
</li>
<li>
<p>Unzip the <code>keycloak-overlay-18.0.2.[zip|tar.gz]</code> file.</p>
</li>
<li>
<p>Open the bin directory in a shell.</p>
</li>
<li>
<p>Run <code>./jboss-cli.[sh|bat] --file=keycloak-install.cli</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="important-directories"><a class="anchor" href="#important-directories"></a>Important directories</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/installation/directory-structure.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/installation/directory-structure.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The following are some important directories in the server distribution.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>bin/</em></dt>
<dd>
<p>This contains various scripts to either boot the server or perform some other management action on the server.</p>
</dd>
<dt class="hdlist1"><em>domain/</em></dt>
<dd>
<p>This contains configuration files and working directory when running Keycloak in <a href="#_domain-mode">domain mode</a>.</p>
</dd>
<dt class="hdlist1"><em>modules/</em></dt>
<dd>
<p>These are all the Java libraries used by the server.</p>
</dd>
<dt class="hdlist1"><em>standalone/</em></dt>
<dd>
<p>This contains configuration files and working directory when running Keycloak in <a href="#_standalone-mode">standalone mode</a>.</p>
</dd>
<dt class="hdlist1"><em>standalone/deployments/</em></dt>
<dd>
<p>If you are writing extensions to Keycloak, you can put your extensions here.  See the <a href="https://www.keycloak.org/docs/latest/server_development/">Server Developer Guide</a> for more information on this.</p>
</dd>
<dt class="hdlist1"><em>themes/</em></dt>
<dd>
<p>This directory contains all the html, style sheets, JavaScript files, and images used to display any UI screen displayed by the server.
Here you can modify an existing theme or create your own.  See the <a href="https://www.keycloak.org/docs/latest/server_development/">Server Developer Guide</a> for more information on this.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operating-mode"><a class="anchor" href="#_operating-mode"></a>Using operating modes</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Before deploying Keycloak in a production environment you need to decide which type of operating mode you are going to use.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Will you run Keycloak within a cluster?</p>
</li>
<li>
<p>Do you want a centralized way to manage your server configurations?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Your choice of operating mode affects how you configure databases, configure caching and even how you boot the server.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Keycloak is built on top of the WildFly Application Server.  This guide will only
     go over the basics for deployment within a specific mode.  If you want specific information on this, a better place
     to go would be the <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_standalone-mode"><a class="anchor" href="#_standalone-mode"></a>Using standalone mode</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/standalone.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/standalone.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Standalone operating mode is only useful when you want to run one, and only one Keycloak server instance.
It is not usable for clustered deployments and all caches are non-distributed and local-only.  It is not recommended that
you use standalone mode in production as you will have a single point of failure.  If your standalone mode server goes down,
users will not be able to log in.  This mode is really only useful to test drive and play with the features of Keycloak</p>
</div>
<div class="sect3">
<h4 id="booting-in-standalone-mode"><a class="anchor" href="#booting-in-standalone-mode"></a>Booting in standalone mode</h4>
<div class="paragraph">
<p>When running the server in standalone mode, there is a specific script you need to boot the server depending on your
operating system.  These scripts live in the <em>bin/</em> directory of the server distribution.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Boot Scripts</div>
<p><span class="image"><img src="./keycloak-images/standalone-boot-files.png" alt="standalone boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/standalone.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\standalone.bat</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="standalone-configuration"><a class="anchor" href="#standalone-configuration"></a>Standalone configuration</h4>
<div class="paragraph">
<p>The bulk of this guide walks you through how to configure infrastructure level aspects of Keycloak.  These
aspects are configured in a configuration file that is specific to the application server that Keycloak is a
derivative of.  In the standalone operation mode, this file lives in <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.  This file
is also used to configure non-infrastructure level things that are specific to Keycloak components.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Config File</div>
<p><span class="image"><img src="./keycloak-images/standalone-config-file.png" alt="standalone config file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the server is running will not take effect and may even be overwritten
      by the server.  Instead use the command line scripting or the web console of WildFly.  See
      the <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_standalone-ha-mode"><a class="anchor" href="#_standalone-ha-mode"></a>Using standalone clustered mode</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/standalone-ha.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/standalone-ha.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Standalone clustered operation mode applies when you want to run Keycloak within a cluster.  This mode
requires that you have a copy of the Keycloak distribution on each machine where you want to run a server instance.
This mode can be very easy to deploy initially, but can become quite cumbersome. To make a configuration change,
you modify each distribution on each machine.  For a large cluster, this mode can become time consuming and error prone.</p>
</div>
<div class="sect3">
<h4 id="standalone-clustered-configuration"><a class="anchor" href="#standalone-clustered-configuration"></a>Standalone clustered configuration</h4>
<div class="paragraph">
<p>The distribution has a mostly pre-configured app server configuration file for running within a cluster.  It has all the specific
infrastructure settings for networking, databases, caches, and discovery.  This file resides
in <em>&#8230;&#8203;/standalone/configuration/standalone-ha.xml</em>.  There&#8217;s a few things missing from this configuration.
You can&#8217;t run Keycloak in a cluster without configuring a shared database connection.  You also need to
deploy some type of load balancer in front of the cluster.  The <a href="#_clustering">clustering</a> and
<a href="#_database">database</a> sections of this guide walk you through these things.</p>
</div>
<div class="paragraph">
<div class="title">Standalone HA Config</div>
<p><span class="image"><img src="./keycloak-images/standalone-ha-config-file.png" alt="standalone ha config file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the server is running will not take effect and may even be overwritten
      by the server.  Instead use the command line scripting or the web console of WildFly.  See
      the <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="booting-in-standalone-clustered-mode"><a class="anchor" href="#booting-in-standalone-clustered-mode"></a>Booting in standalone clustered mode</h4>
<div class="paragraph">
<p>You use the same boot scripts to start Keycloak as you do in standalone mode.  The difference is that
you pass in an additional flag to point to the HA config file.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Clustered Boot Scripts</div>
<p><span class="image"><img src="./keycloak-images/standalone-boot-files.png" alt="standalone boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/standalone.sh --server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\standalone.bat --server-config=standalone-ha.xml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_domain-mode"><a class="anchor" href="#_domain-mode"></a>Using domain clustered mode</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/domain.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/domain.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Domain mode is a way to centrally manage and publish the configuration for your servers.</p>
</div>
<div class="paragraph">
<p>Running a cluster in standard mode can quickly become aggravating as the cluster grows in size.  Every time you need
to make a configuration change, you  perform it on each node in the cluster.  Domain mode solves this problem by providing
a central place to store and publish configurations.  It can be quite complex to set up, but it is worth it in the end.
This capability is built into the WildFly Application Server which Keycloak derives from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The guide will go over the very basics of domain mode.  Detailed steps on how to set up domain mode in a cluster should be obtained from the
       <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are some of the basic concepts of running in domain mode.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">domain controller</dt>
<dd>
<p>The domain controller is a process that is responsible for storing, managing, and publishing the general configuration
for each node in the cluster.  This process is the central point from which nodes in a cluster obtain their configuration.</p>
</dd>
<dt class="hdlist1">host controller</dt>
<dd>
<p>The host controller is responsible for managing server instances on a specific machine.  You configure it to run
one or more server instances.  The domain controller can also interact with the host controllers on each machine to
manage the cluster.  To reduce the number of running process, a domain controller also acts as a host controller on
the machine it runs on.</p>
</dd>
<dt class="hdlist1">domain profile</dt>
<dd>
<p>A domain profile is a named set of configuration that can be used by a server to boot from.  A domain controller
can define multiple domain profiles that are consumed by different servers.</p>
</dd>
<dt class="hdlist1">server group</dt>
<dd>
<p>A server group is a collection of servers.  They are managed and configured as one.  You can assign a domain profile to a server group and every service in that
group will use that domain profile as their configuration.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In domain mode, a domain controller is started on a master node.  The configuration for the cluster resides in the domain controller.
Next a host controller is started on each machine in the cluster.  Each host controller deployment configuration specifies how
many Keycloak server instances will be started on that machine.  When the host controller boots up, it starts
as many Keycloak server instances as it was configured to do.  These server instances pull their configuration
from the domain controller.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In some environments, such as Microsoft Azure, the domain mode is not applicable. Please consult the WildFly documentation.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="domain-configuration"><a class="anchor" href="#domain-configuration"></a>Domain configuration</h4>
<div class="paragraph">
<p>Various other chapters in this guide walk you through configuring various aspects like databases,
HTTP network connections, caches, and other infrastructure related things.  While standalone mode uses the <em>standalone.xml</em> file to configure these things,
domain mode uses the <em>&#8230;&#8203;/domain/configuration/domain.xml</em> configuration file.  This is
where the domain profile and server group for the Keycloak server are defined.</p>
</div>
<div class="paragraph">
<div class="title">domain.xml</div>
<p><span class="image"><img src="./keycloak-images/domain-file.png" alt="domain file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the domain controller is running will not take effect and may even be overwritten
      by the server.  Instead use the command line scripting or the web console of WildFly.  See
      the <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some aspects of this <em>domain.xml</em> file.  The <code>auth-server-standalone</code> and <code>auth-server-clustered</code> <code>profile</code> XML blocks are where you are going to make the bulk of your configuration decisions.
You&#8217;ll be configuring things here like network connections, caches, and database connections.</p>
</div>
<div class="listingblock">
<div class="title">auth-server profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;profiles&gt;</span>
        <span class="tag">&lt;profile</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-standalone</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
        <span class="tag">&lt;/profile&gt;</span>
        <span class="tag">&lt;profile</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
        <span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>auth-server-standalone</code> profile is a non-clustered setup.  The <code>auth-server-clustered</code> profile is the clustered setup.</p>
</div>
<div class="paragraph">
<p>If you scroll down further, you&#8217;ll see various <code>socket-binding-groups</code> defined.</p>
</div>
<div class="listingblock">
<div class="title">socket-binding-groups</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;socket-binding-groups&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
        <span class="comment">&lt;!-- load-balancer-sockets should be removed in production systems and replaced with a better software or hardware based one --&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
    <span class="tag">&lt;/socket-binding-groups&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configration defines the default port mappings for various connectors that are opened with each
Keycloak server instance.  Any value that contains <code>${&#8230;&#8203;}</code> is a value that can be overridden on the command line
with the <code>-D</code> switch, i.e.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ domain.sh -Djboss.http.port=80</pre>
</div>
</div>
<div class="paragraph">
<p>The definition of the server group for Keycloak resides in the <code>server-groups</code> XML block.  It specifies the domain profile
that is used (<code>default</code>) and also some default boot arguments for the Java VM when the host controller boots an instance.  It also
binds a <code>socket-binding-group</code> to the server group.</p>
</div>
<div class="listingblock">
<div class="title">server group</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;server-groups&gt;</span>
        <span class="comment">&lt;!-- load-balancer-group should be removed in production systems and replaced with a better software or hardware based one --&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/jvm&gt;</span>
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/jvm&gt;</span>
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
    <span class="tag">&lt;/server-groups&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="host-controller-configuration"><a class="anchor" href="#host-controller-configuration"></a>Host controller configuration</h4>
<div class="paragraph">
<p>Keycloak comes with two host controller configuration files that reside in the <em>&#8230;&#8203;/domain/configuration/</em> directory:
<em>host-master.xml</em> and <em>host-slave.xml</em>.  <em>host-master.xml</em> is configured to boot up a domain controller, a load balancer, and
one Keycloak server instance.  <em>host-slave.xml</em> is configured to talk to the domain controller and boot up
one Keycloak server instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The load balancer is not a required service.  It exists so that you can easily test drive clustering on your development
       machine.  While usable in production, you have the option of replacing it if you have a different hardware or software
       based load balancer you want to use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Host Controller Config</div>
<p><span class="image"><img src="./keycloak-images/host-files.png" alt="host files"></span></p>
</div>
<div class="paragraph">
<p>To disable the load balancer server instance, edit <em>host-master.xml</em> and comment out or remove the <code>"load-balancer"</code> entry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;servers&gt;</span>
        <span class="comment">&lt;!-- remove or comment out next line --&gt;</span>
        <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loadbalancer-group</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        ...
    <span class="tag">&lt;/servers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another interesting thing to note about this file is the declaration of the authentication server instance.  It has
a <code>port-offset</code> setting.  Any network port defined in the <em>domain.xml</em> <code>socket-binding-group</code> or the server group
will have the value of <code>port-offset</code> added to it.  For this sample domain setup, we do this so that ports opened by
the load balancer server don&#8217;t conflict with the authentication server instance that is started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;servers&gt;</span>
        ...
        <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">150</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server&gt;</span>
    <span class="tag">&lt;/servers&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="server-instance-working-directories"><a class="anchor" href="#server-instance-working-directories"></a>Server instance working directories</h4>
<div class="paragraph">
<p>Each Keycloak server instance defined in your host files creates a working directory under <em>&#8230;&#8203;/domain/servers/{SERVER NAME}</em>.
Additional configuration can be put there, and any temporary, log, or data files the server instance needs or creates go there too.
The structure of these per server directories ends up looking like any other WildFly booted server.</p>
</div>
<div class="paragraph">
<div class="title">Working Directories</div>
<p><span class="image"><img src="./keycloak-images/domain-server-dir.png" alt="domain server dir"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="booting-in-domain-clustered-mode"><a class="anchor" href="#booting-in-domain-clustered-mode"></a>Booting in domain clustered mode</h4>
<div class="paragraph">
<p>When running the server in domain mode, there is a specific script you need to run to boot the server depending on your
operating system.  These scripts live in the <em>bin/</em> directory of the server distribution.</p>
</div>
<div class="paragraph">
<div class="title">Domain Boot Script</div>
<p><span class="image"><img src="./keycloak-images/domain-boot-files.png" alt="domain boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/domain.sh --host-config=host-master.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\domain.bat --host-config=host-master.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the boot script you will need to pass in the host controlling configuration file you are going to use via the
<code>--host-config</code> switch.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clustered-domain-example"><a class="anchor" href="#_clustered-domain-example"></a>Testing with a sample clustered domain</h4>
<div class="paragraph">
<p>You can test drive clustering using the sample <em>domain.xml</em> configuration.  This sample domain is meant to run on one machine and boots up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a domain controller</p>
</li>
<li>
<p>an HTTP load balancer</p>
</li>
<li>
<p>two Keycloak server instances</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the <code>domain.sh</code> script twice to start two separate host controllers.</p>
<div class="paragraph">
<p>The first one is the master host controller that starts a domain controller, an HTTP load balancer, and one
Keycloak authentication server instance.  The second one is a slave host controller that starts
up only an authentication server instance.</p>
</div>
</li>
<li>
<p>Configure the slave host controller so that it can talk securely to the domain controller. Perform these steps:</p>
<div class="paragraph">
<p>If you omit these steps, the slave host cannot obtain the centralized configuration from the domain controller.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set up a secure connection by creating a server admin user and a secret that are shared between the master and the slave.</p>
<div class="paragraph">
<p>Run the <code>&#8230;&#8203;/bin/add-user.sh</code> script.</p>
</div>
</li>
<li>
<p>Select <code>Management User</code> when the script asks about the type of user to  add.</p>
<div class="paragraph">
<p>This choice generates a secret that you cut and paste into the
<em>&#8230;&#8203;/domain/configuration/host-slave.xml</em> file.</p>
</div>
<div class="listingblock">
<div class="title">Add App Server Admin</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ add-user.sh
 What type of user do you wish to add?
  a) Management User (mgmt-users.properties)
  b) Application User (application-users.properties)
 (a): a
 Enter the details of the new user to add.
 Using realm 'ManagementRealm' as discovered from the existing property files.
 Username : admin
 Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
  - The password should not be one of the following restricted values {root, admin, administrator}
  - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
  - The password should be different from the username
 Password :
 Re-enter Password :
 What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[ ]:
 About to add user 'admin' for realm 'ManagementRealm'
 Is this correct yes/no? yes
 Added user 'admin' to file '/.../standalone/configuration/mgmt-users.properties'
 Added user 'admin' to file '/.../domain/configuration/mgmt-users.properties'
 Added user 'admin' with groups to file '/.../standalone/configuration/mgmt-groups.properties'
 Added user 'admin' with groups to file '/.../domain/configuration/mgmt-groups.properties'
 Is this new user going to be used for one AS process to connect to another AS process?
 e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
 yes/no? yes
 To represent the user add the following to the server-identities definition &lt;secret value="bWdtdDEyMyE=" /&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The add-user.sh script does not add the user to the Keycloak server but to the underlying JBoss Enterprise Application Platform. The credentials used and generated in this script are only for demonstration purposes. Please use the ones generated on your system.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cut and paste the secret value into the <em>&#8230;&#8203;/domain/configuration/host-slave.xml</em> file as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">     <span class="tag">&lt;management&gt;</span>
         <span class="tag">&lt;security-realms&gt;</span>
             <span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;server-identities&gt;</span>
                     <span class="tag">&lt;secret</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bWdtdDEyMyE=</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                 <span class="tag">&lt;/server-identities&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the <em>username</em> of the created user in the <em>&#8230;&#8203;/domain/configuration/host-slave.xml</em> file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">     <span class="tag">&lt;remote</span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Run the boot script twice to simulate a two node cluster on one development machine.</p>
<div class="listingblock">
<div class="title">Boot up master</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ domain.sh --host-config=host-master.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Boot up slave</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ domain.sh --host-config=host-slave.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Open your browser and go to <a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a> to try it out.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="crossdc-mode"><a class="anchor" href="#crossdc-mode"></a>Using cross-site replication mode</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>cross-site replication mode is <strong>Technology Preview</strong> and is not fully supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use cross-site replication mode to run Keycloak in a cluster across multiple data centers. Typically you use data center sites that are in different geographic regions. When using this mode, each data center will have its own cluster of Keycloak servers.</p>
</div>
<div class="paragraph">
<p>This documentation will refer to the following example architecture diagram to illustrate and describe a simple cross-site replication use case.</p>
</div>
<div id="archdiagram" class="paragraph">
<div class="title">Example Architecture Diagram</div>
<p><span class="image"><img src="./keycloak-images/cross-dc-architecture.png" alt="cross dc architecture"></span></p>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h4>
<div class="paragraph">
<p>As this is an advanced topic, we recommend you first read the following, which provide valuable background knowledge:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.keycloak.org/docs/latest/server_installation/#_clustering">Clustering with Keycloak</a>
When setting up for cross-site replication, you will use more independent Keycloak clusters, so you must understand how a cluster works and the basic concepts and requirements such as load balancing, shared databases, and multicasting.</p>
</li>
<li>
<p><a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html#xsite_replication">Infinispan Cross-Site Replication</a> replicates data across clusters in separate geographic locations.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="technicaldetails"><a class="anchor" href="#technicaldetails"></a>Technical details</h4>
<div class="paragraph">
<p>This section provides an introduction to the concepts and details of how Keycloak cross-site replication is accomplished.</p>
</div>
<div class="paragraph">
<div class="title">Data</div>
<p>Keycloak is stateful application. It uses the following as data sources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A database is used to persist permanent data, such as user information.</p>
</li>
<li>
<p>An Infinispan cache is used to cache persistent data from the database and also to save some short-lived and frequently-changing metadata, such as for user sessions.
Infinispan is usually much faster than a database, however the data saved using Infinispan are not permanent and is not expected to persist across cluster restarts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In our example architecture, there are two data centers called <code>site1</code> and <code>site2</code>. For cross-site replication, we must make sure that both sources of data work reliably and that Keycloak
servers from <code>site1</code> are eventually able to read the data saved by Keycloak servers on <code>site2</code> .</p>
</div>
<div class="paragraph">
<p>Based on the environment, you have the option to decide if you prefer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reliability - which is typically used in Active/Active mode. Data written on <code>site1</code> must be visible immediately on <code>site2</code>.</p>
</li>
<li>
<p>Performance - which is typically used in Active/Passive mode. Data written on <code>site1</code> does not need to be visible immediately on <code>site2</code>.
In some cases, the data may not be visible on <code>site2</code> at all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more details, see <a href="#modes">Modes</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="requestprocessing"><a class="anchor" href="#requestprocessing"></a>Request processing</h4>
<div class="paragraph">
<p>An end user&#8217;s browser sends an HTTP request to the <a href="https://www.keycloak.org/docs/latest/server_installation/#_setting-up-a-load-balancer-or-proxy">front end load balancer</a>. This load balancer is usually HTTPD or WildFly with mod_cluster, NGINX, HA Proxy, or perhaps some other kind of software or hardware load balancer.</p>
</div>
<div class="paragraph">
<p>The load balancer then forwards the HTTP requests it receives to the underlying Keycloak instances, which can be spread among multiple data centers. Load balancers typically offer support for <a href="https://www.keycloak.org/docs/latest/server_installation/#sticky-sessions">sticky sessions</a>, which means that the load balancer is able to always forward all HTTP requests from the same user to the same Keycloak instance in same data center.</p>
</div>
<div class="paragraph">
<p>HTTP requests that are sent from client applications to the load balancer are called <code>backchannel requests</code>.
These are not seen by an end user&#8217;s browser and therefore can not be part of a sticky session between the user and the load balancer. For backchannel requests, the loadbalancer can forward the HTTP request to any Keycloak instance in any data center. This is challenging as some OpenID Connect and some SAML flows require multiple HTTP requests from both the user and the application. Because we can not reliably depend on sticky sessions to force all the related requests to be sent to the same Keycloak instance in the same data center, we must instead replicate some data across data centers, so the data are seen by subsequent HTTP requests during a particular flow.</p>
</div>
</div>
<div class="sect3">
<h4 id="modes"><a class="anchor" href="#modes"></a>Modes</h4>
<div class="paragraph">
<p>According your requirements, there are two basic operating modes for cross-site replication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Active/Passive - Here the users and client applications send the requests just to the Keycloak nodes in just a single data center.
The second data center is used just as a <code>backup</code> for saving the data. In case of the failure in the main data center, the data can be usually restored from the second data center.</p>
</li>
<li>
<p>Active/Active - Here the users and client applications send the requests to the Keycloak nodes in both data centers.
It means that data need to be visible immediately on both sites and available to be consumed immediately from Keycloak servers on both sites. This is especially true if Keycloak server writes some data on <code>site1</code>, and it is required that the data are available immediately for reading by Keycloak servers on <code>site2</code> immediately after the write on <code>site1</code> is finished.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The active/passive mode is better for performance. For more information about how to configure caches for either mode, see: <a href="#backups">SYNC or ASYNC backups</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="database"><a class="anchor" href="#database"></a>Database</h4>
<div class="paragraph">
<p>Keycloak uses a relational database management system (RDBMS) to persist some metadata about realms, clients, users, and so on. See <a href="https://www.keycloak.org/docs/latest/server_installation/#_database">this chapter</a> of the server installation guide for more details. In a cross-site replication setup, we assume that either both data centers talk to the same database or that every data center has its own database node and both database nodes are synchronously replicated across the data centers. In both cases, it is required that when a Keycloak server on <code>site1</code> persists some data and commits the transaction, those data are immediately visible by subsequent DB transactions on <code>site2</code>.</p>
</div>
<div class="paragraph">
<p>Details of DB setup are out-of-scope for Keycloak, however many RDBMS vendors like MariaDB and Oracle offer replicated databases and synchronous replication. We test Keycloak with these vendors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Oracle Database 19c RAC</p>
</li>
<li>
<p>Galera 3.12 cluster for MariaDB server version 10.1.19-MariaDB</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="cache"><a class="anchor" href="#cache"></a>Infinispan caches</h4>
<div class="paragraph">
<p>This section begins with a high level description of the Infinispan caches. More details of the cache setup follow.</p>
</div>
<div class="paragraph">
<div class="title">Authentication sessions</div>
<p>In Keycloak we have the concept of authentication sessions. There is a separate Infinispan cache called <code>authenticationSessions</code> used to save data during authentication of particular user. Requests from this cache usually involve only a browser and the Keycloak server, not the application. Here we can rely on sticky sessions and the <code>authenticationSessions</code> cache content does not need to be replicated across data centers, even if you are in Active/Active mode.</p>
</div>
<div class="paragraph">
<div class="title">Action tokens</div>
<p>We also have the concept of <a href="https://www.keycloak.org/docs/latest/server_development/#_action_token_spi">action tokens</a>, which are used typically for scenarios when the user needs to confirm an action asynchronously by email. For example, during the <code>forget password</code> flow the <code>actionTokens</code> Infinispan cache is used to track metadata about related action tokens, such as which action token was already used, so it can&#8217;t be reused second time. This usually needs to be replicated across data centers.</p>
</div>
<div class="paragraph">
<div class="title">Caching and invalidation of persistent data</div>
<p>Keycloak uses Infinispan to cache persistent data to avoid many unnecessary requests to the database.
Caching improves performance, however it adds an additional challenge. When some Keycloak server updates any data, all other Keycloak servers in all data centers need to be aware of it, so they invalidate particular data from their caches. Keycloak uses local Infinispan caches called <code>realms</code>, <code>users</code>, and <code>authorization</code> to cache persistent data.</p>
</div>
<div class="paragraph">
<p>We use a separate cache, <code>work</code>, which is replicated across all data centers. The work cache itself does not cache
any real data. It is used only for sending invalidation messages between cluster nodes and data centers.
In other words, when data is updated, such as the user <code>john</code>, the Keycloak node sends the invalidation message to all other cluster nodes in the same data center and also to all other data centers. After receiving the invalidation notice, every node then invalidates the appropriate data from their local cache.</p>
</div>
<div class="paragraph">
<div class="title">User sessions</div>
<p>There are Infinispan caches called <code>sessions</code>, <code>clientSessions</code>, <code>offlineSessions</code>, and <code>offlineClientSessions</code>,
all of which usually need to be replicated across data centers. These caches are used to save data about user
sessions, which are valid for the length of a user&#8217;s browser session. The caches must handle the HTTP requests from the end user and from the application. As described above, sticky sessions can not be reliably used in this instance, but we still want to ensure that subsequent HTTP requests can see the latest data. For this reason, the data are usually replicated across data centers.</p>
</div>
<div class="paragraph">
<div class="title">Brute force protection</div>
<p>Finally the <code>loginFailures</code> cache is used to track data about failed logins, such as how many times the user <code>john</code>
entered a bad password. The details are described <a href="https://www.keycloak.org/docs/latest/server_admin/#password-guess-brute-force-attacks">here</a>. It is up to the admin whether this cache should be replicated across data centers. To have an accurate count of login failures, the replication is needed. On the other hand, not replicating this data can save some performance. So if performance is more important than accurate counts of login failures, the replication can be avoided.</p>
</div>
<div class="paragraph">
<p>For more detail about how caches can be configured see <a href="#tuningcache">Tuning the Infinispan cache configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="communication"><a class="anchor" href="#communication"></a>Communication details</h4>
<div class="paragraph">
<p>Keycloak uses multiple, separate clusters of Infinispan caches. Every Keycloak node is in the cluster with the other Keycloak nodes in same data center, but not with the Keycloak nodes in different data centers. A Keycloak node does not communicate directly with the Keycloak nodes from different data centers. Keycloak nodes use external JDG (actually Infinispan servers) for communication across data centers. This is done using the <a href="https://infinispan.org/docs/10.1.x/titles/server/server.html#hot_rod">Infinispan HotRod protocol</a>.</p>
</div>
<div class="paragraph">
<p>The Infinispan caches on the Keycloak side must be configured with the <a href="https://infinispan.org/docs/10.1.x/titles/configuring/configuring.html#remote_cache_store">remoteStore</a> to ensure that data are saved to the remote cache. There is separate Infinispan cluster between JDG servers, so the data saved on JDG1 on <code>site1</code> are replicated to JDG2 on <code>site2</code> .</p>
</div>
<div class="paragraph">
<p>The receiving Infinispan server notifies the Keycloak servers in its cluster through Client Listeners, which are a feature of the Hot Rod protocol. Keycloak nodes on <code>site2</code> then update their Infinispan caches and the particular user session is also visible on Keycloak nodes on <code>site2</code>.</p>
</div>
<div class="paragraph">
<p>See the <a href="#archdiagram">Example Architecture Diagram</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="assembly-setting-up-crossdc"><a class="anchor" href="#assembly-setting-up-crossdc"></a>Setting up cross-site with Infinispan 11.0.8</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc/assembly-setting-up-crossdc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc/assembly-setting-up-crossdc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph _abstract">
<p>Use the following procedures for Infinispan 11.0.8 to perform a basic setup of cross-site replication.</p>
</div>
<div class="paragraph">
<p>This example for Infinispan 11.0.8 involves two data centers, <code>site1</code> and <code>site2</code>. Each data center consists of 1 Infinispan server and 2 Keycloak servers. We will end up with 2 Infinispan servers and 4 Keycloak servers in total.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Site1</code> consists of Infinispan server, <code>server1</code>, and 2 Keycloak servers, <code>node11</code> and <code>node12</code> .</p>
</li>
<li>
<p><code>Site2</code> consists of Infinispan server, <code>server2</code>, and 2 Keycloak servers, <code>node21</code> and <code>node22</code> .</p>
</li>
<li>
<p>Infinispan servers <code>server1</code> and <code>server2</code> are connected to each other through the RELAY2 protocol and <code>backup</code> based Infinispan
caches in a similar way as described in the <a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html">Infinispan documentation</a>.</p>
</li>
<li>
<p>Keycloak servers <code>node11</code> and <code>node12</code> form a cluster with each other, but they do not communicate directly with any server in <code>site2</code>.
They communicate with the Infinispan server <code>server1</code> using the Hot Rod protocol (Remote cache). See <a href="#communication">Communication details</a> for more information.</p>
</li>
<li>
<p>The same details apply for <code>node21</code> and <code>node22</code>. They cluster with each other and communicate only with <code>server2</code> server using the Hot Rod protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our example setup assumes that the four Keycloak servers talk to the same database. In production, we recommend that you use separate synchronously replicated databases across data centers as described in <a href="#database">Database</a>.</p>
</div>
<div class="sect4">
<h5 id="setting-up-infinispan-xsite"><a class="anchor" href="#setting-up-infinispan-xsite"></a>Setting Up Infinispan Servers</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc/proc-setting-up-infinispan.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc/proc-setting-up-infinispan.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For cross-site replication, you start by creating remote Infinispan clusters that can back up Keycloak data.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Download and install Infinispan Server 11.0.8.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Server 11.0.8 requires Java 11.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a user to authenticate client connections from Infinispan, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">$ bin/cli.sh user create myuser -p &quot;qwer1234!&quot;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You specify these credentials in the Hot Rod client configuration when you create remote caches on Keycloak.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create an SSL keystore and truststore to secure connections between Infinispan and Keycloak, for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a keystore to provide an SSL identity to your Infinispan cluster</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">keytool -genkey -alias server -keyalg RSA -keystore server.jks -keysize 2048</code></pre>
</div>
</div>
</li>
<li>
<p>Export an SSL certificate from the keystore.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">keytool -exportcert -keystore server.jks -alias server -file server.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Import the SSL certificate into a truststore that Keycloak can use to verify the SSL identity for Infinispan.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">keytool -importcert -keystore truststore.jks -alias server -file server.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Remove <code>server.crt</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">rm server.crt</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configuring-infinispan-xsite"><a class="anchor" href="#configuring-infinispan-xsite"></a>Configuring Infinispan Clusters</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc/proc-configuring-infinispan.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc/proc-configuring-infinispan.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Configure Infinispan clusters to replicate Keycloak data across data centers.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install and set up Infinispan Server.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open <code>infinispan.xml</code> for editing.</p>
<div class="paragraph">
<p>By default, Infinispan Server uses <code>server/conf/infinispan.xml</code> for static configuration such as cluster transport and security mechanisms.</p>
</div>
</li>
<li>
<p>Create a stack that uses TCPPING as the cluster discovery protocol.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">global-cluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- Remove MPING protocol from the stack and add TCPPING --&gt;</span>
    <span class="tag">&lt;TCPPING</span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server1[7800],server2[7800]</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
             <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REPLACE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MPING</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/stack&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lists the host names for <code>server1</code> and <code>server2</code>.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the Infinispan cluster transport to perform cross-site replication.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the RELAY2 protocol to a JGroups stack.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;jgroups&gt;</span>
   <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xsite</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tag">&lt;relay.RELAY2</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site1</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                    <span class="attribute-name">max_site_masters</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tag">&lt;remote-sites</span> <span class="attribute-name">default-stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">global-cluster</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
         <span class="tag">&lt;remote-site</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;remote-site</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/remote-sites&gt;</span>
   <span class="tag">&lt;/stack&gt;</span>
<span class="tag">&lt;/jgroups&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a stack named <code>xsite</code> that extends the default UDP cluster transport.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds the RELAY2 protocol and names the cluster you are configuring as <code>site1</code>. The site name must be unique to each Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Sets 1000 as the number of relay nodes for the cluster. You should set a value that is equal to or greater than the maximum number of nodes in your Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Names all Infinispan clusters that backup caches with Infinispan data and uses the default TCP stack for inter-cluster transport.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the Infinispan cluster transport to use the stack.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${infinispan.cluster.name:cluster}</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xsite</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses the <code>xsite</code> stack for the cluster.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the keystore as an SSL identity in the server security realm.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server-identities&gt;</span>
  <span class="tag">&lt;ssl&gt;</span>
    <span class="tag">&lt;keystore</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server.jks</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
              <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.server.config.path</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">keystore-password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
              <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tag">&lt;/ssl&gt;</span>
<span class="tag">&lt;/server-identities&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies the path of the keystore that contains the SSL identity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the password to access the keystore.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names the alias of the certificate in the keystore.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the authentication mechanism for the Hot Rod endpoint.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;endpoints</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;authentication&gt;</span>
         <span class="tag">&lt;sasl</span> <span class="attribute-name">mechanisms</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SCRAM-SHA-512</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
               <span class="attribute-name">server-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tag">&lt;/authentication&gt;</span>
   <span class="tag">&lt;/hotrod-connector&gt;</span>
   <span class="tag">&lt;rest-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/endpoints&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures the SASL authentication mechanism for the Hot Rod endpoint.  SCRAM-SHA-512 is the default SASL mechanism for Hot Rod. However you can use whatever is appropriate for your environment, such as GSSAPI.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines the name that Infinispan servers present to clients. You specify this name in the Hot Rod client configuration when you set up Keycloak.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a cache template.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Add the cache template to <code>infinispan.xml</code> on each node in the Infinispan cluster.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">...</span> <span class="tag">&gt;</span>
  <span class="tag">&lt;replicated-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
                                  <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;locking</span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;backups&gt;</span>
      <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tag">&lt;/backups&gt;</span>
  <span class="tag">&lt;/replicated-cache-configuration&gt;</span>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a cache template named <code>sessions-cfg</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines a cache that synchronously replicates data across the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disables timeout for lock acquisition.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Names the backup site for the Infinispan cluster you are configuring.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Start Infinispan server1.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">./server.sh -c infinispan.xml -b PUBLIC_IP_ADDRESS -k PUBLIC_IP_ADDRESS -Djgroups.mcast_addr=228.6.7.10</code></pre>
</div>
</div>
</li>
<li>
<p>Start Infinispan server2.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">./server.sh -c infinispan.xml -b PUBLIC_IP_ADDRESS -k PUBLIC_IP_ADDRESS -Djgroups.mcast_addr=228.6.7.11</code></pre>
</div>
</div>
</li>
<li>
<p>Check Infinispan server logs to verify the clusters form cross-site views.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>INFO  [org.infinispan.XSITE] (jgroups-5,${server.hostname}) ISPN000439: Received new x-site view: [site1]
INFO  [org.infinispan.XSITE] (jgroups-7,${server.hostname}) ISPN000439: Received new x-site view: [site1, site2]</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="creating-infinispan-caches-xsite"><a class="anchor" href="#creating-infinispan-caches-xsite"></a>Creating Infinispan Caches</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc/proc-creating-infinispan-caches.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc/proc-creating-infinispan-caches.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Create the Infinispan caches that Keycloak requires.</p>
</div>
<div class="paragraph">
<p>We recommend that you create caches on Infinispan clusters at runtime rather than adding caches to <code>infinispan.xml</code>.
This strategy ensures that your caches are automatically synchronized across the cluster and permanently stored.</p>
</div>
<div class="paragraph">
<p>The following procedure uses the Infinispan Command Line Interface (CLI) to create all the required caches in a single batch command.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure your Infinispan clusters.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a batch file that contains caches, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">cat &gt; /tmp/caches.batch&lt;&lt;EOF
echo &quot;creating caches...&quot;
create cache work --template=sessions-cfg
create cache sessions --template=sessions-cfg
create cache clientSessions --template=sessions-cfg
create cache offlineSessions --template=sessions-cfg
create cache offlineClientSessions --template=sessions-cfg
create cache actionTokens --template=sessions-cfg
create cache loginFailures --template=sessions-cfg
echo &quot;verifying caches&quot;
ls caches
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Create the caches with the CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">$ bin/cli.sh -c https://server1:11222 --trustall -f /tmp/caches.batch</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Instead of the <code>--trustall</code> argument you can specify the truststore with the <code>-t</code> argument and the truststore password with the <code>-s</code> argument.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the caches on the other site.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-configuring-remote-cache-xsite"><a class="anchor" href="#proc-configuring-remote-cache-xsite"></a>Configuring Remote Cache Stores on Keycloak</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operating-mode/crossdc/proc-configuring-remote-cache.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operating-mode/crossdc/proc-configuring-remote-cache.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>After you set up remote Infinispan clusters, you configure the Infinispan subsystem on Keycloak to externalize data to those clusters through remote stores.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Set up remote Infinispan clusters for cross-site configuration.</p>
</li>
<li>
<p>Create a truststore that contains the SSL certificate with the Infinispan Server identity.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the truststore to the Keycloak deployment.</p>
</li>
<li>
<p>Create a socket binding that points to your Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${remote.cache.host:server_hostname}</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                      <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${remote.cache.port:11222}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tag">&lt;/outbound-socket-binding&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the socket binding as <code>remote-cache</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies one or more hostnames for the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines the port of <code>11222</code> where the Hot Rod endpoint listens.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>org.keycloak.keycloak-model-infinispan</code> module to the <code>keycloak</code> cache container in the Infinispan subsystem.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">modules</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.keycloak-model-infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Update the <code>work</code> cache in the Infinispan subsystem so it has the following configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                  <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
                  <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_username</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>myuser<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>qwer1234!<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_realm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>default<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_server_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>infinispan<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.sasl_mechanism</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>SCRAM-SHA-512<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_file_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>/path/to/truststore.jks<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>JKS<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the cache in the Infinispan configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Names the corresponding cache on the remote Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the <code>remote-cache</code> socket binding.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The preceding cache configuration includes recommended settings for Infinispan caches.
Hot Rod client configuration properties specify the Infinispan user credentials and SSL keystore and truststore details.</p>
</div>
<div class="paragraph">
<p>Refer to the
<a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html#configure_clients-xsite">Infinispan documentation</a>
for descriptions of each property.</p>
</div>
</li>
<li>
<p>Add distributed caches to the Infinispan subsystem for each of the following caches:</p>
<div class="ulist">
<ul>
<li>
<p>sessions</p>
</li>
<li>
<p>clientSessions</p>
</li>
<li>
<p>offlineSessions</p>
</li>
<li>
<p>offlineClientSessions</p>
</li>
<li>
<p>actionTokens</p>
</li>
<li>
<p>loginFailures</p>
<div class="paragraph">
<p>For example, add a cache named <code>sessions</code> with the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
                   <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
                  <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
                  <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_username</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>myuser<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>qwer1234!<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_realm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>default<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.auth_server_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>infinispan<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.sasl_mechanism</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>SCRAM-SHA-512<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_file_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>/path/to/truststore.jks<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>JKS<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.client.hotrod.trust_store_password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the cache in the Infinispan configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configures one replica of each cache entry across the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names the corresponding cache on the remote Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specifies the <code>remote-cache</code> socket binding.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Copy the <code>NODE11</code> to 3 other directories referred later as <code>NODE12</code>, <code>NODE21</code> and <code>NODE22</code>.</p>
</li>
<li>
<p>Start <code>NODE11</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE11/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node11 -Djboss.site.name=site1 \
  -Djboss.default.multicast.address=234.56.78.1 -Dremote.cache.host=server1 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you notice the following warning messages in logs, you can safely ignore them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>WARN  [org.infinispan.CONFIG] (MSC service thread 1-5) ISPN000292: Unrecognized attribute 'infinispan.client.hotrod.auth_password'. Please check your configuration. Ignoring!
WARN  [org.infinispan.CONFIG] (MSC service thread 1-5) ISPN000292: Unrecognized attribute 'infinispan.client.hotrod.auth_username'. Please check your configuration. Ignoring!</code></pre>
</div>
</div>
</li>
<li>
<p>Start <code>NODE12</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE12/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node12 -Djboss.site.name=site1 \
  -Djboss.default.multicast.address=234.56.78.1 -Dremote.cache.host=server1 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster nodes should be connected. Something like this should be in the log of both NODE11 and NODE12:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node11|1] (2) [node11, node12]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The channel name in the log might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Start <code>NODE21</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE21/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node21 -Djboss.site.name=site2 \
  -Djboss.default.multicast.address=234.56.78.2 -Dremote.cache.host=server2 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>It shouldn&#8217;t be connected to the cluster with <code>NODE11</code> and <code>NODE12</code>, but to a separate one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node21|0] (1) [node21]</code></pre>
</div>
</div>
</li>
<li>
<p>Start <code>NODE22</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE22/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node22 -Djboss.site.name=site2 \
  -Djboss.default.multicast.address=234.56.78.2 -Dremote.cache.host=server2 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>It should be in cluster with <code>NODE21</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node21|1] (2) [node21, node22]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The channel name in the log might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Test:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Go to <code><a href="http://node11:8080/auth/" class="bare">http://node11:8080/auth/</a></code> and create the initial admin user.</p>
</li>
<li>
<p>Go to <code><a href="http://node11:8080/auth/admin" class="bare">http://node11:8080/auth/admin</a></code> and login as admin to admin console.</p>
</li>
<li>
<p>Open a second browser and go to any of nodes <code><a href="http://node12:8080/auth/admin" class="bare">http://node12:8080/auth/admin</a></code> or <code><a href="http://node21:8080/auth/admin" class="bare">http://node21:8080/auth/admin</a></code> or <code><a href="http://node22:8080/auth/admin" class="bare">http://node22:8080/auth/admin</a></code>. After login, you should be able to see
the same sessions in tab <code>Sessions</code> of particular user, client or realm on all 4 servers.</p>
</li>
<li>
<p>After making a change in the Keycloak Admin Console, such as modifying a user or a realm, that change should be immediately visible on any of the four nodes. Caches should be properly invalidated everywhere.</p>
</li>
<li>
<p>Check server.logs if needed. After login or logout, the message like this should be on all the nodes <code>NODEXY/standalone/log/server.log</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>2017-08-25 17:35:17,737 DEBUG [org.keycloak.models.sessions.infinispan.remotestore.RemoteCacheSessionListener] (Client-Listener-sessions-30012a77422542f5) Received event from remote store.
Event 'CLIENT_CACHE_ENTRY_REMOVED', key '193489e7-e2bc-4069-afe8-f1dfa73084ea', skip 'false'</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup"><a class="anchor" href="#setup"></a>Setting up cross-site replication with Infinispan 9.4.19</h4>
<div class="paragraph">
<p>This example for Infinispan 9.4.19 involves two data centers, <code>site1</code> and <code>site2</code>. Each data center consists of 1 Infinispan server and 2 Keycloak servers. We will end up with 2 Infinispan servers and 4 Keycloak servers in total.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Site1</code> consists of Infinispan server, <code>server1</code>, and 2 Keycloak servers, <code>node11</code> and <code>node12</code> .</p>
</li>
<li>
<p><code>Site2</code> consists of Infinispan server, <code>server2</code>, and 2 Keycloak servers, <code>node21</code> and <code>node22</code> .</p>
</li>
<li>
<p>Infinispan servers <code>server1</code> and <code>server2</code> are connected to each other through the RELAY2 protocol and <code>backup</code> based Infinispan
caches in a similar way as described in the <a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html">Infinispan documentation</a>.</p>
</li>
<li>
<p>Keycloak servers <code>node11</code> and <code>node12</code> form a cluster with each other, but they do not communicate directly with any server in <code>site2</code>.
They communicate with the Infinispan server <code>server1</code> using the Hot Rod protocol (Remote cache). See <a href="#communication">Communication details</a> for the details.</p>
</li>
<li>
<p>The same details apply for <code>node21</code> and <code>node22</code>. They cluster with each other and communicate only with <code>server2</code> server using the Hot Rod protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our example setup assumes all that all 4 Keycloak servers talk to the same database. In production, it is recommended to use separate synchronously replicated databases across data centers as described in <a href="#database">Database</a>.</p>
</div>
<div class="sect4">
<h5 id="jdgsetup"><a class="anchor" href="#jdgsetup"></a>Setting up the Infinispan server</h5>
<div class="paragraph">
<p>Follow these steps to set up the Infinispan server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download Infinispan 9.4.19 server and unzip to a directory you choose. This location will be referred in later steps as <code>SERVER1_HOME</code> .</p>
</li>
<li>
<p>Change those things in the <code>SERVER1_HOME/server/conf/infinispan-xsite.xml</code> in the configuration of JGroups subsystem:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the <code>xsite</code> channel, which will use <code>tcp</code> stack, under <code>channels</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;channels</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;channel</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;channel</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xsite</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/channels&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add a <code>relay</code> element to the end of the <code>udp</code> stack. We will configure it in a way that our site is <code>site1</code> and the other site, where we will backup, is <code>site2</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;relay</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-site</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xsite</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">relay_multicasts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>false<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/relay&gt;</span>
<span class="tag">&lt;/stack&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>tcp</code> stack to use <code>TCPPING</code> protocol instead of <code>MPING</code>. Remove the <code>MPING</code> element and replace it with the <code>TCPPING</code>. The <code>initial_hosts</code> element points to the hosts <code>server1</code> and <code>server2</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCPPING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">initial_hosts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>server1[7600],server2[7600]<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ergonomics</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>false<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/protocol&gt;</span>
    <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/stack&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is just an example setup to have things quickly running. In production, you are not required to use <code>tcp</code> stack for the JGroups <code>RELAY2</code>, but you can configure any other stack. For example, you could use the default udp stack, if the network between your data centers is able to support multicast. Just make sure that the Infinispan and Keycloak clusters are mutually indiscoverable. Similarly, you are not required to use <code>TCPPING</code> as discovery protocol. And in production, you probably won&#8217;t use <code>TCPPING</code> due it&#8217;s static nature. Finally, site names are also configurable.
Details of this more-detailed setup are out-of-scope of the Keycloak documentation. See the Infinispan documentation and JGroups documentation for more details.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add this into <code>SERVER1_HOME/standalone/configuration/clustered.xml</code> under cache-container named <code>clustered</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;replicated-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EAGER</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">batching</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;locking</span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;backups&gt;</span>
                <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;take-offline</span> <span class="attribute-name">min-wait</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">after-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/backup&gt;</span>
            <span class="tag">&lt;/backups&gt;</span>
        <span class="tag">&lt;/replicated-cache-configuration&gt;</span>

        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineClientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">actionTokens</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginFailures</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Details about the configuration options inside <code>replicated-cache-configuration</code> are explained in <a href="#tuningcache">Tuning the Infinispan cache configuration</a>, which includes information about tweaking some of those options.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Unlike in previous version, the Infinispan server <code>replicated-cache-configuration</code> needs to be configured without <code>transaction</code>
element. See <a href="#troubleshooting">Troubleshooting</a> for more details.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Some Infinispan server releases require authorization before accessing protected caches over network.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You should not see any issue if you use recommended Infinispan 9.4.19 server and this step can (and should) be ignored.
Issues related to authorization may exist just for some other versions of Infinispan server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Keycloak requires updates to
<code>___script_cache</code> cache containing scripts. If you get errors accessing this cache, you will need to set up authorization in
<code>clustered.xml</code> configuration as described below:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <code>&lt;management&gt;</code> section, add a security realm:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;management&gt;</span>
    <span class="tag">&lt;security-realms&gt;</span>
        ...
        <span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AllowScriptManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;authentication&gt;</span>
                <span class="tag">&lt;users&gt;</span>
                    <span class="tag">&lt;user</span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">___script_manager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;password&gt;</span>not-so-secret-password<span class="tag">&lt;/password&gt;</span>
                    <span class="tag">&lt;/user&gt;</span>
                <span class="tag">&lt;/users&gt;</span>
            <span class="tag">&lt;/authentication&gt;</span>
        <span class="tag">&lt;/security-realm&gt;</span>
    <span class="tag">&lt;/security-realms&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>In the server core subsystem, add <code>&lt;security&gt;</code> as below:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:core:8.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;security&gt;</span>
            <span class="tag">&lt;authorization&gt;</span>
                <span class="tag">&lt;identity-role-mapper</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">___script_manager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/authorization&gt;</span>
        <span class="tag">&lt;/security&gt;</span>
        ...</code></pre>
</div>
</div>
</li>
<li>
<p>In the endpoint subsystem, add authentication configuration to Hot Rod connector:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:endpoint:8.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;authentication</span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AllowScriptManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;sasl</span> <span class="attribute-name">mechanisms</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">qop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">server-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak-jdg-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;policy&gt;</span>
                    <span class="tag">&lt;no-anonymous</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/policy&gt;</span>
            <span class="tag">&lt;/sasl&gt;</span>
        <span class="tag">&lt;/authentication&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the server to the second location, which will be referred to later as <code>SERVER2_HOME</code>.</p>
</li>
<li>
<p>In the <code>SERVER2_HOME/standalone/configuration/clustered.xml</code> exchange <code>site1</code> with <code>site2</code> and vice versa, both in the configuration of <code>relay</code> in the JGroups subsystem and in configuration of <code>backups</code> in the cache-subsystem. For example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The <code>relay</code> element should look like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;relay</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-site</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">channel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xsite</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">relay_multicasts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>false<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/relay&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>The <code>backups</code> element like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;backups&gt;</span>
  <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">....</span>
  <span class="attribute-name">...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <em>PUBLIC_IP_ADDRESS</em> below refers to the IP address or hostname, which can be used for your server to bind to. Note that
every Infinispan server and Keycloak server needs to use different address. During example setup with all the servers running on the same host,
you may need to add the option <code>-Djboss.bind.address.management=<em>PUBLIC_IP_ADDRESS</em></code> as every server needs to use also different management interface.
But this option usually should be omitted in production environments to avoid the ability for remote access to your server. For more information,
see the <a href="http://docs.wildfly.org/23/Admin_Guide.html#Interfaces_and_ports"><em>WildFly 23 Documentation</em></a>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Start server <code>server1</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd SERVER1_HOME/bin
./standalone.sh -c clustered.xml -Djava.net.preferIPv4Stack=true \
  -Djboss.default.multicast.address=234.56.78.99 \
  -Djboss.node.name=server1 -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
</li>
<li>
<p>Start server <code>server2</code>. There is a different multicast address, so the <code>server1</code> and <code>server2</code> servers are not directly clustered with each other; rather, they are just connected through the RELAY2 protocol, and the TCP JGroups stack is used for communication between them. The start up command looks like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd SERVER2_HOME/bin
./standalone.sh -c clustered.xml -Djava.net.preferIPv4Stack=true \
  -Djboss.default.multicast.address=234.56.78.100 \
  -Djboss.node.name=server2 -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
</li>
<li>
<p>To verify that channel works at this point, you may need to use JConsole and connect either to the running <code>SERVER1</code> or the <code>SERVER2</code> server. When you use the MBean <code>jgroups:type=protocol,cluster="cluster",protocol=RELAY2</code> and operation <code>printRoutes</code>, you should see output like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>site1 --&gt; _server1:site1
site2 --&gt; _server2:site2</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you use the MBean <code>jgroups:type=protocol,cluster="cluster",protocol=GMS</code>, you should see that the attribute member contains just single member:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>On <code>SERVER1</code> it should be like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>(1) server1</code></pre>
</div>
</div>
</li>
<li>
<p>And on SERVER2 like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>(1) server2</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In production, you can have more Infinispan servers in every data center. You just need to ensure that Infinispan servers in same data center are using the same multicast address (In other words, the same <code>jboss.default.multicast.address</code> during startup). Then in jconsole in <code>GMS</code> protocol view, you will see all the members of current cluster.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="serversetup"><a class="anchor" href="#serversetup"></a>Setting up Keycloak servers</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip Keycloak server distribution to a location you choose. It will be referred to later as <code>NODE11</code>.</p>
</li>
<li>
<p>Configure a shared database for KeycloakDS datasource. It is recommended to use MySQL or MariaDB for testing purposes. See <a href="#database">Database</a> for more details.</p>
<div class="paragraph">
<p>In production you will likely need to have a separate database server in every data center and both database servers should be synchronously replicated to each other. In the example setup, we just use a single database and connect all 4 Keycloak servers to it.</p>
</div>
</li>
<li>
<p>Edit <code>NODE11/standalone/configuration/standalone-ha.xml</code> :</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the attribute <code>site</code> to the JGroups UDP protocol:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UDP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.site.name}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>remote-store</code> under <code>work</code> cache:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>remote-store</code> like this under <code>sessions</code> cache:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Do the same for <code>offlineSessions</code>, <code>clientSessions</code>, <code>offlineClientSessions</code>, <code>loginFailures</code>, and <code>actionTokens</code> caches (the only difference from <code>sessions</code> cache is that <code>cache</code> property value are different):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineClientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineClientSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginFailures</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginFailures</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">actionTokens</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;object-memory</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">300000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">actionTokens</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-servers</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rawValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.keycloak.cluster.infinispan.KeycloakHotRodMarshallerFactory<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.9<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add outbound socket binding for the remote store into <code>socket-binding-group</code> element configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${remote.cache.host:localhost}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${remote.cache.port:11222}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/outbound-socket-binding&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>The configuration of distributed cache <code>authenticationSessions</code> and other caches is left unchanged.</p>
</li>
<li>
<p>It is recommended to add the <code>remoteStoreSecurityEnabled</code> property with the value of <code>false</code> (or eventually <code>true</code> if you enabled security
for the Infinispan servers as described above) to the <code>connectionsInfinispan</code> SPI in the <code>keycloak-server</code> subsystem:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsInfinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;provider</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            ...
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteStoreSecurityEnabled</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    ...</code></pre>
</div>
</div>
</li>
<li>
<p>Optionally enable DEBUG logging under the <code>logging</code> subsystem:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.cluster.infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEBUG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span>
<span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.connections.infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEBUG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span>
<span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.models.cache.infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEBUG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span>
<span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.models.sessions.infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEBUG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the <code>NODE11</code> to 3 other directories referred later as <code>NODE12</code>, <code>NODE21</code> and <code>NODE22</code>.</p>
</li>
<li>
<p>Start <code>NODE11</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE11/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node11 -Djboss.site.name=site1 \
  -Djboss.default.multicast.address=234.56.78.1 -Dremote.cache.host=server1 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
</li>
<li>
<p>Start <code>NODE12</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE12/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node12 -Djboss.site.name=site1 \
  -Djboss.default.multicast.address=234.56.78.1 -Dremote.cache.host=server1 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster nodes should be connected. Something like this should be in the log of both NODE11 and NODE12:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node11|1] (2) [node11, node12]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The channel name in the log might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Start <code>NODE21</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE21/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node21 -Djboss.site.name=site2 \
  -Djboss.default.multicast.address=234.56.78.2 -Dremote.cache.host=server2 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>It shouldn&#8217;t be connected to the cluster with <code>NODE11</code> and <code>NODE12</code>, but to separate one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node21|0] (1) [node21]</code></pre>
</div>
</div>
</li>
<li>
<p>Start <code>NODE22</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd NODE22/bin
./standalone.sh -c standalone-ha.xml -Djboss.node.name=node22 -Djboss.site.name=site2 \
  -Djboss.default.multicast.address=234.56.78.2 -Dremote.cache.host=server2 \
  -Djava.net.preferIPv4Stack=true -b <em>PUBLIC_IP_ADDRESS</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>It should be in cluster with <code>NODE21</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Received new cluster view for channel keycloak: [node21|1] (2) [node21, node22]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The channel name in the log might be different.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Test:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Go to <code><a href="http://node11:8080/auth/" class="bare">http://node11:8080/auth/</a></code> and create the initial admin user.</p>
</li>
<li>
<p>Go to <code><a href="http://node11:8080/auth/admin" class="bare">http://node11:8080/auth/admin</a></code> and login as admin to admin console.</p>
</li>
<li>
<p>Open a second browser and go to any of nodes <code><a href="http://node12:8080/auth/admin" class="bare">http://node12:8080/auth/admin</a></code> or <code><a href="http://node21:8080/auth/admin" class="bare">http://node21:8080/auth/admin</a></code> or <code><a href="http://node22:8080/auth/admin" class="bare">http://node22:8080/auth/admin</a></code>. After login, you should be able to see
the same sessions in tab <code>Sessions</code> of particular user, client or realm on all 4 servers.</p>
</li>
<li>
<p>After doing any change in Keycloak admin console (eg. update some user or some realm), the update
should be immediately visible on any of 4 nodes as caches should be properly invalidated everywhere.</p>
</li>
<li>
<p>Check server.logs if needed. After login or logout, the message like this should be on all the nodes <code>NODEXY/standalone/log/server.log</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>2017-08-25 17:35:17,737 DEBUG [org.keycloak.models.sessions.infinispan.remotestore.RemoteCacheSessionListener] (Client-Listener-sessions-30012a77422542f5) Received event from remote store.
Event 'CLIENT_CACHE_ENTRY_REMOVED', key '193489e7-e2bc-4069-afe8-f1dfa73084ea', skip 'false'</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="administration"><a class="anchor" href="#administration"></a>Administration of cross-site deployment</h4>
<div class="paragraph">
<p>This section contains some tips and options related to cross-site replication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When you run the Keycloak server inside a data center, it is required that the database referenced in <code>KeycloakDS</code> datasource is already running and available in that data center. It is also necessary that the Infinispan server referenced by the <code>outbound-socket-binding</code>, which is referenced from the Infinispan cache <code>remote-store</code> element, is already running. Otherwise the Keycloak server will fail to start.</p>
</li>
<li>
<p>Every data center can have more database nodes if you want to support database failover and better reliability. Refer to the documentation of your database and JDBC driver for the details how to set this up on the database side and how the <code>KeycloakDS</code> datasource on Keycloak side needs to be configured.</p>
</li>
<li>
<p>Every datacenter can have more Infinispan servers running in the cluster. This is useful if you want some failover and better fault tolerance. The Hot Rod protocol used for communication between Infinispan servers and Keycloak servers has a feature that Infinispan servers will automatically send new topology to the Keycloak servers about the change in the Infinispan cluster, so the remote store on Keycloak side will know to which Infinispan servers it can connect. Read the Infinispan and WildFly documentation for more details.</p>
</li>
<li>
<p>It is highly recommended that a master Infinispan server is running in every site before the Keycloak servers in <strong>any</strong> site are started. As in our example, we started both <code>server1</code> and <code>server2</code> first, before all Keycloak servers. If you still need to run the Keycloak server and the backup site is offline, it is recommended to manually switch the backup site offline on the Infinispan servers on your site, as described in <a href="#onoffline">Bringing sites offline and online</a>. If you do not manually switch the unavailable site offline, the first startup may fail or they may be some exceptions during startup until the backup site is taken offline automatically due the configured count of failed operations.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="onoffline"><a class="anchor" href="#onoffline"></a>Bringing sites offline and online</h4>
<div class="paragraph">
<p>For example, assume this scenario:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Site <code>site2</code> is entirely offline from the <code>site1</code> perspective. This means that all Infinispan servers on <code>site2</code> are off <strong>or</strong> the network between <code>site1</code> and <code>site2</code> is broken.</p>
</li>
<li>
<p>You run Keycloak servers and Infinispan server <code>server1</code> in site <code>site1</code></p>
</li>
<li>
<p>Someone logs in on a Keycloak server on <code>site1</code>.</p>
</li>
<li>
<p>The Keycloak server from <code>site1</code> will try to write the session to the remote cache on <code>server1</code> server, which is supposed to backup data to the <code>server2</code> server in the <code>site2</code>. See <a href="#communication">Communication details</a> for more information.</p>
</li>
<li>
<p>Server <code>server2</code> is offline or unreachable from <code>server1</code>. So the backup from <code>server1</code> to <code>server2</code> will fail.</p>
</li>
<li>
<p>The exception is thrown in <code>server1</code> log and the failure will be propagated from <code>server1</code> server to Keycloak servers as well because the default <code>FAIL</code> backup failure policy is configured. See <a href="#backupfailure">Backup failure policy</a> for details around the backup policies.</p>
</li>
<li>
<p>The error will happen on Keycloak side too and user may not be able to finish his login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>According to your environment, it may be more or less probable that the network between sites is unavailable or temporarily broken (split-brain). In case this happens, it is good that Infinispan servers on <code>site1</code> are aware of the fact that Infinispan servers on <code>site2</code> are unavailable, so they will stop trying to reach the servers in the <code>server2</code> site and the backup failures won&#8217;t happen. This is called <code>Take site offline</code> .</p>
</div>
<div class="paragraph">
<div class="title">Take site offline</div>
<p>There are 2 ways to take the site offline.</p>
</div>
<div class="paragraph">
<p><strong>Manually by admin</strong> - Admin can use the <code>jconsole</code> or other tool and run some JMX operations to manually take the particular site offline.
This is useful especially if the outage is planned. With <code>jconsole</code> or CLI, you can connect to the <code>server1</code> server and take the <code>site2</code> offline.
More details about this are available in the
<a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html">Infinispan documentation</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
These steps usually need to be done for all the Keycloak caches mentioned in <a href="#backups">SYNC or ASYNC backups</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Automatically</strong> - After some amount of failed backups, the <code>site2</code> will usually be taken offline automatically. This is done due the configuration of <code>take-offline</code> element inside the cache configuration as configured in <a href="#jdgsetup">Setting up the Infinispan server</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;take-offline</span> <span class="attribute-name">min-wait</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">after-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows that the site will be taken offline automatically for the particular single cache if there are at least 3 subsequent failed backups and there is no any successful backup within 60 seconds.</p>
</div>
<div class="paragraph">
<p>Automatically taking a site offline is useful especially if the broken network between sites is unplanned. The disadvantage is that there will be some failed backups until the network outage is detected, which could also mean  failures on the application side.
For example, there will be failed logins for some users or big login timeouts. Especially if <code>failure-policy</code> with value <code>FAIL</code> is used.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The tracking of whether a site is offline is tracked separately for every cache.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Take site online</div>
<p>Once your network is back and <code>site1</code> and <code>site2</code> can talk to each other, you may need to put the site online. This needs to be done manually through JMX or CLI in similar way as taking a site offline.
Again, you may need to check all the caches and bring them online.</p>
</div>
<div class="paragraph">
<p>Once the sites are put online, it&#8217;s usually good to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do the <a href="#statetransfer">State transfer</a>.</p>
</li>
<li>
<p>Manually <a href="#clearcache">Clear caches</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="statetransfer"><a class="anchor" href="#statetransfer"></a>State transfer</h4>
<div class="paragraph">
<p>State transfer is a required, manual step. Infinispan server does not do this automatically, for example during split-brain, it is only the admin who may decide which site has preference and hence if state transfer needs to be done bidirectionally between both sites or just unidirectionally, as in only from <code>site1</code> to <code>site2</code>, but not from <code>site2</code> to <code>site1</code>.</p>
</div>
<div class="paragraph">
<p>A bidirectional state transfer will ensure that entities which were created <strong>after</strong> split-brain on <code>site1</code> will be transferred to <code>site2</code>. This is not an issue as they do not yet exist on <code>site2</code>. Similarly, entities created <strong>after</strong> split-brain on <code>site2</code> will be transferred to <code>site1</code>. Possibly problematic parts are those entities which exist <strong>before</strong> split-brain on both sites and which were updated during split-brain on both sites. When this happens, one of the sites will <strong>win</strong> and will overwrite the updates done during split-brain by the second site.</p>
</div>
<div class="paragraph">
<p>Unfortunately, there is no any universal solution to this. Split-brains and network outages are just state, which is usually impossible to be handled 100% correctly with 100% consistent data between sites. In the case of Keycloak, it typically is not a critical issue. In the worst case, users will need to re-login again to their clients, or have the improper count of loginFailures tracked for brute force protection. See the Infinispan/JGroups documentation for more tips how to deal with split-brain.</p>
</div>
<div class="paragraph">
<p>The state transfer can be also done on the Infinispan server side through JMX. The operation name is <code>pushState</code>. There are few other operations to monitor status, cancel push state, and so on.
More info about state transfer is available in the <a href="https://infinispan.org/docs/11.0.x/titles/xsite/xsite.html">Infinispan docs</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="clearcache"><a class="anchor" href="#clearcache"></a>Clear caches</h4>
<div class="paragraph">
<p>After split-brain it is safe to manually clear caches in the Keycloak admin console. This is because there might be some data changed in the database on <code>site1</code> and because of the event, that the cache should be invalidated wasn&#8217;t transferred during split-brain to <code>site2</code>. Hence Keycloak nodes on <code>site2</code> may still have some stale data in their caches.</p>
</div>
<div class="paragraph">
<p>To clear the caches, see <a href="https://www.keycloak.org/docs/latest/server_admin/#_clear-cache">Clearing Server Caches</a>.</p>
</div>
<div class="paragraph">
<p>When the network is back, it is sufficient to clear the cache just on one Keycloak node on any random site. The cache invalidation event will be sent to all the other Keycloak nodes in all sites. However, it needs to be done for all the caches (realms, users, keys). See <a href="https://www.keycloak.org/docs/latest/server_admin/#_clear-cache">Clearing Server Caches</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="tuningcache"><a class="anchor" href="#tuningcache"></a>Tuning the Infinispan cache configuration</h4>
<div class="paragraph">
<p>This section contains tips and options for configuring your JDG cache.</p>
</div>
<div id="backupfailure" class="paragraph">
<div class="title">Backup failure policy</div>
<p>By default, the configuration of backup <code>failure-policy</code> in the Infinispan cache configuration in the Infinispan <code>clustered.xml</code> file is configured as <code>FAIL</code>. You may change it to <code>WARN</code> or <code>IGNORE</code>, as you prefer.</p>
</div>
<div class="paragraph">
<p>The difference between <code>FAIL</code> and <code>WARN</code> is that when <code>FAIL</code> is used and the Infinispan server tries to back data up to the other site and the backup fails then the failure will be propagated back to the caller (the Keycloak server). The backup might fail because the second site is temporarily unreachable or there is a concurrent transaction which is trying to update same entity. In this case, the Keycloak server will then retry the operation a few times. However, if the retry fails, then the user might see the error after a longer timeout.</p>
</div>
<div class="paragraph">
<p>When using <code>WARN</code>, the failed backups are not propagated from the Infinispan server to the Keycloak server. The user won&#8217;t see the error and the failed backup will be just ignored. There will be a shorter timeout, typically 10 seconds as that&#8217;s the default timeout for backup. It can be changed by the attribute <code>timeout</code> of <code>backup</code> element. There won&#8217;t be retries. There will just be a WARNING message in the Infinispan server log.</p>
</div>
<div class="paragraph">
<p>The potential issue is, that in some cases, there may be just some a short network outage between sites, where the retry (usage of the <code>FAIL</code> policy) may help, so with <code>WARN</code> (without retry), there will be some data inconsistencies across sites. This can also happen if there is an attempt to update the same entity concurrently on both sites.</p>
</div>
<div class="paragraph">
<p>How bad are these inconsistencies? Usually only means that a user will need to re-authenticate.</p>
</div>
<div class="paragraph">
<p>When using the <code>WARN</code> policy, it may happen that the single-use cache, which is provided by the <code>actionTokens</code> cache and which handles that particular key is really single use, but may "successfully" write the same key twice. But, for example, the OAuth2 specification <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-10.5">mentions</a> that code must be single-use. With the <code>WARN</code> policy, this may not be strictly guaranteed and the same code could be written twice if there is an attempt to write it concurrently in both sites.</p>
</div>
<div class="paragraph">
<p>If there is a longer network outage or split-brain, then with both <code>FAIL</code> and <code>WARN</code>, the other site will be taken offline after some time and failures as described in <a href="#onoffline">Bringing sites offline and online</a>. With the default 1 minute timeout, it is usually 1-3 minutes until all the involved caches are taken offline. After that, all the operations will work fine from an end user perspective.
You only need to manually restore the site when it is back online as mentioned in <a href="#onoffline">Bringing sites offline and online</a>.</p>
</div>
<div class="paragraph">
<p>In summary, if you expect frequent, longer outages between sites and it is acceptable for you to have some data inconsistencies and a not 100% accurate single-use cache, but you never want end-users to see the errors and long timeouts, then switch to <code>WARN</code>.</p>
</div>
<div class="paragraph">
<p>The difference between <code>WARN</code> and <code>IGNORE</code> is, that with <code>IGNORE</code> warnings are not written in the Infinispan log. See more details in the Infinispan documentation.</p>
</div>
<div class="paragraph">
<div class="title">Lock acquisition timeout</div>
<p>The default configuration is using transaction in NON_DURABLE_XA mode with acquire timeout 0. This means that transaction will fail-fast if there is another transaction in progress for the same key.</p>
</div>
<div class="paragraph">
<p>The reason to switch this to 0 instead of default 10 seconds was to avoid possible deadlock issues. With Keycloak, it can happen that the same entity (typically session entity or loginFailure) is updated concurrently from both sites. This can cause deadlock under some circumstances, which will cause the transaction to be blocked for 10 seconds. See <a href="https://issues.redhat.com/browse/JDG-1318">this JIRA report</a> for details.</p>
</div>
<div class="paragraph">
<p>With timeout 0, the transaction will immediately fail and then will be retried from Keycloak if backup <code>failure-policy</code> with the value <code>FAIL</code> is configured. As long as the second concurrent transaction is finished, the retry will usually be successful and the entity will have applied updates from both concurrent transactions.</p>
</div>
<div class="paragraph">
<p>We see very good consistency and results for concurrent transaction with this configuration, and it is recommended to keep it.</p>
</div>
<div class="paragraph">
<p>The only (non-functional) problem is the exception in the Infinispan server log, which happens every time when the lock is not immediately available.</p>
</div>
</div>
<div class="sect3">
<h4 id="backups"><a class="anchor" href="#backups"></a>SYNC or ASYNC backups</h4>
<div class="paragraph">
<p>An important part of the <code>backup</code> element is the <code>strategy</code> attribute. You must decide whether it needs to be <code>SYNC</code> or <code>ASYNC</code>. We have 7 caches which might be cross-site replication aware, and these can be configured in 3 different modes regarding cross-site:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SYNC backup</p>
</li>
<li>
<p>ASYNC backup</p>
</li>
<li>
<p>No backup at all</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the <code>SYNC</code> backup is used, then the backup is synchronous and operation is considered finished on the caller (Keycloak server) side once the backup is processed on the second site. This has worse performance than <code>ASYNC</code>, but on the other hand, you are sure that subsequent reads of the particular entity, such as user session, on <code>site2</code> will see the updates from <code>site1</code>. Also, it is needed if you want data consistency. As with <code>ASYNC</code> the caller is not notified at all if backup to the other site failed.</p>
</div>
<div class="paragraph">
<p>For some caches, it is even possible to not backup at all and completely skip writing data to the Infinispan server. To set this up, do not use the <code>remote-store</code> element for the particular cache on the Keycloak side (file <code>KEYCLOAK_HOME/standalone/configuration/standalone-ha.xml</code>) and then the particular <code>replicated-cache</code> element is also not needed on the Infinispan server side.</p>
</div>
<div class="paragraph">
<p>By default, all 7 caches are configured with <code>SYNC</code> backup, which is the safest option. Here are a few things to consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you are using active/passive mode (all Keycloak servers are in single site <code>site1</code> and the Infinispan server in <code>site2</code> is used purely as backup. See <a href="#modes">Modes</a> for more details), then it is usually fine to use <code>ASYNC</code> strategy for all the caches to save the performance.</p>
</li>
<li>
<p>The <code>work</code> cache is used mainly to send some messages, such as cache invalidation events, to the other site. It is also used to ensure that some special events, such as userStorage synchronizations, happen only on single site. It is recommended to keep this set to <code>SYNC</code>.</p>
</li>
<li>
<p>The <code>actionTokens</code> cache is used as single-use cache to track that some tokens/tickets were used just once. For example action tokens or OAuth2 codes. It is possible to set this to <code>ASYNC</code> to slightly improved performance, but then it is not guaranteed that particular ticket is really single-use. For example, if there is concurrent request for same ticket in both sites, then it is possible that both requests will be successful with the <code>ASYNC</code> strategy. So what you set here will depend on whether you prefer better security (<code>SYNC</code> strategy) or better performance (<code>ASYNC</code> strategy).</p>
</li>
<li>
<p>The <code>loginFailures</code> cache may be used in any of the 3 modes. If there is no backup at all, it means that count of login failures for a user will be counted separately for every site (See <a href="#cache">Infinispan caches</a> for details). This has some security implications, however it has some performance advantages. Also it mitigates the possible risk of denial of service (DoS) attacks. For example, if an attacker simulates 1000 concurrent requests using the username and password of the user on both sites, it will mean lots of messages being passed between the sites, which may result in network congestion. The <code>ASYNC</code> strategy might be even worse as the attacker requests won&#8217;t be blocked by waiting for the backup to the other site, resulting in potentially even more congested network traffic.
The count of login failures also will not be accurate with the <code>ASYNC</code> strategy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the environments with slower network between data centers and probability of DoS, it is recommended to not backup the <code>loginFailures</code> cache at all.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is recommended to keep the <code>sessions</code> and <code>clientSessions</code> caches in <code>SYNC</code>. Switching them to <code>ASYNC</code> is possible only if you are sure that user requests and backchannel requests (requests from client applications to Keycloak as described in <a href="#requestprocessing">Request processing</a>) will be always processed on same site. This is true, for example, if:</p>
<div class="ulist">
<ul>
<li>
<p>You use active/passive mode as described <a href="#modes">Modes</a>.</p>
</li>
<li>
<p>All your client applications are using the Keycloak <a href="https://www.keycloak.org/docs/latest/securing_apps/#_javascript_adapter">JavaScript Adapter</a>. The JavaScript adapter sends the backchannel requests within the browser and hence they participate on the browser sticky session and will end on same cluster node (hence on same site) as the other browser requests of this user.</p>
</li>
<li>
<p>Your load balancer is able to serve the requests based on client IP address (location) and the client applications are deployed on both sites.</p>
<div class="paragraph">
<p>For example you have 2 sites LON and NYC. As long as your applications are deployed in both LON and NYC sites too, you can ensure that all the user requests from London users will be redirected to the applications in LON site and also to the Keycloak servers in LON site. Backchannel requests from the LON site client deployments will end on Keycloak servers in LON site too. On the other hand, for the American users, all the Keycloak requests, application requests and backchannel requests will be processed on NYC site.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>For <code>offlineSessions</code> and <code>offlineClientSessions</code> it is similar, with the difference that you even don&#8217;t need to backup them at all if you never plan to use offline tokens for any of your client applications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, if you are in doubt and performance is not a blocker for you, it&#8217;s safer to keep the caches in <code>SYNC</code> strategy.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Regarding the switch to SYNC/ASYNC backup, make sure that you edit the <code>strategy</code> attribute of the <code>backup</code> element. For example like this:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">site2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ASYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>mode</code> attribute of cache-configuration element.</p>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>Troubleshooting</h4>
<div class="paragraph">
<p>The following tips are intended to assist you should you need to troubleshoot:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is recommended to go through the <a href="#setup">Setting up cross-site replication with Infinispan 9.4.19</a> and have this one working first, so that you have some understanding of how things work. It is also wise to read this entire document to have some understanding of things.</p>
</li>
<li>
<p>Check in jconsole cluster status (GMS) and the JGroups status (RELAY) of Infinispan as described in <a href="#jdgsetup">Setting up the Infinispan server</a>. If things do not look as expected, then the issue is likely in the setup of Infinispan servers.</p>
</li>
<li>
<p>For the Keycloak servers, you should see a message like this during the server startup:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>18:09:30,156 INFO  [org.keycloak.connections.infinispan.DefaultInfinispanConnectionProviderFactory] (ServerService Thread Pool -- 54)
Node name: node11, Site name: site1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the site name and the node name looks as expected during the startup of Keycloak server.</p>
</div>
</li>
<li>
<p>Check that Keycloak servers are in cluster as expected, including that only the Keycloak servers from the same data center are in cluster with each other.
This can be also checked in JConsole through the GMS view. See <a href="https://www.keycloak.org/docs/latest/server_installation/#troubleshooting">cluster troubleshooting</a> for additional details.</p>
</li>
<li>
<p>If there are exceptions during startup of Keycloak server like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>17:33:58,605 ERROR [org.infinispan.client.hotrod.impl.operations.RetryOnFailureOperation] (ServerService Thread Pool -- 59) ISPN004007: Exception encountered. Retry 10 out of 10: org.infinispan.client.hotrod.exceptions.TransportException:: Could not fetch transport
...
Caused by: org.infinispan.client.hotrod.exceptions.TransportException:: Could not connect to server: 127.0.0.1:12232
	at org.infinispan.client.hotrod.impl.transport.tcp.TcpTransport.&lt;init&gt;(TcpTransport.java:82)</code></pre>
</div>
</div>
<div class="paragraph">
<p>it usually means that Keycloak server is not able to reach the Infinispan server in his own datacenter. Make sure that firewall is set as expected and Infinispan server is possible to connect.</p>
</div>
</li>
<li>
<p>If there are exceptions during startup of Keycloak server like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>16:44:18,321 WARN  [org.infinispan.client.hotrod.impl.protocol.Codec21] (ServerService Thread Pool -- 57) ISPN004005: Error received from the server: javax.transaction.RollbackException: ARJUNA016053: Could not commit transaction.
 ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>then check the log of corresponding Infinispan server of your site and check if has failed to backup to the other site. If the backup site is unavailable, then it is recommended to switch it offline, so that Infinispan server won&#8217;t try to backup to the offline site causing the operations to pass successfully on Keycloak server side as well. See <a href="#administration">Administration of cross-site deployment</a> for more information.</p>
</div>
</li>
<li>
<p>Check the Infinispan statistics, which are available through JMX. For example, try to login and then see if the new session was successfully written to both Infinispan servers and is available in the <code>sessions</code> cache there. This can be done indirectly by checking the count of elements in the <code>sessions</code> cache for the MBean <code>jboss.datagrid-infinispan:type=Cache,name="sessions(repl_sync)",manager="clustered",component=Statistics</code> and attribute <code>numberOfEntries</code>. After login, there should be one more entry for <code>numberOfEntries</code> on both Infinispan servers on both sites.</p>
</li>
<li>
<p>Enable DEBUG logging as described <a href="#serversetup">Setting up Keycloak servers</a>. For example, if you log in and you think that the new session is not available on the second site, it&#8217;s good to check the Keycloak server logs and check that listeners were triggered as described in the <a href="#serversetup">Setting up Keycloak servers</a>. If you do not know and want to ask on keycloak-user mailing list, it is helpful to send the log files from Keycloak servers on both datacenters in the email. Either add the log snippets to the mails or put the logs somewhere and reference them in the email.</p>
</li>
<li>
<p>If you updated the entity, such as <code>user</code>, on Keycloak server on <code>site1</code> and you do not see that entity updated on the Keycloak server on <code>site2</code>, then the issue can be either in the replication of the synchronous database itself or that Keycloak caches are not properly invalidated. You may try to temporarily disable the Keycloak caches as described <a href="https://www.keycloak.org/docs/latest/server_installation/#disabling-caching">here</a> to nail down if the issue is at the database replication level. Also it may help to manually connect to the database and check if data are updated as expected. This is specific to every database, so you will need to consult the documentation for your database.</p>
</li>
<li>
<p>Sometimes you may see the exceptions related to locks like this in Infinispan server log:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>(HotRodServerHandler-6-35) ISPN000136: Error executing command ReplaceCommand,
writing keys [[B0x033E243034396234..[39]]: org.infinispan.util.concurrent.TimeoutException: ISPN000299: Unable to acquire lock after
0 milliseconds for key [B0x033E243034396234..[39] and requestor GlobalTx:server1:4353. Lock is held by GlobalTx:server1:4352</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those exceptions are not necessarily an issue. They may happen anytime when a concurrent edit of the same entity is triggered on both DCs. This is common in a deployment. Usually the Keycloak server is notified about the failed operation and will retry it, so from the user&#8217;s point of view, there is usually not any issue.</p>
</div>
</li>
<li>
<p>If there are exceptions during startup of Keycloak server, like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>16:44:18,321 WARN  [org.infinispan.client.hotrod.impl.protocol.Codec21] (ServerService Thread Pool -- 55) ISPN004005: Error received from the server: java.lang.SecurityException: ISPN000287: Unauthorized access: subject 'Subject with principal(s): []' lacks 'READ' permission
 ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>These log entries are the result of Keycloak automatically detecting whether authentication is required on Infinispan and
mean that authentication is necessary. At this point you will notice that either the server starts successfully and you can safely
ignore these or that the server fails to start. If the server fails to start, ensure that Infinispan has been configured
properly for authentication as described in <a href="#jdgsetup">Setting up the Infinispan server</a>. To prevent this log entry from being included, you can force authentication
by setting <code>remoteStoreSecurityEnabled</code> property to <code>true</code> in <code>spi=connectionsInfinispan/provider=default</code> configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsInfinispan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;properties&gt;</span>
                ...
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteStoreSecurityEnabled</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/properties&gt;</span>
        <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>If you try to authenticate with Keycloak to your application, but authentication fails with an infinite number
of redirects in your browser and you see the errors like this in the Keycloak server log:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>2017-11-27 14:50:31,587 WARN  [org.keycloak.events] (default task-17) type=LOGIN_ERROR, realmId=master, clientId=null, userId=null, ipAddress=aa.bb.cc.dd, error=expired_code, restart_after_timeout=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>it probably means that your load balancer needs to be set to support sticky sessions. Make sure that the provided route name used during startup of Keycloak server (Property <code>jboss.node.name</code>) contains the correct name used by the load balancer server to identify the current server.</p>
</div>
</li>
<li>
<p>If the Infinispan <code>work</code> cache grows indefinitely, you may be experiencing <a href="https://issues.redhat.com/browse/JDG-987">this Infinispan issue</a>,
which is caused by cache items not being properly expired. In that case, update the cache declaration with an empty <code>&lt;expiration /&gt;</code> tag like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions-cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;expiration</span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>If you see Warnings in the Infinispan server log like:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>18:06:19,687 WARN  [org.infinispan.server.hotrod.Decoder2x] (HotRod-ServerWorker-7-12) ISPN006011: Operation 'PUT_IF_ABSENT' forced to
  return previous value should be used on transactional caches, otherwise data inconsistency issues could arise under failure situations
18:06:19,700 WARN  [org.infinispan.server.hotrod.Decoder2x] (HotRod-ServerWorker-7-10) ISPN006010: Conditional operation 'REPLACE_IF_UNMODIFIED' should
  be used with transactional caches, otherwise data inconsistency issues could arise under failure situations</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can just ignore them. To avoid the warning, the caches on Infinispan server side could be changed to transactional caches, but this is not recommended as it can cause some
other issues caused by the bug <a href="https://issues.redhat.com/browse/ISPN-9323" class="bare">https://issues.redhat.com/browse/ISPN-9323</a>. So for now, the warnings just need to be ignored.</p>
</div>
</li>
<li>
<p>If you see errors in the Infinispan server log like:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>12:08:32,921 ERROR [org.infinispan.server.hotrod.CacheDecodeContext] (HotRod-ServerWorker-7-11) ISPN005003: Exception reported: org.infinispan.server.hotrod.InvalidMagicIdException: Error reading magic byte or message id: 7
	at org.infinispan.server.hotrod.HotRodDecoder.readHeader(HotRodDecoder.java:184)
	at org.infinispan.server.hotrod.HotRodDecoder.decodeHeader(HotRodDecoder.java:133)
	at org.infinispan.server.hotrod.HotRodDecoder.decode(HotRodDecoder.java:92)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:411)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:248)</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you see some similar errors in the Keycloak log, it can indicate that there are incompatible versions of the Hot Rod protocol being used.
This is likely happen when you try to use Keycloak with an old version of the Infinispan server. It
will help if you add the <code>protocolVersion</code> property as an additional property to the <code>remote-store</code> element in the Keycloak
configuration file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">protocolVersion</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2.6<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-the-subsystem-configuration"><a class="anchor" href="#managing-the-subsystem-configuration"></a>Managing the subsystem configuration</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/config-subsystem.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/config-subsystem.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Low-level configuration of Keycloak is done by editing the
 <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file
in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="paragraph">
<p>While there are endless settings you can configure here, this section will focus on
configuration of the <em>keycloak-server</em> subsystem.  No matter which configuration file
you are using, configuration of the <em>keycloak-server</em> subsystem is the same.</p>
</div>
<div class="paragraph">
<p>The keycloak-server subsystem is typically declared toward the end of the file like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;web-context&gt;</span>auth<span class="tag">&lt;/web-context&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that anything changed in this subsystem will not take effect until the server is rebooted.</p>
</div>
<div class="sect2">
<h3 id="_config_spi_providers"><a class="anchor" href="#_config_spi_providers"></a>Configure SPI providers</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/config-subsystem/configure-spi-providers.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/config-subsystem/configure-spi-providers.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The specifics of each configuration setting is discussed elsewhere in
context with that setting.  However, it is useful to understand the format used
to declare settings on SPI providers.</p>
</div>
<div class="paragraph">
<p>Keycloak is a highly modular system that allows great
flexibility.  There are more than 50 service provider interfaces (SPIs), and
you are allowed to swap out implementations of each SPI.  An implementation of
an SPI is known as a <em>provider</em>.</p>
</div>
<div class="paragraph">
<p>All elements in an SPI declaration are optional, but a full SPI declaration
 looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myspi</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>myprovider<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myprovider</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mysecondprovider</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have two providers defined for the SPI <code>myspi</code>.  The <code>default-provider</code>
is listed as <code>myprovider</code>.  However it is up to the SPI to decide how it will treat
this setting.  Some SPIs allow more than one provider and some do not.  So
<code>default-provider</code> can help the SPI to choose.</p>
</div>
<div class="paragraph">
<p>Also notice that each provider defines its own set of configuration properties.
The fact that both providers above have a property called <code>foo</code> is just a
coincidence.</p>
</div>
<div class="paragraph">
<p>The type of each property value is interpreted by the provider.  However, there
is one exception.  Consider the <code>jpa</code> provider for the <code>eventsStore</code> SPI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exclude-events</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="entity">&amp;quot;</span><span class="content">EVENT1</span><span class="entity">&amp;quot;</span><span class="content">,</span>
                                                    <span class="entity">&amp;quot;</span><span class="content">EVENT2</span><span class="entity">&amp;quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the value begins and ends with square brackets.  That means that
the value will be passed to the provider as a list.  In this example, the system will pass the
provider a list with two element values <em>EVENT1</em> and <em>EVENT2</em>. To add more values
to the list, just separate each list element with a comma. Unfortunately,
you do need to escape the quotes surrounding each list element with <code>&amp;quot;</code>.</p>
</div>
<div class="paragraph">
<p>Follow the steps in <a href="https://www.keycloak.org/docs/latest/server_development/#_providers">Server Developer Guide</a> for more details on custom providers and the configuration of providers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_start_cli"><a class="anchor" href="#_start_cli"></a>Starting the WildFly CLI</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/config-subsystem/start-cli.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/config-subsystem/start-cli.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Besides editing the configuration by hand, you also have the option of changing
the configuration by issuing commands via the <em>jboss-cli</em> tool.  CLI allows
you to configure servers locally or remotely.  And it is especially useful when
combined with scripting.</p>
</div>
<div class="paragraph">
<p>To start the WildFly CLI, you need to run <code>jboss-cli</code>.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\jboss-cli.bat</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will bring you to a prompt like this:</p>
</div>
<div class="listingblock">
<div class="title">Prompt</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wish to execute commands on a running server, you will first
execute the <code>connect</code> command.</p>
</div>
<div class="listingblock">
<div class="title">connect</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /] connect
connect
[standalone@localhost:9990 /]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be thinking to yourself, "I didn&#8217;t enter in any username or password!".  If you run <code>jboss-cli</code> on the same machine
as your running standalone server or domain controller and your account has appropriate file permissions, you do not have
to setup or enter in an admin username and password.  See the <a href="http://docs.wildfly.org/23/Admin_Guide.html"><em>WildFly 23 Documentation</em></a>
for more details on how to make things more secure if you are uncomfortable with that setup.</p>
</div>
</div>
<div class="sect2">
<h3 id="cli-embedded-mode"><a class="anchor" href="#cli-embedded-mode"></a>CLI embedded mode</h3>
<div class="paragraph">
<p>If you do happen to be on the same machine as your standalone server and you want to
issue commands while the server is not active, you can embed the server into CLI and make
changes in a special mode that disallows incoming requests.  To do this, first
execute the <code>embed-server</code> command with the config file you wish to change.</p>
</div>
<div class="listingblock">
<div class="title">embed-server</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /] embed-server --server-config=standalone.xml
[standalone@embedded /]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-cli-gui-mode"><a class="anchor" href="#using-cli-gui-mode"></a>Using CLI GUI mode</h3>
<div class="paragraph">
<p>The CLI can also run in GUI mode.  GUI mode launches a Swing application that
allows you to graphically view and edit the entire management model of a <em>running</em> server.
GUI mode is especially useful when you need help formatting your CLI commands and learning
about the options available.  The GUI can also retrieve server logs from a local or
remote server.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Start the CLI in GUI mode</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh --gui</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: to connect to a remote server, you pass the <code>--connect</code> option as well.
Use the --help option for more details.</p>
</div>
</li>
<li>
<p>Scroll down to find the node <code>subsystem=keycloak-server</code>.</p>
</li>
<li>
<p>Right-click the node and select <code>Explore subsystem=keycloak-server</code>.</p>
<div class="paragraph">
<p>A new tab displays only the keycloak-server subsystem.</p>
</div>
<div class="paragraph">
<div class="title">keycloak-server subsystem</div>
<p><span class="image"><img src="./images/cli-gui.png" alt="keycloak-server subsystem"></span></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cli-scripting"><a class="anchor" href="#cli-scripting"></a>CLI scripting</h3>
<div class="paragraph">
<p>The CLI has extensive scripting capabilities.  A script is just a text
file with CLI commands in it.  Consider a simple script that turns off theme
and template caching.</p>
</div>
<div class="listingblock">
<div class="title">turn-off-caching.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheThemes,value=false)
/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheTemplates,value=false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute the script, you can follow the <code>Scripts</code> menu in CLI GUI, or execute the
script from the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh --file=turn-off-caching.cli</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cli_recipes"><a class="anchor" href="#_cli_recipes"></a>CLI recipes</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/config-subsystem/cli-recipes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/config-subsystem/cli-recipes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Here are some configuration tasks and how to perform them with CLI commands.
Note that in all but the first example, we use the wildcard path <code>**</code> to mean
you should substitute or the path to the keycloak-server subsystem.</p>
</div>
<div class="paragraph">
<p>For standalone, this just means:</p>
</div>
<div class="paragraph">
<p><code>**</code> = <code>/subsystem=keycloak-server</code></p>
</div>
<div class="paragraph">
<p>For domain mode, this would mean something like:</p>
</div>
<div class="paragraph">
<p><code>**</code> = <code>/profile=auth-server-clustered/subsystem=keycloak-server</code></p>
</div>
<div class="sect3">
<h4 id="changing-the-web-context-of-the-server"><a class="anchor" href="#changing-the-web-context-of-the-server"></a>Changing the web context of the server</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=keycloak-server/:write-attribute(name=web-context,value=myContext)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setting-the-global-default-theme"><a class="anchor" href="#setting-the-global-default-theme"></a>Setting the global default theme</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/theme=defaults/:write-attribute(name=default,value=myTheme)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="adding-a-new-spi-and-a-provider"><a class="anchor" href="#adding-a-new-spi-and-a-provider"></a>Adding a new SPI and a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/:add
**/spi=mySPI/provider=myProvider/:add(enabled=true)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="disabling-a-provider"><a class="anchor" href="#disabling-a-provider"></a>Disabling a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/provider=myProvider/:write-attribute(name=enabled,value=false)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="changing-the-default-provider-for-an-spi"><a class="anchor" href="#changing-the-default-provider-for-an-spi"></a>Changing the default provider for an SPI</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/:write-attribute(name=default-provider,value=myProvider)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-dblock-spi"><a class="anchor" href="#configuring-the-dblock-spi"></a>Configuring the dblock SPI</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/:add(default-provider=jpa)
**/spi=dblock/provider=jpa/:add(properties={lockWaitTimeout =&gt; "900"},enabled=true)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="adding-or-changing-a-single-property-value-for-a-provider"><a class="anchor" href="#adding-or-changing-a-single-property-value-for-a-provider"></a>Adding or changing a single property value for a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/provider=jpa/:map-put(name=properties,key=lockWaitTimeout,value=3)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remove-a-single-property-from-a-provider"><a class="anchor" href="#remove-a-single-property-from-a-provider"></a>Remove a single property from a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/provider=jpa/:map-remove(name=properties,key=lockRecheckTime)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setting-values-on-a-provider-property-of-type-code-list-code"><a class="anchor" href="#setting-values-on-a-provider-property-of-type-code-list-code"></a>Setting values on a provider property of type <code>List</code></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=eventsStore/provider=jpa/:map-put(name=properties,key=exclude-events,value=[EVENT1,EVENT2])</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="profiles"><a class="anchor" href="#profiles"></a>Profiles</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/profiles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/profiles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are features in Keycloak that are not enabled by default, these include features that are not fully
supported. In addition there are some features that are enabled by default, but that can be disabled.</p>
</div>
<div class="paragraph">
<p>The features that can be enabled and disabled are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Enabled by default</th>
<th class="tableblock halign-left valign-top">Support level</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">account2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New Account Management Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">account_api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account Management REST API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin_fine_grained_authz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fine-Grained Admin Permissions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ciba</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenID Connect Client Initiated Backchannel Authentication (CIBA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client_policies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add client configuration policies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client_secret_rotation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables client secret rotation for confidential clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">par</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth 2.0 Pushed Authorization Requests (PAR)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">declarative_user_profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure user profiles using a declarative style</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker Registry protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">impersonation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ability for admins to impersonate users</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openshift_integration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extension to enable securing OpenShift</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recovery_codes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recovery codes for authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write custom authenticators using JavaScript</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">step_up_authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step-up authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">token_exchange</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token Exchange Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">upload_scripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Upload scripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">web_authn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">W3C Web Authentication (WebAuthn)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To enable all preview features start the server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh|bat -Dkeycloak.profile=preview</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can set this permanently by creating the file <code>standalone/configuration/profile.properties</code>
(or <code>domain/servers/server-one/configuration/profile.properties</code> for <code>server-one</code> in domain mode). Add the following to
the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>profile=preview</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable a specific feature start the server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example to enable Docker use <code>-Dkeycloak.profile.feature.docker=enabled</code>.</p>
</div>
<div class="paragraph">
<p>You can set this permanently in the <code>profile.properties</code> file by adding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>feature.docker=enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>To disable a specific feature start the server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example to disable Impersonation use <code>-Dkeycloak.profile.feature.impersonation=disabled</code>.</p>
</div>
<div class="paragraph">
<p>You can set this permanently in the <code>profile.properties</code> file by adding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>feature.impersonation=disabled</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database"><a class="anchor" href="#_database"></a>Setting up the relational database</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak comes with its own embedded Java-based relational database called H2.
This is the default database that Keycloak will use to persist data and really only exists so that you can run the authentication
server out of the box.  We highly recommend that you replace it with a more production ready external database.  The H2 database
is not very viable in high concurrency situations and should not be used in a cluster either.  The purpose of this chapter is to
show you how to connect Keycloak to a more mature database.</p>
</div>
<div class="paragraph">
<p>Keycloak uses two layered technologies to persist its relational data.  The bottom layered technology is JDBC.  JDBC
is a Java API that is used to connect to a RDBMS.  There are different JDBC drivers per database type that are provided
by your database vendor.  This chapter discusses how to configure Keycloak to use one of these vendor-specific drivers.</p>
</div>
<div class="paragraph">
<p>The top layered technology for persistence is Hibernate JPA.  This is an object to relational mapping API that maps Java
Objects to relational data.  Most deployments of Keycloak will never have to touch the configuration aspects
of Hibernate, but we will discuss how that is done if you run into that rare circumstance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Datasource configuration is covered much more thoroughly in <a href="http://docs.wildfly.org/23/Admin_Guide.html#DataSource">the datasource configuration chapter</a>
       in the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_rdbms-setup-checklist"><a class="anchor" href="#_rdbms-setup-checklist"></a>Database setup checklist</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database/checklist.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database/checklist.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Following are the steps you perform to get an RDBMS configured for Keycloak.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate and download a JDBC driver for your database</p>
</li>
<li>
<p>Package the driver JAR into a module and install this module into the server</p>
</li>
<li>
<p>Declare the JDBC driver in the configuration profile of the server</p>
</li>
<li>
<p>Modify the datasource configuration to use your database&#8217;s JDBC driver</p>
</li>
<li>
<p>Modify the datasource configuration to define the connection parameters to your database</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This chapter will use PostgresSQL for all its examples.  Other databases follow the same steps for installation.</p>
</div>
</div>
<div class="sect2">
<h3 id="packaging-the-jdbc-driver"><a class="anchor" href="#packaging-the-jdbc-driver"></a>Packaging the JDBC driver</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database/jdbc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database/jdbc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Find and download the JDBC driver JAR for your RDBMS. Before you can use this driver, you must package it up into a module and install it into the server. Modules define JARs that are loaded into the Keycloak classpath and the dependencies those JARs have on other modules.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a directory structure to hold your module definition within the <em>&#8230;&#8203;/modules/</em> directory of your Keycloak distribution.</p>
<div class="paragraph">
<p>The convention is use the Java package name of the JDBC driver for the name of the directory structure. For PostgreSQL, create the directory <em>org/postgresql/main</em>.</p>
</div>
</li>
<li>
<p>Copy your database driver JAR into this directory and create an empty <em>module.xml</em> file within it too.</p>
<div class="paragraph">
<div class="title">Module Directory</div>
<p><span class="image"><img src="./keycloak-images/db-module.png" alt="Module Directory"></span></p>
</div>
</li>
<li>
<p>Open up the <em>module.xml</em> file and create the following XML:</p>
<div class="listingblock">
<div class="title">Module XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;module</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:module:1.3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.postgresql</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;resources&gt;</span>
        <span class="tag">&lt;resource-root</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postgresql-VERSION.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/resources&gt;</span>

    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.transaction.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The module name should match the directory structure of your module. So, <em>org/postgresql</em> maps to <code>org.postgresql</code>.</p>
</li>
<li>
<p>The <code>resource-root path</code> attribute should specify the JAR filename of the driver.</p>
</li>
<li>
<p>The rest are just the normal dependencies that any JDBC driver JAR would have.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="declaring-and-loading-the-jdbc-driver"><a class="anchor" href="#declaring-and-loading-the-jdbc-driver"></a>Declaring and loading the JDBC driver</h3>
<div class="paragraph">
<p>You declare your JDBC into your deployment profile so that it loads and becomes available when the server boots up.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>You have packaged the JDBC driver.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Declare your JDBC driver by editing one of these files based on your deployment mode:</p>
<div class="ulist">
<ul>
<li>
<p>For standalone mode, edit <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.</p>
</li>
<li>
<p>For standalone clustering mode, edit <em>&#8230;&#8203;/standalone/configuration/standalone-ha.xml</em>.</p>
</li>
<li>
<p>For domain mode, edit <em>&#8230;&#8203;/domain/configuration/domain.xml</em>.</p>
<div class="paragraph">
<p>In domain mode, make sure you edit the profile you are using: either <code>auth-server-standalone</code> or <code>auth-server-clustered</code></p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Within the profile, search for the <code>drivers</code> XML block within the <code>datasources</code> subsystem.</p>
<div class="paragraph">
<p>You should see a pre-defined driver declared for the H2 JDBC driver. This is where you&#8217;ll declare the JDBC driver for your external database.</p>
</div>
<div class="listingblock">
<div class="title">JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:6.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;drivers&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">h2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.h2database.h2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.h2.jdbcx.JdbcDataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
       <span class="tag">&lt;/drivers&gt;</span>
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Within the <code>drivers</code> XML block, declare an additional JDBC driver.</p>
<div class="ulist">
<ul>
<li>
<p>Assign any <code>name</code> to this driver.</p>
</li>
<li>
<p>Specify the <code>module</code> attribute which points to the <code>module</code> package that you created earlier for the driver JAR.</p>
</li>
<li>
<p>Specify the driver&#8217;s Java class.</p>
<div class="paragraph">
<p>Here&#8217;s an example of installing a PostgreSQL driver that lives in the module example defined earlier in this chapter.</p>
</div>
<div class="listingblock">
<div class="title">Declare Your JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:6.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;drivers&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postgresql</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.postgresql</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.postgresql.xa.PGXADataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">h2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.h2database.h2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.h2.jdbcx.JdbcDataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
       <span class="tag">&lt;/drivers&gt;</span>
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="modifying-the-keycloak-datasource"><a class="anchor" href="#modifying-the-keycloak-datasource"></a>Modifying the Keycloak datasource</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database/datasource.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database/datasource.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You modify the existing datasource configuration that Keycloak uses
to connect it to your new external database.  You&#8217;ll do
this within the same configuration file and XML block that you registered your JDBC driver in.  Here&#8217;s an example
that sets up the connection to your new database:</p>
</div>
<div class="listingblock">
<div class="title">Declare Your JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:6.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;datasource</span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/KeycloakDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">KeycloakDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">use-java-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           <span class="tag">&lt;connection-url&gt;</span>jdbc:postgresql://localhost/keycloak<span class="tag">&lt;/connection-url&gt;</span>
           <span class="tag">&lt;driver&gt;</span>postgresql<span class="tag">&lt;/driver&gt;</span>
           <span class="tag">&lt;pool&gt;</span>
               <span class="tag">&lt;max-pool-size&gt;</span>20<span class="tag">&lt;/max-pool-size&gt;</span>
           <span class="tag">&lt;/pool&gt;</span>
           <span class="tag">&lt;security&gt;</span>
               <span class="tag">&lt;user-name&gt;</span>William<span class="tag">&lt;/user-name&gt;</span>
               <span class="tag">&lt;password&gt;</span>password<span class="tag">&lt;/password&gt;</span>
           <span class="tag">&lt;/security&gt;</span>
       <span class="tag">&lt;/datasource&gt;</span>
        ...
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have already declared your JDBC driver.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Search for the <code>datasource</code> definition for <code>KeycloakDS</code>.</p>
<div class="paragraph">
<p>You&#8217;ll first need to modify the <code>connection-url</code>.  The
documentation for your vendor&#8217;s JDBC implementation should specify the format for this connection URL value.</p>
</div>
</li>
<li>
<p>Define the <code>driver</code> you will use.</p>
<div class="paragraph">
<p>This is the logical name of the JDBC driver you declared in the previous section of this
chapter.</p>
</div>
<div class="paragraph">
<p>It is expensive to open a new connection to a database every time you want to perform a transaction.  To compensate, the datasource
implementation maintains a pool of open connections.  The <code>max-pool-size</code> specifies the maximum number of connections it will pool.
You may want to change the value of this depending on the load of your system.</p>
</div>
</li>
<li>
<p>Define the database username and password that is needed to connect to the database.  This step is necessary for at least PostgreSQL. You may be concerned that these credentials are in clear text in the example. Methods exist to obfuscate these credentials, but these methods are beyond the scope of this guide.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about datasource features, see <a href="http://docs.wildfly.org/23/Admin_Guide.html#DataSource">the datasource configuration chapter</a> in the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="database-configuration"><a class="anchor" href="#database-configuration"></a>Database Configuration</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database/hibernate.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database/hibernate.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The configuration for this component is found in the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution. The location of this file depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="title">Database Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsJpa</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;properties&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/KeycloakDS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">initializeEmpty</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrationStrategy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">manual</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrationExport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/keycloak-database-update.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/properties&gt;</span>
     <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">dataSource</dt>
<dd>
<p>JNDI name of the dataSource</p>
</dd>
<dt class="hdlist1">jta</dt>
<dd>
<p>boolean property to specify if datasource is JTA capable</p>
</dd>
<dt class="hdlist1">driverDialect</dt>
<dd>
<p>Value of database dialect.
In most cases you don&#8217;t need to specify this property as dialect will be autodetected by Hibernate.</p>
</dd>
<dt class="hdlist1">initializeEmpty</dt>
<dd>
<p>Initialize database if empty. If set to false the database has to be manually initialized. If you want to manually initialize the database set migrationStrategy to <code>manual</code> which will create a file with SQL commands to initialize the database. Defaults to true.</p>
</dd>
<dt class="hdlist1">migrationStrategy</dt>
<dd>
<p>Strategy to use to migrate database. Valid values are <code>update</code>, <code>manual</code> and <code>validate</code>. Update will automatically migrate the database schema. Manual will export the required changes to a file with SQL commands that you can manually execute on the database. Validate will simply check if the database is up-to-date.</p>
</dd>
<dt class="hdlist1">migrationExport</dt>
<dd>
<p>Path for where to write manual database initialization/migration file.</p>
</dd>
<dt class="hdlist1">showSql</dt>
<dd>
<p>Specify whether Hibernate should show all SQL commands in the console (false by default).  This is very verbose!</p>
</dd>
<dt class="hdlist1">formatSql</dt>
<dd>
<p>Specify whether Hibernate should format SQL commands (true by default)</p>
</dd>
<dt class="hdlist1">globalStatsInterval</dt>
<dd>
<p>Will log global statistics from Hibernate about executed DB queries and other things.
Statistics are always reported to server log at specified interval (in seconds) and are cleared after each report.</p>
</dd>
<dt class="hdlist1">schema</dt>
<dd>
<p>Specify the database schema to use</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These configuration switches and more are described in the <a href="http://docs.wildfly.org/23/Developer_Guide.html#hibernate-properties"><em>WildFly 23 Development Guide</em></a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="unicode-considerations-for-databases"><a class="anchor" href="#unicode-considerations-for-databases"></a>Unicode considerations for databases</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/database/unicode-considerations.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/database/unicode-considerations.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Database schema in Keycloak only accounts for Unicode strings in the following special fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Realms: display name, HTML display name, localization texts (keys and values)</p>
</li>
<li>
<p>Federation Providers: display name</p>
</li>
<li>
<p>Users: username, given name, last name, attribute names and values</p>
</li>
<li>
<p>Groups: name, attribute names and values</p>
</li>
<li>
<p>Roles: name</p>
</li>
<li>
<p>Descriptions of objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, characters are limited to those contained in database encoding which is often 8-bit. However, for some
database systems, it is possible to enable UTF-8 encoding of Unicode characters and use full Unicode character set in all
text fields. Often, this is counterbalanced by shorter maximum length of the strings than in case of 8-bit encodings.</p>
</div>
<div class="paragraph">
<p>Some of the databases require special settings to database and/or JDBC driver to be able to handle Unicode characters.
Please find the settings for your database below. Note that if a database is listed here, it can still work properly
provided it handles UTF-8 encoding properly both on the level of database and JDBC driver.</p>
</div>
<div class="paragraph">
<p>Technically, the key criterion for Unicode support for all fields is whether the database allows setting of Unicode
character set for <code>VARCHAR</code> and <code>CHAR</code> fields. If yes, there is a high chance that Unicode will be plausible, usually at
the expense of field length. If it only supports Unicode in <code>NVARCHAR</code> and <code>NCHAR</code> fields, Unicode support for all text
fields is unlikely as Keycloak schema uses <code>VARCHAR</code> and <code>CHAR</code> fields extensively.</p>
</div>
<div class="sect3">
<h4 id="oracle-database"><a class="anchor" href="#oracle-database"></a>Oracle database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled provided the database was created with Unicode support in <code>VARCHAR</code> and <code>CHAR</code>
fields (e.g. by using <code>AL32UTF8</code> character set as the database character set). No special settings is needed for JDBC
driver.</p>
</div>
<div class="paragraph">
<p>If the database character set is not Unicode, then to use Unicode characters in the special fields, the JDBC driver needs
to be configured with the connection property <code>oracle.jdbc.defaultNChar</code> set to <code>true</code>. It might be wise, though not
strictly necessary, to also set the <code>oracle.jdbc.convertNcharLiterals</code> connection property to <code>true</code>. These properties
can be set either as system properties or as connection properties. Please note that setting <code>oracle.jdbc.defaultNChar</code>
may have negative impact on performance. For details, please refer to Oracle JDBC driver configuration documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="microsoft-sql-server-database"><a class="anchor" href="#microsoft-sql-server-database"></a>Microsoft SQL Server database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled only for the special fields. No special settings of JDBC driver or database is
necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="mysql-database"><a class="anchor" href="#mysql-database"></a>MySQL database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled provided the database was created with Unicode support in <code>VARCHAR</code> and <code>CHAR</code>
fields in the <code>CREATE DATABASE</code> command (e.g. by using <code>utf8</code> character set as the default database character set in
MySQL 5.5. Please note that <code>utf8mb4</code> character set does not work due to different storage requirements to <code>utf8</code>
character set <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>). Note that in this case, length
restriction to non-special fields does not apply because columns are created to accommodate given amount of characters,
not bytes. If the database default character set does not allow storing Unicode, only the special fields allow storing
Unicode values.</p>
</div>
<div class="paragraph">
<p>At the side of JDBC driver settings, it is necessary to add a connection property <code>characterEncoding=UTF-8</code> to the JDBC
connection settings.</p>
</div>
</div>
<div class="sect3">
<h4 id="postgresql-database"><a class="anchor" href="#postgresql-database"></a>PostgreSQL database</h4>
<div class="paragraph">
<p>Unicode is supported when the database character set is <code>UTF8</code>. In that case, Unicode characters can be used in any
field, there is no reduction of field length for non-special fields. No special settings of JDBC driver is necessary.</p>
</div>
<div class="paragraph">
<p>The character set of a PostgreSQL database is determined at the time it is created. You can determine the default
character set for a PostgreSQL cluster with the SQL command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="SQL"><span class="class">show</span> server_encoding;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the default character set is not UTF 8, then you can create the database with UTF8 as its character set like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="SQL"><span class="class">create</span> <span class="type">database</span> keycloak with encoding <span class="string"><span class="delimiter">'</span><span class="content">UTF8</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hostname"><a class="anchor" href="#_hostname"></a>Use of the public hostname</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/host.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/host.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak uses the public hostname for a number of things. For example, in the token issuer fields and URLs sent in
password reset emails.</p>
</div>
<div class="paragraph">
<p>The Hostname SPI provides a way to configure the hostname for a request. The default provider allows setting
a fixed URL for frontend requests, while allowing backend requests to be based on the request URI. It is also possible
to develop your own provider in the case the built-in provider does not provide the functionality needed.</p>
</div>
<div class="sect2">
<h3 id="default-provider"><a class="anchor" href="#default-provider"></a>Default provider</h3>
<div class="paragraph">
<p>The default hostname provider uses the configured <code>frontendUrl</code> as the base URL for frontend requests (requests from
user-agents) and uses the request URL as the basis for backend requests (direct requests from clients).</p>
</div>
<div class="paragraph">
<p>Frontend request do not have to have the same context-path as the Keycloak server. This means you can expose Keycloak
on for example <code><a href="https://auth.example.org" class="bare">https://auth.example.org</a></code> or <code><a href="https://example.org/keycloak" class="bare">https://example.org/keycloak</a></code> while internally its URL could be
<code><a href="https://10.0.0.10:8080/auth" class="bare">https://10.0.0.10:8080/auth</a></code>.</p>
</div>
<div class="paragraph">
<p>This makes it possible to have user-agents (browsers) send requests to Keycloak through the public domain name,
while internal clients can use an internal domain name or IP address.</p>
</div>
<div class="paragraph">
<p>This is reflected in the OpenID Connect Discovery endpoint for example where the <code>authorization_endpoint</code> uses the
frontend URL, while <code>token_endpoint</code> uses the backend URL. As a note here a public client for instance would contact
Keycloak through the public endpoint, which would result in the base of <code>authorization_endpoint</code> and <code>token_endpoint</code>
being the same.</p>
</div>
<div class="paragraph">
<p>To set the frontendUrl for Keycloak you can either pass add <code>-Dkeycloak.frontendUrl=https://auth.example.org</code> to the
startup or you can configure it in <code>standalone.xml</code>. See the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hostname</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>default<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">frontendUrl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://auth.example.com</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">forceBackendUrlToFrontendUrl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To update the <code>frontendUrl</code> with jboss-cli use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">/subsystem=keycloak-server/spi=hostname/provider=default:write-attribute(name=properties.frontendUrl,value=&quot;https://auth.example.com&quot;)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want all requests to go through the public domain name you can force backend requests to use the frontend URL as
well by setting <code>forceBackendUrlToFrontendUrl</code> to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>It is also possible to override the default frontend URL for individual realms. This can be done in the admin console.</p>
</div>
<div class="paragraph">
<p>If you do not want to expose the admin endpoints and console on the public domain use the property <code>adminUrl</code> to set
a fixed URL for the admin console, which is different to the <code>frontendUrl</code>. It is also required to block access to
<code>/auth/admin</code> externally, for details on how to do that refer to the <a href="https://www.keycloak.org/docs/latest/server_admin/">Server Administration Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-provider"><a class="anchor" href="#custom-provider"></a>Custom provider</h3>
<div class="paragraph">
<p>To develop a custom hostname provider you need to implement <code>org.keycloak.urls.HostnameProviderFactory</code> and
<code>org.keycloak.urls.HostnameProvider</code>.</p>
</div>
<div class="paragraph">
<p>Follow the instructions in the Service Provider Interfaces section in <a href="https://www.keycloak.org/docs/latest/server_development/">Server Developer Guide</a>
for more information on how to develop a custom provider.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_network"><a class="anchor" href="#_network"></a>Setting up the network</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/network.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/network.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The default installation of Keycloak can run with some networking limitations.  For one, all network endpoints bind to <code>localhost</code>
so the auth server is really only usable on one local machine.  For HTTP based connections, it does not use default ports
like 80 and 443.  HTTPS/SSL is not configured out of the box and without it, Keycloak has many security
vulnerabilities.
Finally, Keycloak
may often need to make secure SSL and HTTPS connections to external servers and thus need a trust store set up so that endpoints can
be validated correctly.  This chapter discusses all of these things.</p>
</div>
<div class="sect2">
<h3 id="_bind-address"><a class="anchor" href="#_bind-address"></a>Bind addresses</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/network/bind-address.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/network/bind-address.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>By default Keycloak binds to the localhost loopback address <code>127.0.0.1</code>.  That&#8217;s not a very useful default if
you want the authentication server available on your network.  Generally, what we recommend is that you deploy a reverse proxy
or load balancer on a public network and route traffic to individual Keycloak server instances on a private network.
In either case though, you still need to set up your network interfaces to bind to something other than <code>localhost</code>.</p>
</div>
<div class="paragraph">
<p>Setting the bind address is quite easy and can be done on the command line with either the <em>standalone.sh</em> or
<em>domain.sh</em> boot scripts discussed in the <a href="#_operating-mode">Choosing an Operating Mode</a> chapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ standalone.sh -b 192.168.0.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-b</code> switch sets the IP bind address for any public interfaces.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to set the bind address at the command line, you can edit the profile configuration of your deployment.
Open up the profile configuration file (<em>standalone.xml</em> or <em>domain.xml</em> depending on your
<a href="#_operating-mode">operating mode</a>) and look for the <code>interfaces</code> XML block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;interfaces&gt;</span>
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>public</code> interface corresponds to subsystems creating sockets that are available publicly.  An example of one
of these subsystems is the web layer which serves up the authentication endpoints of Keycloak.  The <code>management</code>
interface corresponds to sockets opened up by the management layer of the WildFly.  Specifically the sockets
which allow you to use the <code>jboss-cli.sh</code> command line interface and the WildFly web console.</p>
</div>
<div class="paragraph">
<p>In looking at the <code>public</code> interface you see that it has a special string <code>${jboss.bind.address:127.0.0.1}</code>.  This string
denotes a value <code>127.0.0.1</code> that can be overridden on the command line by setting a Java system property, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh -Djboss.bind.address=192.168.0.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-b</code> is just a shorthand notation for this command.  So, you can either change the bind address value directly in the profile config, or change it on the command line when
you boot up.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many more options available when setting up <code>interface</code> definitions. For more information, see <a href="http://docs.wildfly.org/23/Admin_Guide.html#Interfaces_and_ports">the network interface</a> in the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ports"><a class="anchor" href="#_ports"></a>Socket port bindings</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/network/ports.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/network/ports.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The ports opened for each socket have a pre-defined default that can be overridden at the command line or within configuration.
To illustrate this configuration, let&#8217;s pretend you are running in <a href="#_standalone-mode">standalone mode</a> and
open up the <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.  Search for <code>socket-binding-group</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management-http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.management.http.port:9990}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.management.https.port:9993}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.ajp.port:8009}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.http.port:8080}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.https.port:8443}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txn-recovery-environment</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4712</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txn-status-manager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4713</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mail-smtp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>socket-bindings</code> define socket connections that will be opened by the server.  These bindings specify the
<code>interface</code> (bind address) they use as well as what port number they will open.   The ones you will be most interested in are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">http</dt>
<dd>
<p>Defines the port used for Keycloak HTTP connections</p>
</dd>
<dt class="hdlist1">https</dt>
<dd>
<p>Defines the port used for Keycloak HTTPS connections</p>
</dd>
<dt class="hdlist1">ajp</dt>
<dd>
<p>This socket binding defines the port used for the AJP protocol.  This protocol is used by Apache HTTPD server
in conjunction <code>mod-cluster</code> when you are using Apache HTTPD as a load balancer.</p>
</dd>
<dt class="hdlist1">management-http</dt>
<dd>
<p>Defines the HTTP connection used by WildFly CLI and web console.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When running in <a href="#_domain-mode">domain mode</a> setting the socket configurations
is a bit trickier as the example <em>domain.xml</em> file has multiple <code>socket-binding-groups</code> defined.  If you scroll down
to the <code>server-group</code> definitions you can see what <code>socket-binding-group</code> is used for each <code>server-group</code>.</p>
</div>
<div class="listingblock">
<div class="title">domain socket bindings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;server-groups&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
    <span class="tag">&lt;/server-groups&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many more options available when setting up <code>socket-binding-group</code> definitions.  For more information, see <a href="http://docs.wildfly.org/23/Admin_Guide.html#Interfaces_and_ports">the socket binding group</a> in the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_ssl"><a class="anchor" href="#_setting_up_ssl"></a>Setting up HTTPS/SSL</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/network/https.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/network/https.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak is not set up by default to handle SSL/HTTPS.
          It is highly recommended that you either enable SSL on the Keycloak server itself or on a reverse proxy in front of the Keycloak server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This default behavior is defined by the SSL/HTTPS mode of each Keycloak realm.  This is discussed in more detail in the
<a href="https://www.keycloak.org/docs/latest/server_admin/">Server Administration Guide</a>, but let&#8217;s give some context and a brief overview of these modes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">external requests</dt>
<dd>
<p>Keycloak can run out of the box without SSL so long as you stick to private IP addresses like <code>localhost</code>, <code>127.0.0.1</code>, <code>10.x.x.x</code>, <code>192.168.x.x</code>, and <code>172.16.x.x</code>.
If you don&#8217;t have SSL/HTTPS configured on the server or you try to access Keycloak over HTTP from a non-private IP adress you will get an error.</p>
</dd>
<dt class="hdlist1">none</dt>
<dd>
<p>Keycloak does not require SSL.  This should really only be used in development when you are playing around with things.</p>
</dd>
<dt class="hdlist1">all requests</dt>
<dd>
<p>Keycloak requires SSL for all IP addresses.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The SSL mode for each realm can be configured in the Keycloak admin console.</p>
</div>
<div class="sect3">
<h4 id="enabling-ssl-https-for-the-keycloak-server"><a class="anchor" href="#enabling-ssl-https-for-the-keycloak-server"></a>Enabling SSL/HTTPS for the Keycloak server</h4>
<div class="paragraph">
<p>If you are not using a reverse proxy or load balancer to handle HTTPS traffic for you, you&#8217;ll need to enable HTTPS
for the Keycloak server.  This involves</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtaining or generating a keystore that contains the private key and certificate for SSL/HTTP traffic</p>
</li>
<li>
<p>Configuring the Keycloak server to use this keypair and certificate.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="creating-the-certificate-and-java-keystore"><a class="anchor" href="#creating-the-certificate-and-java-keystore"></a>Creating the Certificate and Java Keystore</h5>
<div class="paragraph">
<p>In order to allow HTTPS connections, you need to obtain a self signed or third-party signed certificate and import it into a Java keystore before you can enable HTTPS in the web container where you are deploying the Keycloak Server.</p>
</div>
<div class="sect5">
<h6 id="self-signed-certificate"><a class="anchor" href="#self-signed-certificate"></a>Self Signed Certificate</h6>
<div class="paragraph">
<p>In development, you will probably not have a third party signed certificate available to test a Keycloak deployment so you&#8217;ll need to generate a self-signed one
using the <code>keytool</code> utility that comes with the Java JDK.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -genkey -alias localhost -keyalg RSA -keystore keycloak.jks -validity 10950
    Enter keystore password: secret
    Re-enter new password: secret
    What is your first and last name?
    [Unknown]:  localhost
    What is the name of your organizational unit?
    [Unknown]:  Keycloak
    What is the name of your organization?
    [Unknown]:  Red Hat
    What is the name of your City or Locality?
    [Unknown]:  Westford
    What is the name of your State or Province?
    [Unknown]:  MA
    What is the two-letter country code for this unit?
    [Unknown]:  US
    Is CN=localhost, OU=Keycloak, O=Test, L=Westford, ST=MA, C=US correct?
    [no]:  yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you see the question <code>What is your first and last name ?</code>, supply the DNS name of the machine where you are installing the server. For testing purposes, <code>localhost</code> should be used.
After executing this command, the <code>keycloak.jks</code> file will be generated in the same directory as you executed the <code>keytool</code> command in.</p>
</div>
<div class="paragraph">
<p>If you want a third-party signed certificate, but don&#8217;t have one, you can obtain one for free at <a href="http://www.cacert.org">cacert.org</a>.  However, you first need to use the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate a Certificate Request:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -certreq -alias yourdomain -keystore keycloak.jks &gt; keycloak.careq</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>yourdomain</code> is a DNS name for which this certificate is generated.
Keytool generates the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>-----BEGIN NEW CERTIFICATE REQUEST-----
MIIC2jCCAcICAQAwZTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAk1BMREwDwYDVQQHEwhXZXN0Zm9y
ZDEQMA4GA1UEChMHUmVkIEhhdDEQMA4GA1UECxMHUmVkIEhhdDESMBAGA1UEAxMJbG9jYWxob3N0
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr7kck2TaavlEOGbcpi9c0rncY4HhdzmY
Ax2nZfq1eZEaIPqI5aTxwQZzzLDK9qbeAd8Ji79HzSqnRDxNYaZu7mAYhFKHgixsolE3o5Yfzbw1
29RvyeUVe+WZxv5oo9wolVVpdSINIMEL2LaFhtX/c1dqiqYVpfnvFshZQaIg2nL8juzZcBjj4as
H98gIS7khql/dkZKsw9NLvyxgJvp7PaXurX29fNf3ihG+oFrL22oFyV54BWWxXCKU/GPn61EGZGw
Ft2qSIGLdctpMD1aJR2bcnlhEjZKDksjQZoQ5YMXaAGkcYkG6QkgrocDE2YXDbi7GIdf9MegVJ35
2DQMpwIDAQABoDAwLgYJKoZIhvcNAQkOMSEwHzAdBgNVHQ4EFgQUQwlZJBA+fjiDdiVzaO9vrE/i
n2swDQYJKoZIhvcNAQELBQADggEBAC5FRvMkhal3q86tHPBYWBuTtmcSjs4qUm6V6f63frhveWHf
PzRrI1xH272XUIeBk0gtzWo0nNZnf0mMCtUBbHhhDcG82xolikfqibZijoQZCiGiedVjHJFtniDQ
9bMDUOXEMQ7gHZg5q6mJfNG9MbMpQaUVEEFvfGEQQxbiFK7hRWU8S23/d80e8nExgQxdJWJ6vd0X
MzzFK6j4Dj55bJVuM7GFmfdNC52pNOD5vYe47Aqh8oajHX9XTycVtPXl45rrWAH33ftbrS8SrZ2S
vqIFQeuLL3BaHwpl3t7j2lMWcK1p80laAxEASib/fAwrRHpLHBXRcq6uALUOZl4Alt8=
-----END NEW CERTIFICATE REQUEST-----</code></pre>
</div>
</div>
</li>
<li>
<p>Send this CA request to your Certificate Authority (CA).</p>
<div class="paragraph">
<p>The CA will issue you a signed certificate and send it to you.</p>
</div>
</li>
<li>
<p>Obtain and import the root certificate of the CA.</p>
<div class="paragraph">
<p>You can download the cert from CA (in other words: root.crt) and import as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -keystore keycloak.jks -file root.crt -alias root</code></pre>
</div>
</div>
</li>
<li>
<p>Import your new CA generated certificate to your keystore:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -alias yourdomain -keystore keycloak.jks -file your-certificate.cer</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-keycloak-to-use-the-keystore"><a class="anchor" href="#configure-keycloak-to-use-the-keystore"></a>Configure Keycloak to Use the Keystore</h5>
<div class="paragraph">
<p>Now that you have a Java keystore with the appropriate certificates, you need to configure your Keycloak installation to use it.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <em>standalone.xml</em>, <em>standalone-ha.xml</em>, or <em>host.xml</em> file to use the keystore and enable HTTPS.</p>
</li>
<li>
<p>Either move the keystore file to the <em>configuration/</em> directory of your deployment or the file in a location you choose and provide an absolute path to it.</p>
<div class="paragraph">
<p>If you are using absolute paths, remove the optional <code>relative-to</code> parameter from your configuration (See <a href="#_operating-mode">operating mode</a>).</p>
</div>
</li>
<li>
<p>Configure the keystore using the CLI:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ /subsystem=elytron/key-store=httpsKS:add(relative-to=jboss.server.config.dir,path=keycloak.jks,credential-reference={clear-text=secret},type=JKS)
$ /subsystem=elytron/key-manager=httpsKM:add(key-store=httpsKS,credential-reference={clear-text=secret})
$ /subsystem=elytron/server-ssl-context=httpsSSC:add(key-manager=httpsKM,protocols=[\"TLSv1.3\"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using domain mode, the commands should be executed in every host using the <code>/host=&lt;host_name&gt;/</code> prefix (in order to create the <code>security-realm</code> in all of them). Here is an example, which you would repeat for each host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ /host=&lt;host_name&gt;/subsystem=elytron/key-store=httpsKS:add(relative-to=jboss.server.config.dir,path=keycloak.jks,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
</li>
<li>
<p>Modify the <code>https-listener</code> to use the `server-ssl-context`previously created:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ /subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context, value=httpsSSC)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using domain mode, prefix the command with the profile that is being used with: <code>/profile=&lt;profile_name&gt;/</code>.</p>
</div>
<div class="paragraph">
<p>The resulting element, <code>server name="default-server"</code>, which is a child element of <code>subsystem xmlns="urn:jboss:domain:undertow:12.0"</code>, should contain the following stanza:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ssl-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">httpsSSC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information on configuring TLS refer to the <a href="https://docs.wildfly.org/25/WildFly_Elytron_Security.html#configure-ssltls">WildFly documentation</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="outgoing-http-requests"><a class="anchor" href="#outgoing-http-requests"></a>Outgoing HTTP requests</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/network/outgoing.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/network/outgoing.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keycloak server often needs to make non-browser HTTP requests to the applications and services it secures.
The auth server manages these outgoing connections by maintaining an HTTP client connection pool.  There are some things
you&#8217;ll need to configure in <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code>.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="title">HTTP client Config example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsHttpClient</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connection-pool-size</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">256</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">establish-connection-timeout-millis</dt>
<dd>
<p>Timeout for establishing a socket connection.</p>
</dd>
<dt class="hdlist1">socket-timeout-millis</dt>
<dd>
<p>If an outgoing request does not receive data for this amount of time, timeout the connection.</p>
</dd>
<dt class="hdlist1">connection-pool-size</dt>
<dd>
<p>How many connections can be in the pool (128 by default).</p>
</dd>
<dt class="hdlist1">max-pooled-per-route</dt>
<dd>
<p>How many connections can be pooled per host (64 by default).</p>
</dd>
<dt class="hdlist1">connection-ttl-millis</dt>
<dd>
<p>Maximum connection time to live in milliseconds.
Not set by default.</p>
</dd>
<dt class="hdlist1">max-connection-idle-time-millis</dt>
<dd>
<p>Maximum time the connection might stay idle in the connection pool (900 seconds by default). Will start background cleaner thread of Apache HTTP client.
Set to <code>-1</code> to disable this checking and the background thread.</p>
</dd>
<dt class="hdlist1">disable-cookies</dt>
<dd>
<p><code>true</code> by default.
When set to true, this will disable any cookie caching.</p>
</dd>
<dt class="hdlist1">client-keystore</dt>
<dd>
<p>This is the file path to a Java keystore file.
This keystore contains client certificate for two-way SSL.</p>
</dd>
<dt class="hdlist1">client-keystore-password</dt>
<dd>
<p>Password for the client keystore.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
<dt class="hdlist1">client-key-password</dt>
<dd>
<p>Password for the client&#8217;s key.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
<dt class="hdlist1">proxy-mappings</dt>
<dd>
<p>Denotes proxy configurations for outgoing HTTP requests.
See the section on <a href="#_proxymappings">Proxy Mappings for Outgoing HTTP Requests</a> for more details.</p>
</dd>
<dt class="hdlist1">disable-trust-manager</dt>
<dd>
<p>If an outgoing request requires HTTPS and this config option is set to <code>true</code> you do not have to specify a truststore.
This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates.
This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_proxymappings"><a class="anchor" href="#_proxymappings"></a>Proxy mappings for outgoing HTTP requests</h4>
<div class="paragraph">
<p>Outgoing HTTP requests sent by Keycloak can optionally use a proxy server based on a comma delimited list of proxy-mappings.
A proxy-mapping denotes the combination of a regex based hostname pattern and a proxy-uri in the form of <code>hostnamePattern;proxyUri</code>,
e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>.*\.(google|googleapis)\.com;http://www-proxy.acme.com:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the proxy for an outgoing HTTP request the target hostname is matched against the configured
hostname patterns. The first matching pattern determines the proxy-uri to use.
If none of the configured patterns match for the given hostname then no proxy is used.</p>
</div>
<div class="paragraph">
<p>If the proxy server requires authentication, include the proxy user&#8217;s credentials in this format <code>username:password@</code>.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>.*\.(google|googleapis)\.com;http://user01:pas2w0rd@www-proxy.acme.com:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>The special value <code>NO_PROXY</code> for the proxy-uri can be used to indicate that no proxy
should be used for hosts matching the associated hostname pattern.
It is possible to specify a catch-all pattern at the end of the proxy-mappings to define a default
proxy for all outgoing requests.</p>
</div>
<div class="paragraph">
<p>The following example demonstrates the proxy-mapping configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># All requests to Google APIs should use http://www-proxy.acme.com:8080 as proxy
.*\.(google|googleapis)\.com;http://www-proxy.acme.com:8080

# All requests to internal systems should use no proxy
.*\.acme\.com;NO_PROXY

# All other requests should use http://fallback:8080 as proxy
.*;http://fallback:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be configured via the following <code>jboss-cli</code> command.
Note that you need to properly escape the regex-pattern as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>echo SETUP: Configure proxy routes for HttpClient SPI

# In case there is no connectionsHttpClient definition yet
/subsystem=keycloak-server/spi=connectionsHttpClient/provider=default:add(enabled=true)

# Configure the proxy-mappings
/subsystem=keycloak-server/spi=connectionsHttpClient/provider=default:write-attribute(name=properties.proxy-mappings,value=[".*\\.(google|googleapis)\\.com;http://www-proxy.acme.com:8080",".*\\.acme\\.com;NO_PROXY",".*;http://fallback:8080"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>jboss-cli</code> command results in the following subsystem configuration.
Note that one needs to encode <code>"</code> characters with <code>&amp;quot;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsHttpClient</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-mappings</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="entity">&amp;quot;</span><span class="content">.*\\.(google|googleapis)\\.com;http://www-proxy.acme.com:8080</span><span class="entity">&amp;quot;</span><span class="content">,</span><span class="entity">&amp;quot;</span><span class="content">.*\\.acme\\.com;NO_PROXY</span><span class="entity">&amp;quot;</span><span class="content">,</span><span class="entity">&amp;quot;</span><span class="content">.*;http://fallback:8080</span><span class="entity">&amp;quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_proxy_env_vars"><a class="anchor" href="#_proxy_env_vars"></a>Using standard environment variables</h4>
<div class="paragraph">
<p>Alternatively, it is possible to use standard environment variables to configure the proxy mappings, that is <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>
and <code>NO_PROXY</code> variables.</p>
</div>
<div class="paragraph">
<p>The <code>HTTP_PROXY</code> and <code>HTTPS_PROXY</code> variables represent the proxy server that should be used for all outgoing HTTP requests.
Keycloak does not differ between the two. If both are specified, <code>HTTPS_PROXY</code> takes the precedence regardless of
the actual scheme the proxy server uses.</p>
</div>
<div class="paragraph">
<p>The <code>NO_PROXY</code> variable is used to define a comma separated list of hostnames that should not use the proxy.
If a hostname is specified, all its prefixes (subdomains) are also excluded from using proxy.</p>
</div>
<div class="paragraph">
<p>Take the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>HTTPS_PROXY=https://www-proxy.acme.com:8080
NO_PROXY=google.com,login.facebook.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, all outgoing HTTP requests will use <code>https://www-proxy.acme.com:8080</code> proxy server except for requests
to for example <code>login.google.com</code>, <code>google.com</code>, <code>auth.login.facebook.com</code>. However, for example <code>groups.facebook.com</code> will be routed
through the proxy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The environment variables can be lowercase or uppercase. Lowercase takes precedence. For example if both <code>HTTP_PROXY</code> and
       <code>http_proxy</code> are defined, <code>http_proxy</code> will be used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If proxy mappings are defined using the subsystem configuration (as described above), the environment variables are not
considered by Keycloak. This scenario applies in case no proxy server should be used despite having for example <code>HTTP_PROXY</code>
environment variable defined. To do so, you can specify a generic no proxy route as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsHttpClient</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-mappings</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">.*;NO_PROXY</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_truststore"><a class="anchor" href="#_truststore"></a>Outgoing HTTPS request truststore</h4>
<div class="paragraph">
<p>When Keycloak invokes on remote HTTPS endpoints, it has to validate the remote server&#8217;s certificate in order to ensure it is connecting to a trusted server.
This is necessary in order to prevent man-in-the-middle attacks.  The certificates of these remote server&#8217;s or the CA that signed these
certificates must be put in a truststore.  This truststore is managed by the Keycloak server.</p>
</div>
<div class="paragraph">
<p>The truststore is used when connecting securely to identity brokers, LDAP identity providers, when sending emails, and for backchannel communication with client applications.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default, a truststore provider is not configured, and any https connections fall back to standard java truststore configuration as described in
          <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html">Java&#8217;s JSSE Reference Guide</a>.  If there is no trust
          established, then these outgoing HTTPS requests will fail.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use <em>keytool</em> to create a new truststore file or add trusted host certificates to an existing one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -alias HOSTDOMAIN -keystore truststore.jks -file host-certificate.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>The truststore is configured within the <code>standalone.xml</code>,
<code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.
You can add your truststore configuration by using the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">path to your .jks file containing public certificates</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hostname-verification-policy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WILDCARD</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options for this setting are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">file</dt>
<dd>
<p>The path to a Java keystore file.
HTTPS requests need a way to verify the host of the server they are talking to.
This is what the trustore does.
The keystore contains one or more trusted host certificates or certificate authorities.
This truststore file should only contain public certificates of your secured hosts.
This is <em>REQUIRED</em> if any of these properties are defined.</p>
</dd>
<dt class="hdlist1">password</dt>
<dd>
<p>Password of the keystore.
This is <em>REQUIRED</em> if any of these properties are defined.</p>
</dd>
<dt class="hdlist1">hostname-verification-policy</dt>
<dd>
<p><code>WILDCARD</code> by default.
For HTTPS requests, this verifies the hostname of the server&#8217;s certificate.
 <code>ANY</code> means that the hostname is not verified. <code>WILDCARD</code> Allows wildcards in subdomain names i.e.
*.foo.com. <code>STRICT</code> CN must match hostname exactly.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustering"><a class="anchor" href="#_clustering"></a>Configuring Keycloak to run in a cluster</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To configure Keycloak to run in a cluster, you perform these actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_operating-mode">Pick an operation mode</a></p>
</li>
<li>
<p><a href="#_database">Configure a shared external database</a></p>
</li>
<li>
<p>Set up a load balancer</p>
</li>
<li>
<p>Supplying a private network that supports IP multicast</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Picking an operation mode and configuring a shared database have been discussed earlier in this guide.  This chapter describes setting up a load balancer and supplying a private network as well as booting up a host in the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to cluster Keycloak without IP Multicast, but this topic is beyond the scope of this guide.  For more information, see <a href="http://docs.wildfly.org/23/High_Availability_Guide.html#JGroups_Subsystem">JGroups</a> chapter of the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="recommended-network-architecture"><a class="anchor" href="#recommended-network-architecture"></a>Recommended network architecture</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/recommended.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/recommended.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The recommended network architecture for deploying Keycloak is to set up an HTTP/HTTPS load balancer on
a public IP address that routes requests to Keycloak servers sitting on a private network.  This
isolates all clustering connections and provides a nice means of protecting the servers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, there is nothing to prevent unauthorized nodes from joining the cluster and broadcasting multicast messages.
      This is why cluster nodes should be in a private network, with a firewall protecting them from outside attacks.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="clustering-example"><a class="anchor" href="#clustering-example"></a>Clustering example</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/example.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/example.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak does come with an out of the box clustering demo that leverages domain mode.  Review the
<a href="#_clustered-domain-example">Clustered Domain Example</a> chapter for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting-up-a-load-balancer-or-proxy"><a class="anchor" href="#_setting-up-a-load-balancer-or-proxy"></a>Setting Up a load balancer or proxy</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/load-balancer.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/load-balancer.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section discusses a number of things you need to configure before you can put a reverse proxy or load balancer
in front of your clustered Keycloak deployment.  It also covers configuring the built-in load balancer that
was <a href="#_clustered-domain-example">Clustered Domain Example</a>.</p>
</div>
<div class="paragraph">
<p>The following diagram illustrates the use of a load balancer. In this example, the load balancer serves as a reverse proxy between three clients and a cluster of three Keycloak servers.</p>
</div>
<div id="load-balancer-diagram" class="paragraph">
<div class="title">Example Load Balancer Diagram</div>
<p><span class="image"><img src="./keycloak-images/load_balancer.png" alt="load balancer"></span></p>
</div>
<div class="sect3">
<h4 id="identifying-client-ip-addresses"><a class="anchor" href="#identifying-client-ip-addresses"></a>Identifying client IP addresses</h4>
<div class="paragraph">
<p>A few features in Keycloak rely on the fact that the remote
address of the HTTP client connecting to the authentication server is the real IP address of the client machine. Examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event logs - a failed login attempt would be logged with the wrong source IP address</p>
</li>
<li>
<p>SSL required - if the SSL required is set to external (the default) it should require SSL for all external requests</p>
</li>
<li>
<p>Authentication flows - a custom authentication flow that uses the IP address to for example show OTP only for external requests</p>
</li>
<li>
<p>Dynamic Client Registration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This can be problematic when you have a reverse proxy or loadbalancer in front of your Keycloak authentication server.
The usual setup is that you have a frontend proxy sitting on a public network that load balances and forwards requests
to backend Keycloak server instances located in a private network.  There is some extra configuration you have to do in this scenario
so that the actual client IP address is forwarded to and processed by the Keycloak server instances.  Specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure your reverse proxy or loadbalancer to properly set <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code> HTTP headers.</p>
</li>
<li>
<p>Configure your reverse proxy or loadbalancer to preserve the original 'Host' HTTP header.</p>
</li>
<li>
<p>Configure the authentication server to read the client&#8217;s IP address from <code>X-Forwarded-For</code> header.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuring your proxy to generate the <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code> HTTP headers and preserving the
 original <code>Host</code> HTTP header is beyond the scope of this guide.  Take extra precautions to ensure that the
<code>X-Forwarded-For</code> header is set by your proxy.  If your proxy isn&#8217;t configured correctly, then <em>rogue</em> clients can set this header themselves and trick Keycloak
into thinking the client is connecting from a different IP address than it actually is.  This becomes really important if you are doing
any black or white listing of IP addresses.</p>
</div>
<div class="paragraph">
<p>Beyond the proxy itself, there are a few things you need to configure on the Keycloak side of things.
If your proxy is forwarding requests via the HTTP protocol, then you need to configure Keycloak to pull the client&#8217;s
IP address from the <code>X-Forwarded-For</code> header rather than from the network packet.
To do this, open up the profile configuration file (<em>standalone.xml</em>, <em>standalone-ha.xml</em>, or <em>domain.xml</em> depending on your
<a href="#_operating-mode">operating mode</a>) and look for the <code>urn:jboss:domain:undertow:12.0</code> XML block.</p>
</div>
<div class="listingblock">
<div class="title"><code>X-Forwarded-For</code> HTTP Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;ajp-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">proxy-address-forwarding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      ...
   <span class="tag">&lt;/server&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the <code>proxy-address-forwarding</code> attribute to the <code>http-listener</code> element.  Set the value to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>If your proxy is using the AJP protocol instead of HTTP to forward requests (i.e. Apache HTTPD + mod-cluster), then you have
to configure things a little differently.  Instead of modifying the <code>http-listener</code>, you need to add a filter to
pull this information from the AJP packets.</p>
</div>
<div class="listingblock">
<div class="title"><code>X-Forwarded-For</code> AJP Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;ajp-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-host</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             ...
             <span class="tag">&lt;filter-ref</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-peer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/host&gt;</span>
     <span class="tag">&lt;/server&gt;</span>
        ...
     <span class="tag">&lt;filters&gt;</span>
         ...
         <span class="tag">&lt;filter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-peer</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">class-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.undertow.server.handlers.ProxyPeerAddressHandler</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.undertow.core</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
     <span class="tag">&lt;/filters&gt;</span>
 <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enabling-https-ssl-with-a-reverse-proxy"><a class="anchor" href="#enabling-https-ssl-with-a-reverse-proxy"></a>Enabling HTTPS/SSL with a reverse proxy</h4>
<div class="paragraph">
<p>Assuming that your reverse proxy doesn&#8217;t use port 8443 for SSL you also need to configure to what port the HTTPS traffic is redirected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">proxy-address-forwarding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-https</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>redirect-socket</code> attribute to the <code>http-listener</code> element.  The value should be <code>proxy-https</code> which points to a
socket binding you also need to define.</p>
</li>
<li>
<p>Add a new <code>socket-binding</code> element to the <code>socket-binding-group</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">443</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="verifying-the-configuration"><a class="anchor" href="#verifying-the-configuration"></a>Verifying the configuration</h4>
<div class="paragraph">
<p>You can verify the reverse proxy or load balancer configuration</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the path <code>/auth/realms/master/.well-known/openid-configuration</code>
through the reverse proxy.</p>
<div class="paragraph">
<p>For example if the reverse proxy address is <code>https://acme.com/</code> then open the URL
<code>https://acme.com/auth/realms/master/.well-known/openid-configuration</code>. This will show a JSON document listing a number
of endpoints for Keycloak.</p>
</div>
</li>
<li>
<p>Make sure the endpoints starts with the address (scheme, domain and port) of your
reverse proxy or load balancer. By doing this you make sure that Keycloak is using the correct endpoint.</p>
</li>
<li>
<p>Verify that Keycloak sees the correct source IP address for requests.</p>
<div class="paragraph">
<p>To check this, you can
try to login to the Admin Console with an invalid username and/or password. This should show a warning in the server log
something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>08:14:21,287 WARN  XNIO-1 task-45 [org.keycloak.events] type=LOGIN_ERROR, realmId=master, clientId=security-admin-console, userId=8f20d7ba-4974-4811-a695-242c8fbd1bf8, ipAddress=X.X.X.X, error=invalid_user_credentials, auth_method=openid-connect, auth_type=code, redirect_uri=http://localhost:8080/auth/admin/master/console/?redirect_fragment=%2Frealms%2Fmaster%2Fevents-settings, code_id=a3d48b67-a439-4546-b992-e93311d6493e, username=admin</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the value of <code>ipAddress</code> is the IP address of the machine you tried to login with and not the IP address  of the reverse proxy or load balancer.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="using-the-built-in-load-balancer"><a class="anchor" href="#using-the-built-in-load-balancer"></a>Using the built-in load balancer</h4>
<div class="paragraph">
<p>This section covers configuring the built-in load balancer that is discussed in the
<a href="#_clustered-domain-example">Clustered Domain Example</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="#_clustered-domain-example">Clustered Domain Example</a> is only designed to run
on one machine.  To bring up a slave on another host, you&#8217;ll need to</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <em>domain.xml</em> file to point to your new host slave</p>
</li>
<li>
<p>Copy the server distribution.  You don&#8217;t need the <em>domain.xml</em>, <em>host.xml</em>, or <em>host-master.xml</em> files.  Nor do you need
the <em>standalone/</em> directory.</p>
</li>
<li>
<p>Edit the <em>host-slave.xml</em> file to change the bind addresses used or override them on the command line</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open  <em>domain.xml</em> so you can registering the new host slave with the load balancer configuration.</p>
</li>
<li>
<p>Go to the undertow configuration in the <code>load-balancer</code> profile.  Add a new <code>host</code> definition called <code>remote-host3</code> within the <code>reverse-proxy</code> XML block.</p>
<div class="listingblock">
<div class="title">domain.xml reverse-proxy config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;handlers&gt;</span>
      <span class="tag">&lt;reverse-proxy</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lb-handler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">host2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/reverse-proxy&gt;</span>
  <span class="tag">&lt;/handlers&gt;</span>
  ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>output-socket-binding</code> is a logical name pointing to a <code>socket-binding</code> configured later in the <em>domain.xml</em> file.
The <code>instance-id</code> attribute must also be unique to the new host as this value is used by a cookie to enable sticky
sessions when load balancing.</p>
</div>
</li>
<li>
<p>Go down to the <code>load-balancer-sockets</code> <code>socket-binding-group</code> and add the <code>outbound-socket-binding</code> for <code>remote-host3</code>.</p>
<div class="paragraph">
<p>This new binding needs to point to the host and port of the new host.</p>
</div>
<div class="listingblock">
<div class="title">domain.xml outbound-socket-binding</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8159</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8259</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">192.168.0.5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8259</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="master-bind-addresses"><a class="anchor" href="#master-bind-addresses"></a>Master bind addresses</h5>
<div class="paragraph">
<p>Next thing you&#8217;ll have to do is to change the <code>public</code> and <code>management</code> bind addresses for the master host.  Either
edit the <em>domain.xml</em> file as discussed in the <a href="#_bind-address">Bind Addresses</a> chapter
or specify these bind addresses on the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh --host-config=host-master.xml -Djboss.bind.address=192.168.0.2 -Djboss.bind.address.management=192.168.0.2</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="host-slave-bind-addresses"><a class="anchor" href="#host-slave-bind-addresses"></a>Host slave bind addresses</h5>
<div class="paragraph">
<p>Next you&#8217;ll have to change the <code>public</code>, <code>management</code>, and domain controller bind addresses (<code>jboss.domain.master-address</code>).  Either edit the
<em>host-slave.xml</em> file or specify them on the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh --host-config=host-slave.xml
     -Djboss.bind.address=192.168.0.5
      -Djboss.bind.address.management=192.168.0.5
       -Djboss.domain.master.address=192.168.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The values of <code>jboss.bind.address</code> and <code>jboss.bind.address.management</code> pertain to the host slave&#8217;s IP address.
The value of <code>jboss.domain.master.address</code> needs to be the IP address of the domain controller, which is the management address of the master host.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="http://docs.wildfly.org/23/High_Availability_Guide.html">the load balancing</a> section in the <em>WildFly 23 Documentation</em> for information how to use other software-based load balancers.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sticky-sessions"><a class="anchor" href="#sticky-sessions"></a>Sticky sessions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/sticky-sessions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/sticky-sessions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Typical cluster deployment consists of the load balancer (reverse proxy) and 2 or more Keycloak servers on private network. For performance purposes,
it may be useful if load balancer forwards all requests related to particular browser session to the same Keycloak backend node.</p>
</div>
<div class="paragraph">
<p>The reason is, that Keycloak is using Infinispan distributed cache under the covers for save data related to current authentication session and user session.
The Infinispan distributed caches are configured with one owner by default. That means that particular session is saved just on one cluster node and the other nodes need
to lookup the session remotely if they want to access it.</p>
</div>
<div class="paragraph">
<p>For example if authentication session with ID <code>123</code> is saved in the Infinispan cache on <code>node1</code>, and then <code>node2</code> needs to lookup this session,
it needs to send the request to <code>node1</code> over the network to return the particular session entity.</p>
</div>
<div class="paragraph">
<p>It is beneficial if particular session entity is always available locally, which can be done with the help of sticky sessions.
The workflow in the cluster environment with the public frontend load balancer and two backend Keycloak nodes can be like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User sends initial request to see the Keycloak login screen</p>
</li>
<li>
<p>This request is served by the frontend load balancer, which forwards it to some random node (eg. node1). Strictly said, the node doesn&#8217;t need to be random,
but can be chosen according to some other criterias (client IP address etc). It all depends on the implementation and configuration of underlying load balancer (reverse proxy).</p>
</li>
<li>
<p>Keycloak creates authentication session with random ID (eg. 123) and saves it to the Infinispan cache.</p>
</li>
<li>
<p>Infinispan distributed cache assigns the primary owner of the session based on the hash of session ID.
See <a href="https://infinispan.org/docs/10.1.x/titles/configuring/configuring.html#clustered_caches">Infinispan documentation</a> for more details around this.
Let&#8217;s assume that Infinispan assigned <code>node2</code> to be the owner of this session.</p>
</li>
<li>
<p>Keycloak creates the cookie <code>AUTH_SESSION_ID</code> with the format like <code>&lt;session-id&gt;.&lt;owner-node-id&gt;</code> . In our example case, it will be <code>123.node2</code> .</p>
</li>
<li>
<p>Response is returned to the user with the Keycloak login screen and the AUTH_SESSION_ID cookie in the browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From this point, it is beneficial if load balancer forwards all the next requests to the <code>node2</code> as this is the node, who is owner of the authentication session with ID <code>123</code>
and hence Infinispan can lookup this session locally. After authentication is finished, the authentication session is converted to user session, which will be also saved on
<code>node2</code> because it has same ID <code>123</code> .</p>
</div>
<div class="paragraph">
<p>The sticky session is not mandatory for the cluster setup, however it is good for performance for the reasons mentioned above. You need to configure your loadbalancer to sticky
over the <code>AUTH_SESSION_ID</code> cookie. How exactly do this is dependent on your loadbalancer.</p>
</div>
<div class="paragraph">
<p>It is recommended on the Keycloak side to use the system property <code>jboss.node.name</code> during startup, with the value corresponding
to the name of your route. For example, <code>-Djboss.node.name=node1</code> will use <code>node1</code> to identify the route. This route will be used by
Infinispan caches and will be attached to the AUTH_SESSION_ID cookie when the node is the owner of the particular key. Here is
an example of the start up command using this system property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd $RHSSO_NODE1
./standalone.sh -c standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically in production environment the route name should use the same name as your backend host, but it is not required. You can
use a different route name. For example, if you want to hide the host name of your Keycloak server inside your private network.</p>
</div>
<div class="sect3">
<h4 id="disable-adding-the-route"><a class="anchor" href="#disable-adding-the-route"></a>Disable adding the route</h4>
<div class="paragraph">
<p>Some load balancers can be configured to add the route information by themselves instead of relying on the back end Keycloak node.
However, as described above, adding the route by the Keycloak is recommended. This is because when done this way performance improves,
since Keycloak is aware of the entity that is the owner of particular session and can route to that node, which is not necessarily the local node.</p>
</div>
<div class="paragraph">
<p>You are permitted to disable adding route information to the AUTH_SESSION_ID cookie by Keycloak, if you prefer, by adding the following
into your <code>RHSSO_HOME/standalone/configuration/standalone-ha.xml</code> file in the Keycloak subsystem configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stickySessionEncoder</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;properties&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">shouldAttachRoute</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/properties&gt;</span>
        <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>

<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-multicast-networking"><a class="anchor" href="#setting-up-multicast-networking"></a>Setting up multicast networking</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/multicast.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/multicast.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The default clustering support needs IP Multicast. Multicast is a network broadcast protocol. This protocol is used at boot time to discover and join the cluster. It is also used to broadcast messages for the replication and invalidation of distributed caches used by Keycloak.</p>
</div>
<div class="paragraph">
<p>The clustering subsystem for Keycloak runs on the JGroups stack. Out of the box, the bind addresses for clustering are bound to a private network interface with 127.0.0.1 as default IP address.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit your the <em>standalone-ha.xml</em> or <em>domain.xml</em> sections discussed in the <a href="#_bind-address">Bind Address</a> chapter.</p>
<div class="listingblock">
<div class="title">private network config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;interfaces&gt;</span>
        ...
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.private:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;/interfaces&gt;</span>
    <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-mping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.default.multicast.address:230.0.0.4}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">45700</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7600</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp-fd</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">57600</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">55200</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.default.multicast.address:230.0.0.4}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">45688</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp-fd</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">54200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">224.0.1.105</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23364</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        ...
    <span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>jboss.bind.address.private</code> and <code>jboss.default.multicast.address</code> as well as the ports of the services on the clustering stack.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to cluster Keycloak without IP Multicast, but this topic is beyond the scope of this guide. For more information, see <a href="http://docs.wildfly.org/23/High_Availability_Guide.html#JGroups_Subsystem">JGroups</a> in the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="secure-cluster-communication"><a class="anchor" href="#secure-cluster-communication"></a>Secure cluster communication</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/securing-cluster-comm.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/securing-cluster-comm.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When cluster nodes are isolated on a private network it requires access to the private network to be able to join a cluster or to view communication in the cluster. In addition you can also enable authentication and encryption for cluster communication. As long as your private network is secure it is not necessary to enable authentication and encryption. Keycloak does not send very sensitive information on the cluster in either case.</p>
</div>
<div class="paragraph">
<p>If you want to enable authentication and encryption for clustering communication, see the 'High Availability Guide' in the <a href="http://docs.wildfly.org/23/High_Availability_Guide.html">WildFly documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clustering_db_lock"><a class="anchor" href="#_clustering_db_lock"></a>Serialized cluster startup</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/serialized.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/serialized.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak cluster nodes are allowed to boot concurrently.
When Keycloak server instance boots up it may do some database migration, importing, or first time initializations.
A DB lock is used to prevent start actions from conflicting with one another when cluster nodes boot up concurrently.</p>
</div>
<div class="paragraph">
<p>By default, the maximum timeout for this lock is 900 seconds.  If a node is waiting on this lock for more than the timeout
it will fail to boot.
Typically you won&#8217;t need to increase/decrease the default value, but just in case it&#8217;s possible to configure it in
<code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dblock</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lockWaitTimeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">900</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="booting-the-cluster"><a class="anchor" href="#booting-the-cluster"></a>Booting the cluster</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/booting.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/booting.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Booting Keycloak in a cluster depends on your <a href="#_operating-mode">operating mode</a></p>
</div>
<div class="listingblock">
<div class="title">Standalone Mode</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ bin/standalone.sh --server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Domain Mode</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ bin/domain.sh --host-config=host-master.xml
$ bin/domain.sh --host-config=host-slave.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may need to use additional parameters or system properties. For example, the parameter <code>-b</code> for the binding host or the system property
<code>jboss.node.name</code> to specify the name of the route, as described in <a href="#sticky-sessions">Sticky Sessions</a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-2"><a class="anchor" href="#troubleshooting-2"></a>Troubleshooting</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/clustering/troubleshooting.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/clustering/troubleshooting.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that when you run a cluster, you should see message similar to this in the log of both cluster nodes:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-10,shared=udp)
ISPN000094: Received new cluster view: [node1/keycloak|1] (2) [node1/keycloak, node2/keycloak]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see just one node mentioned, it&#8217;s possible that your cluster hosts are not joined together.</p>
</div>
<div class="paragraph">
<p>Usually it&#8217;s best practice to have your cluster nodes on private network without firewall for communication among them.
Firewall could be enabled just on public access point to your network instead.
If for some reason you still need to have firewall enabled on cluster nodes, you will need to open some ports.
Default values are UDP port 55200 and multicast port 45688 with multicast address 230.0.0.4.
Note that you may need more ports opened if you want to enable additional features like diagnostics for your JGroups stack.
Keycloak delegates most of the clustering work to Infinispan/JGroups.
For more information, see <a href="http://docs.wildfly.org/23/High_Availability_Guide.html#JGroups_Subsystem">JGroups</a> in the <em>WildFly 23 Documentation</em>.</p>
</div>
</li>
<li>
<p>If you are interested in failover support (high availability), evictions, expiration and cache tuning, see
<a href="#cache-configuration">Server cache configuration</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache-configuration"><a class="anchor" href="#cache-configuration"></a>Server cache configuration</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/cache.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/cache.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has two types of caches.  One type of cache sits in front of the database to decrease load on the DB
and to decrease overall response times by keeping data in memory.  Realm, client, role, and user metadata is kept in this type of cache.
This cache is a local cache.  Local caches do not use replication even if you are in the cluster with more Keycloak servers.
Instead, they only keep copies locally and if the entry is updated an invalidation message is sent to the rest of the cluster
and the entry is evicted. There is separate replicated cache <code>work</code>, which task is to send the invalidation messages to the whole cluster about what entries
 should be evicted from local caches. This greatly reduces network traffic, makes things efficient, and avoids transmitting sensitive
metadata over the wire.</p>
</div>
<div class="paragraph">
<p>The second type of cache handles managing user sessions, offline tokens, and keeping track of login failures so that the
server can detect password phishing and other attacks.  The data held in these caches is temporary, in memory only,
but is possibly replicated across the cluster.</p>
</div>
<div class="paragraph">
<p>This chapter discusses some configuration options for these caches for both clustered and non-clustered deployments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More advanced configuration of these caches can be found in the  <a href="http://docs.wildfly.org/23/High_Availability_Guide.html#Infinispan_Subsystem">Infinispan</a> section of the <em>WildFly 23 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_eviction"><a class="anchor" href="#_eviction"></a>Eviction and expiration</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/cache/eviction.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/cache/eviction.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are multiple different caches configured for Keycloak.
There is a realm cache that holds information about secured applications, general security data, and configuration options.
There is also a user cache that contains user metadata.  Both caches default to a maximum of 10000 entries and use a least recently used eviction strategy.
Each of them is also tied to an object revisions cache that controls eviction in a clustered setup.
This cache is created implicitly and has twice the configured size. The same applies for the <code>authorization</code> cache, which holds
the authorization data. The <code>keys</code> cache holds data about external keys and does not need to have dedicated revisions cache. Rather
it has <code>expiration</code> explicitly declared on it, so the keys are periodically expired and forced to be periodically downloaded from external clients or
identity providers.</p>
</div>
<div class="paragraph">
<p>The eviction policy and max entries for these caches can be configured in the <em>standalone.xml</em>, <em>standalone-ha.xml</em>, or
<em>domain.xml</em> depending on your <a href="#_operating-mode">operating mode</a>. In the configuration file, there is the part with infinispan
subsystem, which looks similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;object-memory</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;object-memory</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        ...
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;object-memory</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3600000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        ...
    <span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To limit or expand the number of allowed entries simply add or edit the <code>object</code> element or the <code>expiration</code> element of particular cache
configuration.</p>
</div>
<div class="paragraph">
<p>In addition, there are also separate caches <code>sessions</code>, <code>clientSessions</code>, <code>offlineSessions</code>, <code>offlineClientSessions</code>,
<code>loginFailures</code> and <code>actionTokens</code>. These caches are distributed in cluster environment and they are unbounded in size by default.
If they are bounded, it would then be possible that some sessions will be lost. Expired sessions are cleared internally
by Keycloak itself to avoid growing the size of these caches
without limit. If you see memory issues due to a large number of sessions, you can try to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increase the size of cluster (more nodes in cluster means that sessions are spread more equally among nodes)</p>
</li>
<li>
<p>Increase the memory for Keycloak server process</p>
</li>
<li>
<p>Decrease the number of owners to ensure that caches are saved in one single place. See <a href="#_replication">Replication and failover</a> for more details</p>
</li>
<li>
<p>Disable l1-lifespan for distributed caches. See Infinispan documentation for more details</p>
</li>
<li>
<p>Decrease session timeouts, which could be done individually for each realm in Keycloak admin console. But this could affect
usability for end users. See <a href="https://www.keycloak.org/docs/latest/server_admin/#_timeouts">Timeouts</a> for more details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is an additional replicated cache, <code>work</code>, which is mostly used to send messages among cluster nodes; it is also unbounded
by default. However, this cache should not cause any memory issues as entries in this cache are very short-lived.</p>
</div>
</div>
<div class="sect2">
<h3 id="_replication"><a class="anchor" href="#_replication"></a>Replication and failover</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/cache/replication.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/cache/replication.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are caches like <code>sessions</code>, <code>authenticationSessions</code>, <code>offlineSessions</code>, <code>loginFailures</code> and a few others (See <a href="#_eviction">Eviction and expiration</a> for more details),
which are configured as distributed caches when using a clustered setup. Entries are
not replicated to every single node, but instead one or more nodes is chosen as an owner of that data.  If a node is not the owner of a specific cache entry it queries
the cluster to obtain it.  What this means for failover is that if all the nodes that own a piece of data go down, that data
is lost forever.  By default, Keycloak only specifies one owner for data.  So if that one node goes down
that data is lost.  This usually means that users will be logged out and will have to login again.</p>
</div>
<div class="paragraph">
<p>You can change the number of nodes that replicate a piece of data by change the <code>owners</code> attribute in the <code>distributed-cache</code> declaration.</p>
</div>
<div class="listingblock">
<div class="title">owners</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;ve changed it so at least two nodes will replicate one specific user login session.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The number of owners recommended is really dependent on your deployment.  If you do not care if users are logged
      out when a node goes down, then one owner is good enough and you will avoid replication.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is generally wise to configure your environment to use loadbalancer with sticky sessions. It is beneficial for performance
     as Keycloak server, where the particular request is served, will be usually the owner of the data from the distributed cache
     and will therefore be able to look up the data locally. See <a href="#sticky-sessions">Sticky sessions</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="disabling-caching"><a class="anchor" href="#disabling-caching"></a>Disabling caching</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/cache/disable.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/cache/disable.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can disable the realm or user cache.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>standalone.xml</code>, <code>standalone-ha.xml</code>,  or <code>domain.xml</code> file in your distribution.</p>
<div class="paragraph">
<p>The location of this file depends on your <a href="#_operating-mode">operating mode</a>.
Here is a sample config file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">userCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>

    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realmCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Set the <code>enabled</code> attribute to false for the cache you want to disable.</p>
</li>
<li>
<p>Reboot your server for this change to take effect.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="clearing-cache-at-runtime"><a class="anchor" href="#clearing-cache-at-runtime"></a>Clearing cache at runtime</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/cache/clear.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/cache/clear.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can clear the realm cache, user cache, or the external public keys.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log into the Admin Console.</p>
</li>
<li>
<p>Click <strong>Realm Settings</strong>.</p>
</li>
<li>
<p>Click the <strong>Cache</strong> tab.</p>
</li>
<li>
<p>Clear the realm cache, the user cache or cache of external public keys.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cache will be cleared for all realms!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operator"><a class="anchor" href="#_operator"></a>Keycloak Operator</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Keycloak Operator is <strong>Technology Preview</strong> and is not fully supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Keycloak Operator automates Keycloak administration in
Kubernetes or
Openshift. You use this Operator to create custom resources (CRs), which automate administrative tasks. For example, instead of creating a client or a user in the Keycloak admin console, you can create custom resources to perform those tasks. A custom resource is a YAML file that defines the parameters for the administrative task.</p>
</div>
<div class="paragraph">
<p>You can create custom resources to perform the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_keycloak_cr">Install Keycloak</a></p>
</li>
<li>
<p><a href="#_realm-cr">Create realms</a></p>
</li>
<li>
<p><a href="#_client-cr">Create clients</a></p>
</li>
<li>
<p><a href="#_user-cr">Create users</a></p>
</li>
<li>
<p><a href="#_external_database">Connect to an external database</a></p>
</li>
<li>
<p><a href="#_backup-cr">Schedule database backups</a></p>
</li>
<li>
<p><a href="#_operator-extensions">Install extensions and themes</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
After you create custom resources for realms, clients, and users, you can manage them by using the Keycloak admin console or as custom resources using the <code>kubectl</code> command.  However, you cannot use both methods, because the Operator performs a one way sync for custom resources that you modify.  For example, if you modify a realm custom resource, the changes show up in the admin console. However, if you modify the realm using the admin console, those changes have no effect on the custom resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Begin using the Operator by <a href="#_installing-operator">Installing the Keycloak Operator on a cluster</a>.</p>
</div>
<div class="sect2">
<h3 id="_installing-operator"><a class="anchor" href="#_installing-operator"></a>Installing the Keycloak Operator on a cluster</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/installation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/installation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To install the Keycloak Operator, you can use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_install_by_olm">The Operator Lifecycle Manager (OLM)</a></p>
</li>
<li>
<p><a href="#_install_by_command">Command line installation</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_install_by_olm"><a class="anchor" href="#_install_by_olm"></a>Installing using the Operator Lifecycle Manager</h4>
<div class="paragraph">
<p>You can install the Operator on an <a href="#_openshift-olm">OpenShift</a> or <a href="#_kubernetes-olm">Kubernetes</a> cluster.</p>
</div>
<div class="sect4">
<h5 id="_openshift-olm"><a class="anchor" href="#_openshift-olm"></a>Installation on an OpenShift cluster</h5>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform this procedure on an OpenShift cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the OpenShift Container Platform web console.</p>
</li>
<li>
<p>In the left column, click <code>Operators, OperatorHub</code>.</p>
</li>
<li>
<p>Search for Keycloak Operator.</p>
<div class="paragraph">
<div class="title">OperatorHub tab in OpenShift</div>
<p><span class="image"><img src="./keycloak-images/operator-openshift-operatorhub.png" alt="operator openshift operatorhub"></span></p>
</div>
</li>
<li>
<p>Click the Keycloak Operator icon.</p>
<div class="paragraph">
<p>An Install page opens.</p>
</div>
<div class="paragraph">
<div class="title">Operator Install page on OpenShift</div>
<p><span class="image"><img src="./keycloak-images/operator-olm-installation.png" alt="operator olm installation"></span></p>
</div>
</li>
<li>
<p>Click <code>Install</code>.</p>
</li>
<li>
<p>Select a namespace and click Subscribe.</p>
<div class="paragraph">
<div class="title">Namespace selection in OpenShift</div>
<p><span class="image"><img src="./images/installed-namespace.png" alt="installed namespace"></span></p>
</div>
<div class="paragraph">
<p>The Operator starts installing.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>When the Operator installation completes, you are ready to create your first custom resource. See <a href="#_keycloak_cr">Keycloak installation using a custom resource</a>.
However, if you want to start tracking all Operator activities before creating custom resources, see the <a href="#_monitoring-operator">Application Monitoring Operator</a>.</p>
</li>
<li>
<p>For more information on OpenShift Operators, see the <a href="https://docs.openshift.com/container-platform/4.4/operators/olm-what-operators-are.html">OpenShift Operators guide</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_kubernetes-olm"><a class="anchor" href="#_kubernetes-olm"></a>Installation on a Kubernetes cluster</h5>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>For a Kubernetes cluster, perform these steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to <a href="https://operatorhub.io/operator/keycloak-operator">Keycloak Operator on OperatorHub.io</a>.</p>
</li>
<li>
<p>Click <code>Install</code>.</p>
</li>
<li>
<p>Follow the instructions on the screen.</p>
<div class="paragraph">
<div class="title">Operator Install page on Kubernetes</div>
<p><span class="image"><img src="./keycloak-images/operator-operatorhub-install.png" alt="operator operatorhub install"></span></p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>When the Operator installation completes, you are ready to create your first custom resource. See <a href="#_keycloak_cr">Keycloak installation using a custom resource</a>. However, if you want to start tracking all Operator activities before creating custom resources, see the <a href="#_monitoring-operator">Application Monitoring Operator</a>.</p>
</li>
<li>
<p>For more information on a Kubernetes installation, see <a href="https://operatorhub.io/how-to-install-an-operator">How to install an Operator from OperatorHub.io</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_by_command"><a class="anchor" href="#_install_by_command"></a>Installing from the command line</h4>
<div class="paragraph">
<p>You can install the Keycloak Operator from the command line.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the software to install from this location: <a href="https://github.com/keycloak/keycloak-operator">Github repo</a>.</p>
</li>
<li>
<p>Install all required custom resource definitions:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f deploy/crds/</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new namespace (or reuse an existing one) such as the namespace <code>myproject</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl create namespace myproject</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy a role, role binding, and service account for the Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f deploy/role.yaml -n myproject
$ kubectl apply -f deploy/role_binding.yaml -n myproject
$ kubectl apply -f deploy/service_account.yaml -n myproject</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f deploy/operator.yaml -n myproject</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the Operator is running:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get deployment keycloak-operator -n myproject
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
keycloak-operator   1/1     1            1           41s</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>When the Operator installation completes, you are ready to create your first custom resource. See <a href="#_keycloak_cr">Keycloak installation using a custom resource</a>.
However, if you want to start tracking all Operator activities before creating custom resources, see the <a href="#_monitoring-operator">Application Monitoring Operator</a>.</p>
</li>
<li>
<p>For more information on a Kubernetes installation, see <a href="https://operatorhub.io/how-to-install-an-operator">How to install an Operator from OperatorHub.io</a>.</p>
</li>
<li>
<p>For more information on OpenShift Operators, see the <a href="https://docs.openshift.com/container-platform/4.4/operators/olm-what-operators-are.html">OpenShift Operators guide</a>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operator_production_usage"><a class="anchor" href="#_operator_production_usage"></a>Using the Keycloak Operator in production environment</h3>
<div class="ulist">
<ul>
<li>
<p>The usage of embedded DB is not supported in a production environment.</p>
</li>
<li>
<p>Backup CRD is deprecated and not supported in a production environment.</p>
</li>
<li>
<p>We fully support using the rest of the CRDs in production, despite the <code>v1alpha1</code> version. We do not plan to make any breaking changes in this CRDs version.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring-operator"><a class="anchor" href="#_monitoring-operator"></a>The Application Monitoring Operator</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/monitoring-stack.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/monitoring-stack.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Before using the Operator to install Keycloak or create components, we recommend that you install the Application Monitoring Operator, which tracks Operator activity. To view metrics for the Operator, you can use the Grafana Dashboard and Prometheus Alerts from the Application Monitoring Operator. For example, you can view metrics such as the number of controller runtime reconciliation loops, the reconcile loop time, and errors.</p>
</div>
<div class="paragraph">
<p>The Keycloak Operator integration with the Application Monitoring Operator requires no action. You only need to install the Application Monitoring Operator in the cluster.</p>
</div>
<div class="sect3">
<h4 id="installing-the-application-monitoring-operator"><a class="anchor" href="#installing-the-application-monitoring-operator"></a>Installing the Application Monitoring Operator</h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Keycloak Operator is installed.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the Application Monitoring Operator by using the <a href="https://github.com/integr8ly/application-monitoring-operator#installation">documentation</a>.</p>
</li>
<li>
<p>Annotate the namespace used for the Keycloak Operator installation. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl label namespace &lt;namespace&gt; monitoring-key=middleware</code></pre>
</div>
</div>
</li>
<li>
<p>Log into the OpenShift web console.</p>
</li>
<li>
<p>Confirm monitoring is working by searching for Prometheus and Grafana route in the <code>application-monitoring</code> namespace.</p>
<div class="paragraph">
<div class="title">Routes in OpenShift web console</div>
<p><span class="image"><img src="./keycloak-images/operator-application-monitoring-routes.png" alt="operator application monitoring routes"></span></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="viewing-operator-metrics"><a class="anchor" href="#viewing-operator-metrics"></a>Viewing Operator Metrics</h4>
<div class="paragraph">
<p>Grafana and Promotheus each provide graphical information about Operator activities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Operator installs a pre-defined Grafana Dashboard as shown here:</p>
<div class="paragraph">
<div class="title">Grafana Dashboard</div>
<p><span class="image"><img src="./keycloak-images/operator-graphana-dashboard.png" alt="operator graphana dashboard"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you make customizations, we recommend that you clone the Grafana Dashboard so that your changes are not overwritten during an upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>The Operator installs a set of pre-defined Prometheus Alerts as shown here:</p>
<div class="paragraph">
<div class="title">Prometheus Alerts</div>
<p><span class="image"><img src="./keycloak-images/operator-prometheus-alerts.png" alt="operator prometheus alerts"></span></p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>For more information, see <a href="https://docs.openshift.com/container-platform/latest/monitoring/cluster_monitoring/prometheus-alertmanager-and-grafana.html">Accessing Prometheus, Alertmanager, and Grafana</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_keycloak_cr"><a class="anchor" href="#_keycloak_cr"></a>Installing Keycloak using a custom resource</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/keycloak-cr.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/keycloak-cr.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the Operator to automate the installation of Keycloak by creating a Keycloak custom resource. When you use a custom resource to install Keycloak, you create the components and services that are described here and illustrated in the graphic that follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>keycloak-db-secret</code> - Stores properties such as the database username, password, and external address (if you connect to an external database)</p>
</li>
<li>
<p><code>credentials-&lt;CR-Name&gt;</code> - Admin username and password to log into the Keycloak admin console (the <code>&lt;CR-Name&gt;</code> is based on the <code>Keycloak</code> custom resource name)</p>
</li>
<li>
<p><code>keycloak</code> - Keycloak deployment specification that is implemented as a StatefulSet with high availability support</p>
</li>
<li>
<p><code>keycloak-postgresql</code> - Starts a PostgreSQL database installation</p>
</li>
<li>
<p><code>keycloak-discovery</code> Service - Performs <code>JDBC_PING</code> discovery</p>
</li>
<li>
<p><code>keycloak</code> Service - Connects to Keycloak through HTTPS (HTTP is not supported)</p>
</li>
<li>
<p><code>keycloak-postgresql</code> Service - Connects an internal and external, if used, database instance</p>
</li>
<li>
<p><code>keycloak</code> Route - The URL for accessing the Keycloak admin console from OpenShift</p>
</li>
<li>
<p><code>keycloak</code> Ingress - The URL for accessing the Keycloak admin console from Kubernetes</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">How Operator components and services interact</div>
<p><span class="image"><img src="./keycloak-images/operator-components.png" alt="operator components"></span></p>
</div>
<div class="sect3">
<h4 id="the-keycloak-custom-resource"><a class="anchor" href="#the-keycloak-custom-resource"></a>The Keycloak custom resource</h4>
<div class="paragraph">
<p>The Keycloak custom resource is a YAML file that defines the parameters for installation.  This file contains three properties.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>instances</code> - controls the number of instances running in high availability mode.</p>
</li>
<li>
<p><code>externalAccess</code> - if the <code>enabled</code> is <code>True</code>, the Operator creates a route for OpenShift
or an Ingress for Kubernetes
for the Keycloak cluster. You can set <code>host</code> to override the automatically chosen host name for Route
or default value <code>keycloak.local</code> set for Ingress.</p>
</li>
<li>
<p><code>externalDatabase</code> - in order to connect to an externally hosted database. That topic is covered in the <a href="#_external_database">external database</a> section of this guide. Setting it to false should be used only for testing purposes and will install an embedded PostgreSQL database. Be aware that externalDatabase:false is <strong>NOT</strong> supported in production environments.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a Keycloak custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Keycloak</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">labels</span>:
   <span class="key">app</span>: <span class="string"><span class="content">example-keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">instances</span>: <span class="string"><span class="content">1</span></span>
  <span class="key">externalAccess</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can update the YAML file and the changes appear in the Keycloak admin console, however changes to the admin console do not update the custom resource.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-keycloak-custom-resource-on-openshift"><a class="anchor" href="#creating-a-keycloak-custom-resource-on-openshift"></a>Creating a Keycloak custom resource on OpenShift</h4>
<div class="paragraph">
<p>On OpenShift, you use the custom resource to create a route, which is the URL of the admin console, and find the secret, which holds the username and password for the admin console.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
<li>
<p>If you want to start tracking all Operator activities now, install the monitoring application before you create this custom resource. See <a href="#_monitoring-operator">The Application Monitoring Operator</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a route using your YAML file: <code>kubectl apply -f &lt;filename&gt;.yaml -n &lt;namespace&gt;</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f keycloak.yaml -n keycloak
keycloak.keycloak.org/example-keycloak created</code></pre>
</div>
</div>
<div class="paragraph">
<p>A route is created in OpenShift.</p>
</div>
</li>
<li>
<p>Log into the OpenShift web console.</p>
</li>
<li>
<p>Select <code>Networking</code>, <code>Routes</code> and search for Keycloak.</p>
<div class="paragraph">
<div class="title">Routes screen in OpenShift web console</div>
<p><span class="image"><img src="./images/route-ocp.png" alt="route ocp"></span></p>
</div>
</li>
<li>
<p>On the screen with the Keycloak route, click the URL under <code>Location</code>.</p>
<div class="paragraph">
<p>The Keycloak admin console login screen appears.</p>
</div>
<div class="paragraph">
<div class="title">Admin console login screen</div>
<p><span class="image"><img src="./images/login-empty.png" alt="login empty"></span></p>
</div>
</li>
<li>
<p>Locate the username and password for the admin console in the OpenShift web console; under <code>Workloads</code>, click <code>Secrets</code> and search for Keycloak.</p>
<div class="paragraph">
<div class="title">Secrets screen in OpenShift web console</div>
<p><span class="image"><img src="./images/secrets-ocp.png" alt="secrets ocp"></span></p>
</div>
</li>
<li>
<p>Enter the username and password into the admin console login screen.</p>
<div class="paragraph">
<div class="title">Admin console login screen</div>
<p><span class="image"><img src="./images/login-complete.png" alt="login complete"></span></p>
</div>
<div class="paragraph">
<p>You are now logged into an instance of Keycloak that was installed by a Keycloak custom resource. You are ready to create custom resources for realms, clients, and users.</p>
</div>
<div class="paragraph">
<div class="title">Keycloak master realm</div>
<p><span class="image"><img src="./images/new_install_cr.png" alt="new install cr"></span></p>
</div>
</li>
<li>
<p>Check the status of the custom resource:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl describe keycloak &lt;CR-name&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-keycloak-custom-resource-on-kubernetes"><a class="anchor" href="#creating-a-keycloak-custom-resource-on-kubernetes"></a>Creating a Keycloak custom resource on Kubernetes</h4>
<div class="paragraph">
<p>On Kubernetes, you use the custom resource to create an ingress, which is the IP address of the admin console, and find the secret, which holds the username and password for that console.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the ingress using your YAML file. <code>kubectl apply -f &lt;filename&gt;.yaml -n &lt;namespace&gt;</code>.  For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f keycloak.yaml -n keycloak
keycloak.keycloak.org/example-keycloak created</code></pre>
</div>
</div>
</li>
<li>
<p>Find the ingress: <code>kubectl get ingress -n &lt;CR-name&gt;</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get ingress -n example-keycloak
NAME       HOSTS                 ADDRESS     PORTS   AGE
keycloak   keycloak.redhat.com   192.0.2.0   80      3m</code></pre>
</div>
</div>
</li>
<li>
<p>Copy and paste the ADDRESS (the ingress) into a web browser.</p>
<div class="paragraph">
<p>The Keycloak admin console login screen appears.</p>
</div>
<div class="paragraph">
<div class="title">Admin console login screen</div>
<p><span class="image"><img src="./images/login-empty.png" alt="login empty"></span></p>
</div>
</li>
<li>
<p>Locate the username and password.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get secret credential-&lt;CR-Name&gt; -o go-template='{{range $k,$v := .data}}{{printf &quot;%s: &quot; $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{&quot;\n&quot;}}{{end}}'</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the username and password in the admin console login screen.</p>
<div class="paragraph">
<div class="title">Admin console login screen</div>
<p><span class="image"><img src="./images/login-complete.png" alt="login complete"></span></p>
</div>
<div class="paragraph">
<p>You are now logged into an instance of Keycloak that was installed by a Keycloak custom resource.  You are ready to create custom resources for realms, clients, and users.</p>
</div>
<div class="paragraph">
<div class="title">Admin console master realm</div>
<p><span class="image"><img src="./images/new_install_cr.png" alt="new install cr"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Results</div>
<p>After the Operator processes the custom resource, view the status with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl describe keycloak &lt;CR-name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Keycloak custom resource Status</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">Name</span>:         <span class="string"><span class="content">example-keycloak</span></span>
<span class="key">Namespace</span>:    <span class="string"><span class="content">keycloak</span></span>
<span class="key">Labels</span>:       <span class="string"><span class="content">app=example-keycloak</span></span>
<span class="key">Annotations</span>:  <span class="string"><span class="content">&lt;none&gt;</span></span>
<span class="key">API Version</span>:  <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">Kind</span>:         <span class="string"><span class="content">Keycloak</span></span>
<span class="key">Spec</span>:
  <span class="key">External Access</span>:
    <span class="key">Enabled</span>:  <span class="string"><span class="content">true</span></span>
  <span class="key">Instances</span>:  <span class="string"><span class="content">1</span></span>
<span class="key">Status</span>:
  <span class="key">Credential Secret</span>:  <span class="string"><span class="content">credential-example-keycloak</span></span>
  <span class="key">Internal URL</span>:       <span class="string"><span class="content">https://&lt;External URL to the deployed instance&gt;</span></span>
  <span class="key">Message</span>:
  <span class="key">Phase</span>:              <span class="string"><span class="content">reconciling</span></span>
  <span class="key">Ready</span>:              <span class="string"><span class="content">true</span></span>
  <span class="key">Secondary Resources</span>:
    <span class="key">Deployment</span>:
      <span class="error">keycloak-postgresql</span>
    <span class="key">Persistent Volume Claim</span>:
      <span class="error">keycloak-postgresql-claim</span>
    <span class="key">Prometheus Rule</span>:
      <span class="error">keycloak</span>
    <span class="key">Route</span>:
      <span class="error">keycloak</span>
    <span class="key">Secret</span>:
      <span class="error">credential-example-keycloak</span>
      <span class="error">keycloak-db-secret</span>
    <span class="key">Service</span>:
      <span class="error">keycloak-postgresql</span>
      <span class="error">keycloak</span>
      <span class="error">keycloak-discovery</span>
    <span class="key">Service Monitor</span>:
      <span class="error">keycloak</span>
    <span class="key">Stateful Set</span>:
      <span class="error">keycloak</span>
  <span class="key">Version</span>:
<span class="key">Events</span>:</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>Once the installation of Keycloak completes, you are ready to <a href="#_realm-cr">create a realm custom resource</a>.</p>
</li>
<li>
<p>An external database is the supported option and needs to be enabled in the Keycloak custom resource. You can disable this option only for testing and enable it when you switch to a production environment. See <a href="#_external_database">Connecting to an external database</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_realm-cr"><a class="anchor" href="#_realm-cr"></a>Creating a realm custom resource</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/keycloak-realm-cr.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/keycloak-realm-cr.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the Operator to create realms in Keycloak as defined by a custom resource. You define the properties of the realm custom resource in a YAML file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can only create or delete realms by creating or deleting the YAML file, and changes appear in the Keycloak admin console. However changes to the admin console are not reflected back and updates of the CR after the realm is created are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a <code>Realm</code> custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakRealm</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">test</span></span>
  <span class="key">labels</span>:
    <span class="key">app</span>: <span class="string"><span class="content">example-keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">realm</span>:
    <span class="key">id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">basic</span><span class="delimiter">&quot;</span></span>
    <span class="key">realm</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">basic</span><span class="delimiter">&quot;</span></span>
    <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span>
    <span class="key">displayName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic Realm</span><span class="delimiter">&quot;</span></span>
  <span class="key">instanceSelector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="content">example-keycloak</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.</p>
</li>
<li>
<p>In the YAML file,  the <code>app</code> under <code>instanceSelector</code> matches the label of a Keycloak custom resource. Matching these values ensures that you create the realm in the right instance of Keycloak.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use this command on the YAML file that you created: <code>kubectl apply -f &lt;realm-name&gt;.yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f initial_realm.yaml
keycloak.keycloak.org/test created</code></pre>
</div>
</div>
</li>
<li>
<p>Log into the admin console for the related instance of Keycloak.</p>
</li>
<li>
<p>Click Select Realm and locate the realm that you created.</p>
<div class="paragraph">
<p>The new realm opens.</p>
</div>
<div class="paragraph">
<div class="title">Admin console master realm</div>
<p><span class="image"><img src="./images/test-realm-cr.png" alt="test realm cr"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Results</div>
<p>After the Operator processes the custom resource, view the status with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl describe keycloak &lt;CR-name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Realm custom resource status</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">Name</span>:         <span class="string"><span class="content">example-keycloakrealm</span></span>
<span class="key">Namespace</span>:    <span class="string"><span class="content">keycloak</span></span>
<span class="key">Labels</span>:       <span class="string"><span class="content">app=example-keycloak</span></span>
<span class="key">Annotations</span>:  <span class="string"><span class="content">&lt;none&gt;</span></span>
<span class="key">API Version</span>:  <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">Kind</span>:         <span class="string"><span class="content">KeycloakRealm</span></span>
<span class="key">Metadata</span>:
  <span class="key">Creation Timestamp</span>:  <span class="string"><span class="content">2019-12-03T09:46:02Z</span></span>
  <span class="key">Finalizers</span>:
    <span class="error">realm.cleanup</span>
  <span class="key">Generation</span>:        <span class="string"><span class="content">1</span></span>
  <span class="key">Resource Version</span>:  <span class="string"><span class="content">804596</span></span>
  <span class="key">Self Link</span>:         <span class="string"><span class="content">/apis/keycloak.org/v1alpha1/namespaces/keycloak/keycloakrealms/example-keycloakrealm</span></span>
  <span class="key">UID</span>:               <span class="string"><span class="content">b7b2f883-15b1-11ea-91e6-02cb885627a6</span></span>
<span class="key">Spec</span>:
  <span class="key">Instance Selector</span>:
    <span class="key">Match Labels</span>:
      <span class="key">App</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">Realm</span>:
    <span class="key">Display Name</span>:  <span class="string"><span class="content">Basic Realm</span></span>
    <span class="key">Enabled</span>:       <span class="string"><span class="content">true</span></span>
    <span class="key">Id</span>:            <span class="string"><span class="content">basic</span></span>
    <span class="key">Realm</span>:         <span class="string"><span class="content">basic</span></span>
<span class="key">Status</span>:
  <span class="key">Login URL</span>:
  <span class="key">Message</span>:
  <span class="key">Phase</span>:      <span class="string"><span class="content">reconciling</span></span>
  <span class="key">Ready</span>:      <span class="string"><span class="content">true</span></span>
<span class="key">Events</span>:       <span class="string"><span class="content">&lt;none&gt;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional resources</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the realm creation completes, you are ready to <a href="#_client-cr">create a client custom resource</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_client-cr"><a class="anchor" href="#_client-cr"></a>Creating a client custom resource</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/keycloak-client-cr.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/keycloak-client-cr.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the Operator to create clients in Keycloak as defined by a custom resource.  You define the properties of the realm in a YAML file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can update the YAML file and changes appear in the Keycloak admin console, however changes to the admin console do not update the custom resource.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a Client custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakClient</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-client</span></span>
  <span class="key">labels</span>:
    <span class="key">app</span>: <span class="string"><span class="content">app=example-keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">realmSelector</span>:
     <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="content">&lt;matching labels for KeycloakRealm custom resource&gt;</span></span>
  <span class="key">client</span>:
    <span class="comment"># auto-generated if not supplied</span>
    <span class="comment">#id: 123</span>
    <span class="key">clientId</span>: <span class="string"><span class="content">client-secret</span></span>
    <span class="key">secret</span>: <span class="string"><span class="content">client-secret</span></span>
    <span class="comment"># ...</span>
    <span class="comment"># other properties of Keycloak Client</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use this command on the YAML file that you created: <code>kubectl apply -f &lt;client-name&gt;.yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f initial_client.yaml
keycloak.keycloak.org/example-client created</code></pre>
</div>
</div>
</li>
<li>
<p>Log into the Keycloak admin console for the related instance of Keycloak.</p>
</li>
<li>
<p>Click Clients.</p>
<div class="paragraph">
<p>The new client appears in the list of clients.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/clients.png" alt="clients"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Results</div>
<p>After a client is created, the Operator creates a Secret containing the <code>Client ID</code> and the client&#8217;s secret using the following naming pattern: <code>keycloak-client-secret-&lt;custom resource name&gt;</code>. For example:</p>
</div>
<div class="listingblock">
<div class="title">Client&#8217;s Secret</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">data</span>:
  <span class="key">CLIENT_ID</span>: <span class="string"><span class="content">&lt;base64 encoded Client ID&gt;</span></span>
  <span class="key">CLIENT_SECRET</span>: <span class="string"><span class="content">&lt;base64 encoded Client Secret&gt;</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the Operator processes the custom resource, view the status with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl describe keycloak &lt;CR-name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Client custom resource Status</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">Name</span>:         <span class="string"><span class="content">client-secret</span></span>
<span class="key">Namespace</span>:    <span class="string"><span class="content">keycloak</span></span>
<span class="key">Labels</span>:       <span class="string"><span class="content">app=example-keycloak</span></span>
<span class="key">API Version</span>:  <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">Kind</span>:         <span class="string"><span class="content">KeycloakClient</span></span>
<span class="key">Spec</span>:
  <span class="key">Client</span>:
    <span class="key">Client Authenticator Type</span>:     <span class="string"><span class="content">client-secret</span></span>
    <span class="key">Client Id</span>:                     <span class="string"><span class="content">client-secret</span></span>
    <span class="key">Id</span>:                            <span class="string"><span class="content">keycloak-client-secret</span></span>
  <span class="key">Realm Selector</span>:
    <span class="key">Match Labels</span>:
      <span class="key">App</span>:  <span class="string"><span class="content">keycloak</span></span>
<span class="key">Status</span>:
  <span class="key">Message</span>:
  <span class="key">Phase</span>:    <span class="string"><span class="content">reconciling</span></span>
  <span class="key">Ready</span>:    <span class="string"><span class="content">true</span></span>
  <span class="key">Secondary Resources</span>:
    <span class="key">Secret</span>:
      <span class="error">keycloak-client-secret-client-secret</span>
<span class="key">Events</span>:  <span class="string"><span class="content">&lt;none&gt;</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>When the client creation completes, you are ready to <a href="#_user-cr">create a user custom resource</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_user-cr"><a class="anchor" href="#_user-cr"></a>Creating a user custom resource</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/keycloak-user-cr.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/keycloak-user-cr.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the Operator to create users in Keycloak as defined by a custom resource. You define the properties of the user custom resource in a YAML file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can update properties, except for the password, in the YAML file and changes appear in the Keycloak admin console, however changes to the admin console do not update the custom resource.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a user custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakUser</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-user</span></span>
<span class="key">spec</span>:
  <span class="key">user</span>:
    <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">realm_user</span><span class="delimiter">&quot;</span></span>
    <span class="key">firstName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>
    <span class="key">lastName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>
    <span class="key">email</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user@example.com</span><span class="delimiter">&quot;</span></span>
    <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span>
    <span class="key">emailVerified</span>: <span class="string"><span class="content">False</span></span>
    <span class="key">credentials</span>:
      - <span class="string"><span class="content">type: &quot;password&quot;</span></span>
        <span class="key">value</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">12345</span><span class="delimiter">&quot;</span></span>
    <span class="key">realmRoles</span>:
      - <span class="string"><span class="delimiter">&quot;</span><span class="content">offline_access</span><span class="delimiter">&quot;</span></span>
    <span class="key">clientRoles</span>:
      <span class="key">account</span>:
        - <span class="string"><span class="delimiter">&quot;</span><span class="content">manage-account</span><span class="delimiter">&quot;</span></span>
      <span class="key">realm-management</span>:
        - <span class="string"><span class="delimiter">&quot;</span><span class="content">manage-users</span><span class="delimiter">&quot;</span></span>
  <span class="key">realmSelector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="content">example-keycloak</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.</p>
</li>
<li>
<p>The <code>realmSelector</code> matches the labels of an existing realm custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use this command on the YAML file that you created: <code>kubectl apply -f &lt;user_cr&gt;.yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f initial_user.yaml
keycloak.keycloak.org/example-user created</code></pre>
</div>
</div>
</li>
<li>
<p>Log into the admin console for the related instance of Keycloak.</p>
</li>
<li>
<p>Click Users.</p>
</li>
<li>
<p>Search for the user that you defined in the YAML file.</p>
<div class="paragraph">
<p>You may need to switch to a different realm to find the user.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/realm_user.png" alt="realm user"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Results</div>
<p>After a user is created, the Operator creates a Secret using the
following naming pattern: <code>credential-&lt;realm name&gt;-&lt;username&gt;-&lt;namespace&gt;</code>, containing the username and, if it has been specified in the CR <code>credentials</code> attribute, the password.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="title"><code>KeycloakUser</code> Secret</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">data</span>:
  <span class="key">password</span>: <span class="string"><span class="content">&lt;base64 encoded password&gt;</span></span>
  <span class="key">username</span>: <span class="string"><span class="content">&lt;base64 encoded username&gt;</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Operator processes the custom resource, view the status with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl describe keycloak &lt;CR-name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">User custom resource Status</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">Name</span>:         <span class="string"><span class="content">example-realm-user</span></span>
<span class="key">Namespace</span>:    <span class="string"><span class="content">keycloak</span></span>
<span class="key">Labels</span>:       <span class="string"><span class="content">app=example-keycloak</span></span>
<span class="key">API Version</span>:  <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">Kind</span>:         <span class="string"><span class="content">KeycloakUser</span></span>
<span class="key">Spec</span>:
  <span class="key">Realm Selector</span>:
    <span class="key">Match Labels</span>:
      <span class="key">App</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">User</span>:
    <span class="key">Email</span>:           <span class="string"><span class="content">realm_user@redhat.com</span></span>
    <span class="key">Credentials</span>:
      <span class="key">Type</span>:          <span class="string"><span class="content">password</span></span>
      <span class="key">Value</span>:         <span class="string"><span class="content">&lt;user password&gt;</span></span>
    <span class="key">Email Verified</span>:  <span class="string"><span class="content">false</span></span>
    <span class="key">Enabled</span>:         <span class="string"><span class="content">true</span></span>
    <span class="key">First Name</span>:      <span class="string"><span class="content">John</span></span>
    <span class="key">Last Name</span>:       <span class="string"><span class="content">Doe</span></span>
    <span class="key">Username</span>:        <span class="string"><span class="content">realm_user</span></span>
<span class="key">Status</span>:
  <span class="key">Message</span>:
  <span class="key">Phase</span>:    <span class="string"><span class="content">reconciled</span></span>
<span class="key">Events</span>:     <span class="string"><span class="content">&lt;none&gt;</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>If you have an external database, you can modify the Keycloak custom resource to support it. See <a href="#_external_database">Connecting to an external database</a>.</p>
</li>
<li>
<p>To back up your database using custom resources, see <a href="#_backup-cr">schedule database backups</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_database"><a class="anchor" href="#_external_database"></a>Connecting to an external database</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/external-database.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/external-database.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the Operator to connect to an external PostgreSQL database by creating a <code>keycloak-db-secret</code> YAML file and setting Keycloak CR externalDatabase property to enabled. Note that values are Base64 encoded.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>keycloak-db-secret</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span>
<span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">keycloak-db-secret</span></span>
    <span class="key">namespace</span>: <span class="string"><span class="content">keycloak</span></span>
<span class="key">stringData</span>:
    <span class="key">POSTGRES_DATABASE</span>: <span class="string"><span class="content">&lt;Database Name&gt;</span></span>
    <span class="key">POSTGRES_EXTERNAL_ADDRESS</span>: <span class="string"><span class="content">&lt;External Database IP or URL (resolvable by K8s)&gt;</span></span>
    <span class="key">POSTGRES_EXTERNAL_PORT</span>: <span class="string"><span class="content">&lt;External Database Port&gt;</span></span>
    <span class="key">POSTGRES_PASSWORD</span>: <span class="string"><span class="content">&lt;Database Password&gt;</span></span>
    <span class="comment"># Required for AWS Backup functionality</span>
    <span class="key">POSTGRES_SUPERUSER</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    <span class="key">POSTGRES_USERNAME</span>: <span class="string"><span class="content">&lt;Database Username&gt;</span></span>
    <span class="key">SSLMODE</span>: <span class="string"><span class="content">&lt;TLS configuration for the Database connection&gt;</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following properties set the hostname or IP address and port of the database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POSTGRES_EXTERNAL_ADDRESS</code> - an IP address or a hostname of the external database.
This address needs be resolvable in a Kubernetes cluster.</p>
</li>
<li>
<p><code>POSTGRES_EXTERNAL_PORT</code> - (Optional) A database port.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The other properties work in the same way for a hosted or external database. Set them as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POSTGRES_DATABASE</code> - Database name to be used.</p>
</li>
<li>
<p><code>POSTGRES_USERNAME</code> - Database username</p>
</li>
<li>
<p><code>POSTGRES_PASSWORD</code> - Database password</p>
</li>
<li>
<p><code>POSTGRES_SUPERUSER</code> - Indicates whether backups should run as super user. Typically <code>true</code>.</p>
</li>
<li>
<p><code>SSL_MODE</code> - Indicates whether to use TLS on the connection to the external PostgreSQL database. Check the possible <a href="https://www.postgresql.org/docs/current/libpq-ssl.html">values</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When <code>SSL_MODE</code> is enabled, the operator searches for a secret called <code>keycloak-db-ssl-cert-secret</code> containing the <code>root.crt</code> that has been used by the PostgreSQL database. Creating the secret is optional and the secret is used only when you want to verify the Database&#8217;s certificate (for example <code>SSLMODE: verify-ca</code>). Here is an example :</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>TLS Secret</code> to be used by the operator.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">keycloak-db-ssl-cert-secret</span></span>
  <span class="key">namespace</span>: <span class="string"><span class="content">keycloak</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span>
<span class="key">data</span>:
  <span class="key">root.crt</span>: <span class="string"><span class="content">{root.crt base64}</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Operator will create a Service named <code>keycloak-postgresql</code>. This Service is configured by the Operator to expose the external database based on the content of <code>POSTGRES_EXTERNAL_ADDRESS</code>. Keycloak uses this Service to connect to the Database, which means it does not connect to the Database directly but rather through this Service.</p>
</div>
<div class="paragraph">
<p>The Keycloak custom resource requires updates to enable external database support.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>Keycloak</code> custom resource that supports an external database</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Keycloak</span></span>
<span class="key">metadata</span>:
  <span class="key">labels</span>:
      <span class="key">app</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">namespace</span>: <span class="string"><span class="content">keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">externalDatabase</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">instances</span>: <span class="string"><span class="content">1</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for <code>keycloak-db-secret</code>.</p>
</li>
<li>
<p>You have modified the Keycloak custom resource to set <code>externalDatabase</code> to <code>true</code>.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Locate the secret for your PostgreSQL database: <code>kubectl get secret &lt;secret_for_db&gt; -o yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get secret keycloak-db-secret -o yaml
apiVersion: v1
data
  POSTGRES_DATABASE: cm9vdA==
  POSTGRES_EXTERNAL_ADDRESS: MTcyLjE3LjAuMw==
  POSTGRES_EXTERNAL_PORT: NTQzMg==</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>POSTGRES_EXTERNAL_ADDRESS</code> is in Base64 format.</p>
</div>
</li>
<li>
<p>Decode the value for the secret: <code>echo "&lt;encoded_secret&gt;" | base64 -decode</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ echo &quot;MTcyLjE3LjAuMw==&quot; | base64 -decode
192.0.2.3</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the decoded value matches the IP address for your database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get pods -o wide
NAME                        READY  STATUS    RESTARTS   AGE   IP
keycloak-0                  1/1    Running   0          13m   192.0.2.0
keycloak-postgresql-c8vv27m 1/1    Running   0          24m   192.0.2.3</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that <code>keycloak-postgresql</code> appears in a list of running services:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get svc
NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)   AGE
keycloak             ClusterIP  203.0.113.0    &lt;none&gt;       8443/TCP  27m
keycloak-discovery   ClusterIP  None           &lt;none&gt;       8080/TCP  27m
keycloak-postgresql  ClusterIP  203.0.113.1    &lt;none&gt;       5432/TCP  27m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>keycloak-postgresql</code> service sends requests to a set of IP addresses in the backend.  These IP addresses are called endpoints.</p>
</div>
</li>
<li>
<p>View the endpoints used by the <code>keycloak-postgresql</code> service to confirm that they use the IP addresses for your database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get endpoints keycloak-postgresql
NAME                  ENDPOINTS         AGE
keycloak-postgresql   192.0.2.3.5432    27m</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that Keycloak is running with the external database. This example shows that everything is running:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get pods
NAME                        READY  STATUS    RESTARTS   AGE   IP
keycloak-0                  1/1    Running   0          26m   192.0.2.0
keycloak-postgresql-c8vv27m 1/1    Running   0          36m   192.0.2.3</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional Resources</div>
<ul>
<li>
<p>To back up your database using custom resources, see <a href="#_backup-cr">Scheduling database backups</a>.</p>
</li>
<li>
<p>For more information on Base64 encoding, see the <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes Secrets manual</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_keycloak"><a class="anchor" href="#_external_keycloak"></a>Connecting to an external Keycloak</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/external-keycloak.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/external-keycloak.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This operator can also be used to partially manage an external Keycloak instance.
In it&#8217;s current state, it will only be able to create clients.</p>
</div>
<div class="paragraph">
<p>To do this, you&#8217;ll need to create unmanaged versions of the <code>Keycloak</code> and <code>KeycloakRealm</code> CRDs to use for targeting and configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>external-keycloak</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Keycloak</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">external-ref</span></span>
  <span class="key">labels</span>:
    <span class="key">app</span>: <span class="string"><span class="content">external-keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">unmanaged</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">external</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">https://some.external.url</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to authenticate against this keycloak, the operator infers the secret name from the CRD by prefixing the CRD name with <code>credential-</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>credential-external-ref</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">credential-external-ref</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span>
<span class="key">data</span>:
  <span class="key">ADMIN_USERNAME</span>: <span class="string"><span class="content">YWRtaW4=</span></span>
  <span class="key">ADMIN_PASSWORD</span>: <span class="string"><span class="content">cGFzcw==</span></span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example YAML file for <code>external-realm</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakRealm</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">external-realm</span></span>
  <span class="key">labels</span>:
    <span class="key">app</span>: <span class="string"><span class="content">external-keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">unmanaged</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">realm</span>:
    <span class="key">id</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">basic</span><span class="delimiter">&quot;</span></span>
    <span class="key">realm</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">basic</span><span class="delimiter">&quot;</span></span>
  <span class="key">instanceSelector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="content">external-keycloak</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now use the realm reference in your client as usual, and it will create the client on the external Keycloak instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_backup-cr"><a class="anchor" href="#_backup-cr"></a>Scheduling database backups</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/keycloak-backup-cr.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/keycloak-backup-cr.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Backup CR is <strong>deprecated</strong> and could be removed in future releases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use the Operator to schedule automatic backups of the database as defined by custom resources. The custom resource triggers a backup job
(or a <code>CronJob</code> in the case of Periodic Backups)
and reports back its status.</p>
</div>
<div class="paragraph">
<p>Two options exist to schedule backups:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_backups-cr-aws">Backing up to AWS S3 storage</a></p>
</li>
<li>
<p><a href="#_backups-local-cr">Backing up to local storage</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have AWS S3 storage, you can perform a one-time backup or periodic backups. If you do not have AWS S3 storage, you can back up to local storage.</p>
</div>
<div class="sect3">
<h4 id="_backups-cr-aws"><a class="anchor" href="#_backups-cr-aws"></a>Backing up to AWS S3 storage</h4>
<div class="paragraph">
<p>You can back up your database to AWS S3 storage one time or periodically. To back up your data periodically, enter a valid <code>CronJob</code> into the <code>schedule</code>.</p>
</div>
<div class="paragraph">
<p>For AWS S3 storage, you create a YAML file for the backup custom resource and a YAML file for the AWS secret. The backup custom resource requires a YAML file with the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakBackup</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">&lt;CR Name&gt;</span></span>
<span class="key">spec</span>:
  <span class="key">aws</span>:
    <span class="comment"># Optional - used only for Periodic Backups.</span>
    <span class="comment"># Follows usual crond syntax (for example, use &quot;0 1 * * *&quot; to perform the backup every day at 1 AM.)</span>
    <span class="key">schedule</span>: <span class="string"><span class="content">&lt;Cron Job Schedule&gt;</span></span>
    <span class="comment"># Required - the name of the secret containing the credentials to access the S3 storage</span>
    <span class="key">credentialsSecretName</span>: <span class="string"><span class="content">&lt;A Secret containing S3 credentials&gt;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The AWS secret requires a YAML file with the following structure:</p>
</div>
<div class="listingblock">
<div class="title">AWS S3 <code>Secret</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">&lt;Secret Name&gt;</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span>
<span class="key">stringData</span>:
  <span class="key">AWS_S3_BUCKET_NAME</span>: <span class="string"><span class="content">&lt;S3 Bucket Name&gt;</span></span>
  <span class="key">AWS_ACCESS_KEY_ID</span>: <span class="string"><span class="content">&lt;AWS Access Key ID&gt;</span></span>
  <span class="key">AWS_SECRET_ACCESS_KEY</span>: <span class="string"><span class="content">&lt;AWS Secret Key&gt;</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your Backup custom resource YAML file includes a <code>credentialsSecretName</code> that references a <code>Secret</code> containing AWS S3 credentials.</p>
</li>
<li>
<p>Your <code>KeycloakBackup</code> custom resource has <code>aws</code> sub-properties.</p>
</li>
<li>
<p>You have a YAML file for the AWS S3 Secret that includes a <code>&lt;Secret Name&gt;</code> that matches the one identified in the backup custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the secret with credentials: <code>kubectl apply -f &lt;secret_for_aws&gt;.yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f secret.yaml
keycloak.keycloak.org/aws_s3_secret created</code></pre>
</div>
</div>
</li>
<li>
<p>Create a backup job: <code>kubectl apply -f &lt;backup_crname&gt;.yaml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f aws_one-time-backup.yaml
keycloak.keycloak.org/aws_s3_backup created</code></pre>
</div>
</div>
</li>
<li>
<p>View a list of backup jobs:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get jobs
NAME                   COMPLETIONS     DURATION     AGE
aws_s3_backup    0/1             6s           6s</code></pre>
</div>
</div>
</li>
<li>
<p>View the list of executed backup jobs.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get pods
NAME                               READY    STATUS       RESTARTS    AGE
aws_s3_backup-5b4rfdd              0/1      Completed    0           24s
keycloak-0                         1/1      Running      0           52m
keycloak-postgresql-c824c6-vv27m   1/1      Running      0           71m</code></pre>
</div>
</div>
</li>
<li>
<p>View the log of your completed backup job:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl logs aws_s3_backup-5b4rf
==&gt; Component data dump completed
.
.
.
.
[source,bash,subs=+attributes]</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The status of the backup job also appears in the AWS console.</p>
</div>
</div>
<div class="sect3">
<h4 id="_backups-local-cr"><a class="anchor" href="#_backups-local-cr"></a>Backing up to Local Storage</h4>
<div class="paragraph">
<p>You can use Operator to create a backup job that performs a one-time backup to a local Persistent Volume.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a Backup custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KeycloakBackup</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">test-backup</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for this custom resource.
Be sure to omit the <code>aws</code> sub-properties from this file.</p>
</li>
<li>
<p>You have a <code>PersistentVolume</code> with a <code>claimRef</code> to reserve it only for a <code>PersistentVolumeClaim</code> created by the Keycloak Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a backup job: <code>kubectl apply -f &lt;backup_crname&gt;</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl apply -f one-time-backup.yaml
keycloak.keycloak.org/test-backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Operator creates a <code>PersistentVolumeClaim</code> with the following naming scheme:  <code>Keycloak-backup-&lt;CR-name&gt;</code>.</p>
</div>
</li>
<li>
<p>View a list of volumes:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get pvc
NAME                          STATUS   VOLUME
keycloak-backup-test-backup   Bound    pvc-e242-ew022d5-093q-3134n-41-adff
keycloak-postresql-claim      Bound    pvc-e242-vs29202-9bcd7-093q-31-zadj</code></pre>
</div>
</div>
</li>
<li>
<p>View a list of backup jobs:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get jobs
NAME           COMPLETIONS     DURATION     AGE
test-backup    0/1             6s           6s</code></pre>
</div>
</div>
</li>
<li>
<p>View the list of executed backup jobs:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get pods
NAME                               READY    STATUS       RESTARTS    AGE
test-backup-5b4rf                  0/1      Completed    0           24s
keycloak-0                         1/1      Running      0           52m
keycloak-postgresql-c824c6-vv27m   1/1      Running      0           71m</code></pre>
</div>
</div>
</li>
<li>
<p>View the log of your completed backup job:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl logs test-backup-5b4rf
==&gt; Component data dump completed
.
.
.
.</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more details on persistent volumes, see <a href="https://docs.openshift.com/container-platform/4.4/storage/understanding-persistent-storage.html">Understanding persistent storage</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operator-extensions"><a class="anchor" href="#_operator-extensions"></a>Installing extensions and themes</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/extensions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/extensions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the operator to install extensions and themes that you need for your company or organization. The extension or theme can be anything that Keycloak can consume. For example, you can add a metrics extension. You add the extension or theme to the Keycloak custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a Keycloak custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Keycloak</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">labels</span>:
   <span class="key">app</span>: <span class="string"><span class="content">keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">instances</span>: <span class="string"><span class="content">1</span></span>
  <span class="key">extensions</span>:
   - <span class="string"><span class="content">&lt;url_for_extension_or_theme&gt;</span></span>
  <span class="key">externalAccess</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can package and deploy themes in the same way as any other extensions. See <a href="https://www.keycloak.org/docs/latest/server_development/#deploying-themes">Deploying Themes</a> manual entry for more information.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a YAML file for the Keycloak custom resource.</p>
</li>
<li>
<p>You have cluster-admin permission or an equivalent level of permissions granted by an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the YAML file for the Keycloak custom resource: <code>kubectl edit &lt;CR-name&gt;</code></p>
</li>
<li>
<p>Add a line called <code>extensions:</code> after the <code>instances</code> line.</p>
</li>
<li>
<p>Add a URL to a JAR file for your custom extension or theme.</p>
</li>
<li>
<p>Save the file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Operator downloads the extension or theme and installs it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_command-options"><a class="anchor" href="#_command-options"></a>Command options for managing custom resources</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/command-options.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/command-options.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>After you create a custom request, you can edit it or delete using the <code>kubectl</code> command.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To edit a custom request, use this command: <code>kubectl edit &lt;CR-name&gt;</code></p>
</li>
<li>
<p>To delete a custom request, use this command: <code>kubectl delete &lt;CR-name&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to edit a realm custom request named <code>test-realm</code>, use this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl edit test-realm</code></pre>
</div>
</div>
<div class="paragraph">
<p>A window opens where you can make changes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can update the Keycloak CR YAML file and changes will be applied to the deployment.</p>
</div>
<div class="paragraph">
<p>Updates to the other resources are limited:</p>
</div>
<div class="paragraph">
<p>Keycloak Realm CR only supports basic creation and deletion without sync options.
Keycloak User and Client CRs support unidirectional updates (changes to the CR are reflected in Keycloak but changes done in Keycloak are not updated in the CR).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_operator-upgrade-strategy"><a class="anchor" href="#_operator-upgrade-strategy"></a>Upgrade strategy</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_installation/topics/operator/upgrading.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_installation/topics/operator/upgrading.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can configure how the operator performs Keycloak upgrades. You can choose from the following upgrade strategies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>recreate</code>: This is the default strategy. The operator removes all Keycloak replicas, optionally creates a backup
and then creates the replicas based on a newer Keycloak image. This strategy is suitable for major upgrades as
a single Keycloak version is accessing the underlying database. The downside is Keycloak needs to be shut
down during the upgrade.</p>
</li>
<li>
<p><code>rolling</code>: The operator removes one replica at a time and creates it again based on a newer Keycloak image. This
ensures a zero-downtime upgrade but is more suitable for minor version upgrades that do not require database migration
since the database is accessed by multiple Keycloak versions concurrently. Automatic backups are not supported
with this strategy.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example YAML file for a Keycloak custom resource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">keycloak.org/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Keycloak</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-keycloak</span></span>
  <span class="key">labels</span>:
   <span class="key">app</span>: <span class="string"><span class="content">keycloak</span></span>
<span class="key">spec</span>:
  <span class="key">instances</span>: <span class="string"><span class="content">2</span></span>
  <span class="key">migration</span>:
    <span class="key">strategy</span>: <span class="string"><span class="content">recreate</span></span>
    <span class="key">backups</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span>
  <span class="key">externalAccess</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">True</span></span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Additional Resources</div>
<ul>
<li>
<p>For more information on rolling updates, see the <a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#rolling-update">Updating StatefulSets manual</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Tracked as <a href="https://issues.redhat.com/browse/KEYCLOAK-3873" class="bare">https://issues.redhat.com/browse/KEYCLOAK-3873</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-02-01 16:31:30 CET
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>

<script>
    const oldtoc = document.getElementById('toctitle').nextElementSibling;
    const newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: 'h2, h3, h4',
        smoothScroll: false
    });
    const handleTocOnResize = function() {
        const width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false
            });
        }
        else {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                smoothScroll: false
            });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    handleTocOnResize();
</script>
</body>
</html>